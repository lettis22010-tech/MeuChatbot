"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PubsubClient = void 0;
const generated_types_1 = require("@gomomento/generated-types");
// older versions of node don't have the global util variables https://github.com/nodejs/node/issues/20365
const headers_interceptor_1 = require("./grpc/headers-interceptor");
const cache_service_error_mapper_1 = require("../errors/cache-service-error-mapper");
const grpc_js_1 = require("@grpc/grpc-js");
const package_json_1 = require("../../package.json");
const middlewares_interceptor_1 = require("./grpc/middlewares-interceptor");
const __1 = require("../");
const utils_1 = require("@gomomento/sdk-core/dist/src/internal/utils");
const AbstractPubsubClient_1 = require("@gomomento/sdk-core/dist/src/internal/clients/pubsub/AbstractPubsubClient");
const grpc_channel_options_1 = require("./grpc/grpc-channel-options");
const retry_interceptor_1 = require("./grpc/retry-interceptor");
const utils_2 = require("@gomomento/sdk-core/dist/src/utils");
var grpcPubsub = generated_types_1.pubsub.cache_client.pubsub;
class PubsubClient extends AbstractPubsubClient_1.AbstractPubsubClient {
    // private static readonly RST_STREAM_NO_ERROR_MESSAGE =
    //   'Received RST_STREAM with code 0';
    /**
     * @param {TopicClientProps} props
     */
    constructor(props) {
        super(props.configuration.getLoggerFactory(), props.configuration.getLoggerFactory().getLogger(PubsubClient.name), new cache_service_error_mapper_1.CacheServiceErrorMapper(props.configuration.getThrowOnErrors()));
        this.credentialProvider = props.credentialProvider;
        this.getLogger().debug(`Creating topic client using endpoint: '${this.credentialProvider.getCacheEndpoint()}'`);
        const topicGrpcConfig = props.configuration
            .getTransportStrategy()
            .getGrpcConfig();
        this.requestTimeoutMs =
            topicGrpcConfig.getDeadlineMillis() ||
                PubsubClient.DEFAULT_REQUEST_TIMEOUT_MS;
        // NOTE: This is hard-coded for now but we may want to expose it via TopicConfiguration in the
        // future, as we do with some of the other clients.
        const grpcConfig = new __1.StaticGrpcConfiguration({
            deadlineMillis: this.requestTimeoutMs,
            maxSessionMemoryMb: PubsubClient.DEFAULT_MAX_SESSION_MEMORY_MB,
            keepAlivePermitWithoutCalls: topicGrpcConfig.getKeepAlivePermitWithoutCalls(),
            keepAliveTimeMs: topicGrpcConfig.getKeepAliveTimeMS(),
            keepAliveTimeoutMs: topicGrpcConfig.getKeepAliveTimeoutMS(),
        });
        const channelOptions = (0, grpc_channel_options_1.grpcChannelOptionsFromGrpcConfig)(grpcConfig);
        this.getLogger().debug(`Creating pubsub client with channel options: ${JSON.stringify(channelOptions, null, 2)}`);
        this.client = new grpcPubsub.PubsubClient(this.credentialProvider.getCacheEndpoint(), this.credentialProvider.isCacheEndpointSecure()
            ? grpc_js_1.ChannelCredentials.createSsl()
            : grpc_js_1.ChannelCredentials.createInsecure(), channelOptions);
        const headers = [
            new headers_interceptor_1.Header('Authorization', this.credentialProvider.getAuthToken()),
            new headers_interceptor_1.Header('agent', `nodejs:topic:${package_json_1.version}`),
            new headers_interceptor_1.Header('runtime-version', `nodejs:${process.versions.node}`),
        ];
        this.unaryInterceptors = PubsubClient.initializeUnaryInterceptors(headers, props.configuration, this.requestTimeoutMs);
        this.streamingInterceptors = PubsubClient.initializeStreamingInterceptors(headers, props.configuration);
        this.isConnectionLost = false;
    }
    getEndpoint() {
        const endpoint = this.credentialProvider.getCacheEndpoint();
        this.getLogger().debug(`Using cache endpoint: ${endpoint}`);
        return endpoint;
    }
    async sendPublish(cacheName, topicName, value) {
        const topicValue = new grpcPubsub._TopicValue();
        if (typeof value === 'string') {
            topicValue.text = value;
        }
        else {
            topicValue.binary = value;
        }
        const request = new grpcPubsub._PublishRequest({
            cache_name: cacheName,
            topic: topicName,
            value: topicValue,
        });
        return await new Promise((resolve, reject) => {
            this.client.Publish(request, {
                interceptors: this.unaryInterceptors,
            }, (err, resp) => {
                if (resp) {
                    resolve(new __1.TopicPublish.Success());
                }
                else {
                    this.getCacheServiceErrorMapper().resolveOrRejectError({
                        err: err,
                        errorResponseFactoryFn: e => new __1.TopicPublish.Error(e),
                        resolveFn: resolve,
                        rejectFn: reject,
                    });
                }
            });
        });
    }
    /**
     * @remark This method is responsible for restarting the stream if it ends unexpectedly.
     * Since we return a single subscription object to the user, we need to update it with the
     * unsubscribe function should we restart the stream. This is why we pass the subscription
     * state and subscription object to this method.
     *
     * Handling a cache not exists requires special care as well. In the most likely case,
     * when the subscription starts and the cache does not exist, we receive an error immediately.
     * We return an error from the subscribe method and do immediately unsubscribe. In a distinct,
     * unlikely but possible case, the user deletes the cache while the stream is running. In this
     * case we already returned a subscription object to the user, so we instead cancel the stream and
     * propagate an error to the user via the error handler.
     */
    sendSubscribe(options) {
        const request = new grpcPubsub._SubscriptionRequest({
            cache_name: options.cacheName,
            topic: options.topicName,
            resume_at_topic_sequence_number: options.subscriptionState.resumeAtTopicSequenceNumber,
            sequence_page: options.subscriptionState.lastTopicSequencePage,
        });
        this.getLogger().trace('Subscribing to topic with resume_at_topic_sequence_number %s and sequence_page %s', options.subscriptionState.resumeAtTopicSequenceNumber, options.subscriptionState.resumeAtTopicSequencePage);
        let call;
        if (options.firstMessage) {
            // If this is the first message, we want to set a deadline for the request.
            const deadline = Date.now() + this.requestTimeoutMs;
            call = this.client.Subscribe(request, {
                interceptors: this.streamingInterceptors,
                deadline: deadline,
            });
        }
        else {
            call = this.client.Subscribe(request, {
                interceptors: this.streamingInterceptors,
            });
        }
        options.subscriptionState.setSubscribed();
        // Allow the caller to cancel the stream.
        // Note that because we restart the stream on error or stream end,
        // we need to ensure we keep the same subscription object. That way
        // stream restarts are transparent to the caller.
        options.subscriptionState.unsubscribeFn = () => {
            call.cancel();
        };
        return new Promise((resolve, _reject) => {
            const prepareCallbackOptions = {
                ...options,
                resolve,
            };
            call.on('data', this.prepareDataCallback(prepareCallbackOptions));
            call.on('error', this.prepareErrorCallback(prepareCallbackOptions));
            call.on('end', this.prepareEndCallback(prepareCallbackOptions));
        });
    }
    prepareDataCallback(options) {
        return (resp) => {
            if (options.firstMessage) {
                options.resolve(options.subscription);
            }
            options.firstMessage = false;
            if (resp.has_item || resp.has_heartbeat || resp.has_discontinuity) {
                if (this.isConnectionLost) {
                    this.isConnectionLost = false;
                }
            }
            if (resp.item) {
                const sequenceNumber = resp.item.topic_sequence_number;
                const sequencePage = resp.item.sequence_page;
                options.subscriptionState.lastTopicSequenceNumber = sequenceNumber;
                options.subscriptionState.lastTopicSequencePage = sequencePage;
                this.getLogger().trace('Received an item on subscription stream; topic: %s; sequence number: %s; sequence page: %s', (0, utils_1.truncateString)(options.topicName), sequenceNumber, sequencePage);
                if (resp.item.value.text) {
                    options.onItem(new __1.TopicItem(resp.item.value.text, sequenceNumber, {
                        tokenId: resp.item.publisher_id,
                    }));
                }
                else if (resp.item.value.binary) {
                    options.onItem(new __1.TopicItem(resp.item.value.binary, sequenceNumber, {
                        tokenId: resp.item.publisher_id,
                    }));
                }
                else {
                    this.getLogger().error('Received subscription item with unknown type; topic: %s', (0, utils_1.truncateString)(options.topicName));
                    options.onError(new __1.TopicSubscribe.Error(new __1.UnknownError('Unknown item value type')), options.subscription);
                }
            }
            else if (resp.heartbeat) {
                this.getLogger().trace('Received heartbeat from subscription stream; topic: %s', (0, utils_1.truncateString)(options.topicName));
                options.onHeartbeat(new __1.TopicHeartbeat());
            }
            else if (resp.discontinuity) {
                const topicDiscontinuity = new __1.TopicDiscontinuity(resp.discontinuity.last_topic_sequence, resp.discontinuity.new_topic_sequence, resp.discontinuity.new_sequence_page);
                this.getLogger().trace('Received discontinuity from subscription stream; topic: %s; %s', (0, utils_1.truncateString)(options.topicName), topicDiscontinuity.toString());
                options.subscriptionState.lastTopicSequenceNumber =
                    resp.discontinuity.new_topic_sequence;
                options.subscriptionState.lastTopicSequencePage =
                    resp.discontinuity.new_sequence_page;
                options.onDiscontinuity(topicDiscontinuity);
            }
            else {
                this.getLogger().error('Received unknown subscription item; topic: %s', (0, utils_1.truncateString)(options.topicName));
                options.onError(new __1.TopicSubscribe.Error(new __1.UnknownError('Unknown item type')), options.subscription);
            }
        };
    }
    prepareErrorCallback(options) {
        return (err) => {
            // When the caller unsubscribes, we may get a follow on error, which we ignore.
            if (!options.subscriptionState.isSubscribed) {
                return;
            }
            const serviceError = err;
            this.getLogger().trace(`Subscription encountered an error: ${serviceError.code}: ${serviceError.message}: ${serviceError.details}`);
            const shouldReconnectSubscription = 
            // previously, we were only attempting a reconnect on this one very specific case, but our current expectation is that
            // we should err on the side of retrying. This may become a sort of "deny list" of error types to *not* retry on
            // in the future, but for now we will be aggressive about retrying.
            // // serviceError.code === Status.INTERNAL &&
            //  // serviceError.details === PubsubClient.RST_STREAM_NO_ERROR_MESSAGE;
            true;
            if (!this.isConnectionLost) {
                this.isConnectionLost = true;
                options.onConnectionLost();
            }
            const momentoError = new __1.TopicSubscribe.Error(this.getCacheServiceErrorMapper().convertError(serviceError));
            this.handleSubscribeError(options, momentoError, shouldReconnectSubscription);
        };
    }
    static initializeUnaryInterceptors(headers, configuration, requestTimeoutMs) {
        const middlewares = configuration.getMiddlewares();
        const groupMiddlewares = (isLateLoad) => middlewares.filter(middleware => { var _a; return ((_a = middleware.shouldLoadLate) !== null && _a !== void 0 ? _a : false) === isLateLoad; });
        const createMiddlewareInterceptor = (middlewareGroup) => (0, middlewares_interceptor_1.middlewaresInterceptor)(configuration.getLoggerFactory(), middlewareGroup, {});
        // Separate middlewares into immediate and late-load groups
        const immediateMiddlewares = groupMiddlewares(false);
        const lateLoadMiddlewares = groupMiddlewares(true);
        const interceptors = [
            createMiddlewareInterceptor(immediateMiddlewares),
            headers_interceptor_1.HeaderInterceptor.createHeadersInterceptor(headers),
            retry_interceptor_1.RetryInterceptor.createRetryInterceptor({
                clientName: 'PubSubClient',
                loggerFactory: configuration.getLoggerFactory(),
                overallRequestTimeoutMs: requestTimeoutMs,
            }),
        ];
        if (lateLoadMiddlewares.length > 0) {
            interceptors.push(createMiddlewareInterceptor(lateLoadMiddlewares));
        }
        return interceptors;
    }
    // TODO https://github.com/momentohq/client-sdk-nodejs/issues/349
    // decide on streaming interceptors and middlewares
    static initializeStreamingInterceptors(headers, configuration) {
        const middlewares = configuration.getMiddlewares();
        const createMiddlewareInterceptor = (middlewares) => (0, middlewares_interceptor_1.middlewaresInterceptor)(configuration.getLoggerFactory(), middlewares, {});
        return [
            createMiddlewareInterceptor(middlewares),
            headers_interceptor_1.HeaderInterceptor.createHeadersInterceptor(headers),
        ];
    }
}
exports.PubsubClient = PubsubClient;
PubsubClient.DEFAULT_REQUEST_TIMEOUT_MS = (0, utils_2.secondsToMilliseconds)(5);
PubsubClient.DEFAULT_MAX_SESSION_MEMORY_MB = 256;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHVic3ViLWNsaWVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9pbnRlcm5hbC9wdWJzdWItY2xpZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLGdFQUFrRDtBQUNsRCwwR0FBMEc7QUFDMUcsb0VBQXFFO0FBQ3JFLHFGQUE2RTtBQUM3RSwyQ0FLdUI7QUFDdkIscURBQTJDO0FBQzNDLDRFQUFzRTtBQUN0RSwyQkFXYTtBQUNiLHVFQUEyRTtBQUMzRSxvSEFJbUY7QUFHbkYsc0VBQTZFO0FBQzdFLGdFQUEwRDtBQUMxRCw4REFBeUU7QUFDekUsSUFBTyxVQUFVLEdBQUcsd0JBQU0sQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDO0FBRS9DLE1BQWEsWUFBYSxTQUFRLDJDQUFrQztJQVdsRSx3REFBd0Q7SUFDeEQsdUNBQXVDO0lBRXZDOztPQUVHO0lBQ0gsWUFBWSxLQUEwQjtRQUNwQyxLQUFLLENBQ0gsS0FBSyxDQUFDLGFBQWEsQ0FBQyxnQkFBZ0IsRUFBRSxFQUN0QyxLQUFLLENBQUMsYUFBYSxDQUFDLGdCQUFnQixFQUFFLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsRUFDbkUsSUFBSSxvREFBdUIsQ0FBQyxLQUFLLENBQUMsYUFBYSxDQUFDLGdCQUFnQixFQUFFLENBQUMsQ0FDcEUsQ0FBQztRQUNGLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxLQUFLLENBQUMsa0JBQWtCLENBQUM7UUFDbkQsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDLEtBQUssQ0FDcEIsMENBQTBDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLENBQ3hGLENBQUM7UUFFRixNQUFNLGVBQWUsR0FBMkIsS0FBSyxDQUFDLGFBQWE7YUFDaEUsb0JBQW9CLEVBQUU7YUFDdEIsYUFBYSxFQUFFLENBQUM7UUFFbkIsSUFBSSxDQUFDLGdCQUFnQjtZQUNuQixlQUFlLENBQUMsaUJBQWlCLEVBQUU7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QVUsRUFBRSxjQUFjO2dCQUMxQixhQUFhLEVBQUUsYUFBYSxDQUFDLGdCQUFnQixFQUFFO2dCQUMvQyx1QkFBdUIsRUFBRSxnQkFBZ0I7YUFDMUMsQ0FBQztTQUNILENBQUM7UUFFRixJQUFJLG1CQUFtQixDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDbEMsWUFBWSxDQUFDLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLENBQUM7U0FDckU7UUFDRCxPQUFPLFlBQVksQ0FBQztJQUN0QixDQUFDO0lBRUQsaUVBQWlFO0lBQ2pFLG1EQUFtRDtJQUMzQyxNQUFNLENBQUMsK0JBQStCLENBQzVDLE9BQWlCLEVBQ2pCLGFBQWlDO1FBRWpDLE1BQU0sV0FBVyxHQUFHLGFBQWEsQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUVuRCxNQUFNLDJCQUEyQixHQUFHLENBQUMsV0FBeUIsRUFBRSxFQUFFLENBQ2hFLElBQUEsZ0RBQXNCLEVBQUMsYUFBYSxDQUFDLGdCQUFnQixFQUFFLEVBQUUsV0FBVyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRTVFLE9BQU87WUFDTCwyQkFBMkIsQ0FBQyxXQUFXLENBQUM7WUFDeEMsdUNBQWlCLENBQUMsd0JBQXdCLENBQUMsT0FBTyxDQUFDO1NBQ3BELENBQUM7SUFDSixDQUFDOztBQWhYSCxvQ0FpWEM7QUE3V3lCLHVDQUEwQixHQUNoRCxJQUFBLDZCQUFxQixFQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ0gsMENBQTZCLEdBQVcsR0FBRyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtwdWJzdWJ9IGZyb20gJ0Bnb21vbWVudG8vZ2VuZXJhdGVkLXR5cGVzJztcbi8vIG9sZGVyIHZlcnNpb25zIG9mIG5vZGUgZG9uJ3QgaGF2ZSB0aGUgZ2xvYmFsIHV0aWwgdmFyaWFibGVzIGh0dHBzOi8vZ2l0aHViLmNvbS9ub2RlanMvbm9kZS9pc3N1ZXMvMjAzNjVcbmltcG9ydCB7SGVhZGVyLCBIZWFkZXJJbnRlcmNlcHRvcn0gZnJvbSAnLi9ncnBjL2hlYWRlcnMtaW50ZXJjZXB0b3InO1xuaW1wb3J0IHtDYWNoZVNlcnZpY2VFcnJvck1hcHBlcn0gZnJvbSAnLi4vZXJyb3JzL2NhY2hlLXNlcnZpY2UtZXJyb3ItbWFwcGVyJztcbmltcG9ydCB7XG4gIENoYW5uZWxDcmVkZW50aWFscyxcbiAgQ2xpZW50UmVhZGFibGVTdHJlYW0sXG4gIEludGVyY2VwdG9yLFxuICBTZXJ2aWNlRXJyb3IsXG59IGZyb20gJ0BncnBjL2dycGMtanMnO1xuaW1wb3J0IHt2ZXJzaW9ufSBmcm9tICcuLi8uLi9wYWNrYWdlLmpzb24nO1xuaW1wb3J0IHttaWRkbGV3YXJlc0ludGVyY2VwdG9yfSBmcm9tICcuL2dycGMvbWlkZGxld2FyZXMtaW50ZXJjZXB0b3InO1xuaW1wb3J0IHtcbiAgQ3JlZGVudGlhbFByb3ZpZGVyLFxuICBNaWRkbGV3YXJlLFxuICBTdGF0aWNHcnBjQ29uZmlndXJhdGlvbixcbiAgVG9waWNEaXNjb250aW51aXR5LFxuICBUb3BpY0dycGNDb25maWd1cmF0aW9uLFxuICBUb3BpY0hlYXJ0YmVhdCxcbiAgVG9waWNJdGVtLFxuICBUb3BpY1B1Ymxpc2gsXG4gIFRvcGljU3Vic2NyaWJlLFxuICBVbmtub3duRXJyb3IsXG59IGZyb20gJy4uLyc7XG5pbXBvcnQge3RydW5jYXRlU3RyaW5nfSBmcm9tICdAZ29tb21lbnRvL3Nkay1jb3JlL2Rpc3Qvc3JjL2ludGVybmFsL3V0aWxzJztcbmltcG9ydCB7XG4gIEFic3RyYWN0UHVic3ViQ2xpZW50LFxuICBQcmVwYXJlU3Vic2NyaWJlQ2FsbGJhY2tPcHRpb25zLFxuICBTZW5kU3Vic2NyaWJlT3B0aW9ucyxcbn0gZnJvbSAnQGdvbW9tZW50by9zZGstY29yZS9kaXN0L3NyYy9pbnRlcm5hbC9jbGllbnRzL3B1YnN1Yi9BYnN0cmFjdFB1YnN1YkNsaWVudCc7XG5pbXBvcnQge1RvcGljQ29uZmlndXJhdGlvbn0gZnJvbSAnLi4vY29uZmlnL3RvcGljLWNvbmZpZ3VyYXRpb24nO1xuaW1wb3J0IHtUb3BpY0NsaWVudEFsbFByb3BzfSBmcm9tICcuL3RvcGljLWNsaWVudC1hbGwtcHJvcHMnO1xuaW1wb3J0IHtncnBjQ2hhbm5lbE9wdGlvbnNGcm9tR3JwY0NvbmZpZ30gZnJvbSAnLi9ncnBjL2dycGMtY2hhbm5lbC1vcHRpb25zJztcbmltcG9ydCB7UmV0cnlJbnRlcmNlcHRvcn0gZnJvbSAnLi9ncnBjL3JldHJ5LWludGVyY2VwdG9yJztcbmltcG9ydCB7c2Vjb25kc1RvTWlsbGlzZWNvbmRzfSBmcm9tICdAZ29tb21lbnRvL3Nkay1jb3JlL2Rpc3Qvc3JjL3V0aWxzJztcbmltcG9ydCBncnBjUHVic3ViID0gcHVic3ViLmNhY2hlX2NsaWVudC5wdWJzdWI7XG5cbmV4cG9ydCBjbGFzcyBQdWJzdWJDbGllbnQgZXh0ZW5kcyBBYnN0cmFjdFB1YnN1YkNsaWVudDxTZXJ2aWNlRXJyb3I+IHtcbiAgcHJpdmF0ZSByZWFkb25seSBjbGllbnQ6IGdycGNQdWJzdWIuUHVic3ViQ2xpZW50O1xuICBwcm90ZWN0ZWQgcmVhZG9ubHkgY3JlZGVudGlhbFByb3ZpZGVyOiBDcmVkZW50aWFsUHJvdmlkZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgcmVxdWVzdFRpbWVvdXRNczogbnVtYmVyO1xuICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBERUZBVUxUX1JFUVVFU1RfVElNRU9VVF9NUzogbnVtYmVyID1cbiAgICBzZWNvbmRzVG9NaWxsaXNlY29uZHMoNSk7XG4gIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IERFRkFVTFRfTUFYX1NFU1NJT05fTUVNT1JZX01COiBudW1iZXIgPSAyNTY7XG4gIHByaXZhdGUgcmVhZG9ubHkgdW5hcnlJbnRlcmNlcHRvcnM6IEludGVyY2VwdG9yW107XG4gIHByaXZhdGUgcmVhZG9ubHkgc3RyZWFtaW5nSW50ZXJjZXB0b3JzOiBJbnRlcmNlcHRvcltdO1xuICBwcml2YXRlIGlzQ29ubmVjdGlvbkxvc3Q6IGJvb2xlYW47XG5cbiAgLy8gcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgUlNUX1NUUkVBTV9OT19FUlJPUl9NRVNTQUdFID1cbiAgLy8gICAnUmVjZWl2ZWQgUlNUX1NUUkVBTSB3aXRoIGNvZGUgMCc7XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7VG9waWNDbGllbnRQcm9wc30gcHJvcHNcbiAgICovXG4gIGNvbnN0cnVjdG9yKHByb3BzOiBUb3BpY0NsaWVudEFsbFByb3BzKSB7XG4gICAgc3VwZXIoXG4gICAgICBwcm9wcy5jb25maWd1cmF0aW9uLmdldExvZ2dlckZhY3RvcnkoKSxcbiAgICAgIHByb3BzLmNvbmZpZ3VyYXRpb24uZ2V0TG9nZ2VyRmFjdG9yeSgpLmdldExvZ2dlcihQdWJzdWJDbGllbnQubmFtZSksXG4gICAgICBuZXcgQ2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIocHJvcHMuY29uZmlndXJhdGlvbi5nZXRUaHJvd09uRXJyb3JzKCkpXG4gICAgKTtcbiAgICB0aGlzLmNyZWRlbnRpYWxQcm92aWRlciA9IHByb3BzLmNyZWRlbnRpYWxQcm92aWRlcjtcbiAgICB0aGlzLmdldExvZ2dlcigpLmRlYnVnKFxuICAgICAgYENyZWF0aW5nIHRvcGljIGNsaWVudCB1c2luZyBlbmRwb2ludDogJyR7dGhpcy5jcmVkZW50aWFsUHJvdmlkZXIuZ2V0Q2FjaGVFbmRwb2ludCgpfSdgXG4gICAgKTtcblxuICAgIGNvbnN0IHRvcGljR3JwY0NvbmZpZzogVG9waWNHcnBjQ29uZmlndXJhdGlvbiA9IHByb3BzLmNvbmZpZ3VyYXRpb25cbiAgICAgIC5nZXRUcmFuc3BvcnRTdHJhdGVneSgpXG4gICAgICAuZ2V0R3JwY0NvbmZpZygpO1xuXG4gICAgdGhpcy5yZXF1ZXN0VGltZW91dE1zID1cbiAgICAgIHRvcGljR3JwY0NvbmZpZy5nZXREZWFkbGluZU1pbGxpcygpIHx8XG4gICAgICBQdWJzdWJDbGllbnQuREVGQVVMVF9SRVFVRVNUX1RJTUVPVVRfTVM7XG5cbiAgICAvLyBOT1RFOiBUaGlzIGlzIGhhcmQtY29kZWQgZm9yIG5vdyBidXQgd2UgbWF5IHdhbnQgdG8gZXhwb3NlIGl0IHZpYSBUb3BpY0NvbmZpZ3VyYXRpb24gaW4gdGhlXG4gICAgLy8gZnV0dXJlLCBhcyB3ZSBkbyB3aXRoIHNvbWUgb2YgdGhlIG90aGVyIGNsaWVudHMuXG4gICAgY29uc3QgZ3JwY0NvbmZpZyA9IG5ldyBTdGF0aWNHcnBjQ29uZmlndXJhdGlvbih7XG4gICAgICBkZWFkbGluZU1pbGxpczogdGhpcy5yZXF1ZXN0VGltZW91dE1zLFxuICAgICAgbWF4U2Vzc2lvbk1lbW9yeU1iOiBQdWJzdWJDbGllbnQuREVGQVVMVF9NQVhfU0VTU0lPTl9NRU1PUllfTUIsXG4gICAgICBrZWVwQWxpdmVQZXJtaXRXaXRob3V0Q2FsbHM6XG4gICAgICAgIHRvcGljR3JwY0NvbmZpZy5nZXRLZWVwQWxpdmVQZXJtaXRXaXRob3V0Q2FsbHMoKSxcbiAgICAgIGtlZXBBbGl2ZVRpbWVNczogdG9waWNHcnBjQ29uZmlnLmdldEtlZXBBbGl2ZVRpbWVNUygpLFxuICAgICAga2VlcEFsaXZlVGltZW91dE1zOiB0b3BpY0dycGNDb25maWcuZ2V0S2VlcEFsaXZlVGltZW91dE1TKCksXG4gICAgfSk7XG5cbiAgICBjb25zdCBjaGFubmVsT3B0aW9ucyA9IGdycGNDaGFubmVsT3B0aW9uc0Zyb21HcnBjQ29uZmlnKGdycGNDb25maWcpO1xuXG4gICAgdGhpcy5nZXRMb2dnZXIoKS5kZWJ1ZyhcbiAgICAgIGBDcmVhdGluZyBwdWJzdWIgY2xpZW50IHdpdGggY2hhbm5lbCBvcHRpb25zOiAke0pTT04uc3RyaW5naWZ5KFxuICAgICAgICBjaGFubmVsT3B0aW9ucyxcbiAgICAgICAgbnVsbCxcbiAgICAgICAgMlxuICAgICAgKX1gXG4gICAgKTtcblxuICAgIHRoaXMuY2xpZW50ID0gbmV3IGdycGNQdWJzdWIuUHVic3ViQ2xpZW50KFxuICAgICAgdGhpcy5jcmVkZW50aWFsUHJvdmlkZXIuZ2V0Q2FjaGVFbmRwb2ludCgpLFxuICAgICAgdGhpcy5jcmVkZW50aWFsUHJvdmlkZXIuaXNDYWNoZUVuZHBvaW50U2VjdXJlKClcbiAgICAgICAgPyBDaGFubmVsQ3JlZGVudGlhbHMuY3JlYXRlU3NsKClcbiAgICAgICAgOiBDaGFubmVsQ3JlZGVudGlhbHMuY3JlYXRlSW5zZWN1cmUoKSxcbiAgICAgIGNoYW5uZWxPcHRpb25zXG4gICAgKTtcblxuICAgIGNvbnN0IGhlYWRlcnM6IEhlYWRlcltdID0gW1xuICAgICAgbmV3IEhlYWRlcignQXV0aG9yaXphdGlvbicsIHRoaXMuY3JlZGVudGlhbFByb3ZpZGVyLmdldEF1dGhUb2tlbigpKSxcbiAgICAgIG5ldyBIZWFkZXIoJ2FnZW50JywgYG5vZGVqczp0b3BpYzoke3ZlcnNpb259YCksXG4gICAgICBuZXcgSGVhZGVyKCdydW50aW1lLXZlcnNpb24nLCBgbm9kZWpzOiR7cHJvY2Vzcy52ZXJzaW9ucy5ub2RlfWApLFxuICAgIF07XG4gICAgdGhpcy51bmFyeUludGVyY2VwdG9ycyA9IFB1YnN1YkNsaWVudC5pbml0aWFsaXplVW5hcnlJbnRlcmNlcHRvcnMoXG4gICAgICBoZWFkZXJzLFxuICAgICAgcHJvcHMuY29uZmlndXJhdGlvbixcbiAgICAgIHRoaXMucmVxdWVzdFRpbWVvdXRNc1xuICAgICk7XG4gICAgdGhpcy5zdHJlYW1pbmdJbnRlcmNlcHRvcnMgPSBQdWJzdWJDbGllbnQuaW5pdGlhbGl6ZVN0cmVhbWluZ0ludGVyY2VwdG9ycyhcbiAgICAgIGhlYWRlcnMsXG4gICAgICBwcm9wcy5jb25maWd1cmF0aW9uXG4gICAgKTtcbiAgICB0aGlzLmlzQ29ubmVjdGlvbkxvc3QgPSBmYWxzZTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRFbmRwb2ludCgpOiBzdHJpbmcge1xuICAgIGNvbnN0IGVuZHBvaW50ID0gdGhpcy5jcmVkZW50aWFsUHJvdmlkZXIuZ2V0Q2FjaGVFbmRwb2ludCgpO1xuICAgIHRoaXMuZ2V0TG9nZ2VyKCkuZGVidWcoYFVzaW5nIGNhY2hlIGVuZHBvaW50OiAke2VuZHBvaW50fWApO1xuICAgIHJldHVybiBlbmRwb2ludDtcbiAgfVxuXG4gIHByb3RlY3RlZCBhc3luYyBzZW5kUHVibGlzaChcbiAgICBjYWNoZU5hbWU6IHN0cmluZyxcbiAgICB0b3BpY05hbWU6IHN0cmluZyxcbiAgICB2YWx1ZTogc3RyaW5nIHwgVWludDhBcnJheVxuICApOiBQcm9taXNlPFRvcGljUHVibGlzaC5SZXNwb25zZT4ge1xuICAgIGNvbnN0IHRvcGljVmFsdWUgPSBuZXcgZ3JwY1B1YnN1Yi5fVG9waWNWYWx1ZSgpO1xuICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7XG4gICAgICB0b3BpY1ZhbHVlLnRleHQgPSB2YWx1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgdG9waWNWYWx1ZS5iaW5hcnkgPSB2YWx1ZTtcbiAgICB9XG5cbiAgICBjb25zdCByZXF1ZXN0ID0gbmV3IGdycGNQdWJzdWIuX1B1Ymxpc2hSZXF1ZXN0KHtcbiAgICAgIGNhY2hlX25hbWU6IGNhY2hlTmFtZSxcbiAgICAgIHRvcGljOiB0b3BpY05hbWUsXG4gICAgICB2YWx1ZTogdG9waWNWYWx1ZSxcbiAgICB9KTtcblxuICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmNsaWVudC5QdWJsaXNoKFxuICAgICAgICByZXF1ZXN0LFxuICAgICAgICB7XG4gICAgICAgICAgaW50ZXJjZXB0b3JzOiB0aGlzLnVuYXJ5SW50ZXJjZXB0b3JzLFxuICAgICAgICB9LFxuICAgICAgICAoZXJyLCByZXNwKSA9PiB7XG4gICAgICAgICAgaWYgKHJlc3ApIHtcbiAgICAgICAgICAgIHJlc29sdmUobmV3IFRvcGljUHVibGlzaC5TdWNjZXNzKCkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmdldENhY2hlU2VydmljZUVycm9yTWFwcGVyKCkucmVzb2x2ZU9yUmVqZWN0RXJyb3Ioe1xuICAgICAgICAgICAgICBlcnI6IGVycixcbiAgICAgICAgICAgICAgZXJyb3JSZXNwb25zZUZhY3RvcnlGbjogZSA9PiBuZXcgVG9waWNQdWJsaXNoLkVycm9yKGUpLFxuICAgICAgICAgICAgICByZXNvbHZlRm46IHJlc29sdmUsXG4gICAgICAgICAgICAgIHJlamVjdEZuOiByZWplY3QsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQHJlbWFyayBUaGlzIG1ldGhvZCBpcyByZXNwb25zaWJsZSBmb3IgcmVzdGFydGluZyB0aGUgc3RyZWFtIGlmIGl0IGVuZHMgdW5leHBlY3RlZGx5LlxuICAgKiBTaW5jZSB3ZSByZXR1cm4gYSBzaW5nbGUgc3Vic2NyaXB0aW9uIG9iamVjdCB0byB0aGUgdXNlciwgd2UgbmVlZCB0byB1cGRhdGUgaXQgd2l0aCB0aGVcbiAgICogdW5zdWJzY3JpYmUgZnVuY3Rpb24gc2hvdWxkIHdlIHJlc3RhcnQgdGhlIHN0cmVhbS4gVGhpcyBpcyB3aHkgd2UgcGFzcyB0aGUgc3Vic2NyaXB0aW9uXG4gICAqIHN0YXRlIGFuZCBzdWJzY3JpcHRpb24gb2JqZWN0IHRvIHRoaXMgbWV0aG9kLlxuICAgKlxuICAgKiBIYW5kbGluZyBhIGNhY2hlIG5vdCBleGlzdHMgcmVxdWlyZXMgc3BlY2lhbCBjYXJlIGFzIHdlbGwuIEluIHRoZSBtb3N0IGxpa2VseSBjYXNlLFxuICAgKiB3aGVuIHRoZSBzdWJzY3JpcHRpb24gc3RhcnRzIGFuZCB0aGUgY2FjaGUgZG9lcyBub3QgZXhpc3QsIHdlIHJlY2VpdmUgYW4gZXJyb3IgaW1tZWRpYXRlbHkuXG4gICAqIFdlIHJldHVybiBhbiBlcnJvciBmcm9tIHRoZSBzdWJzY3JpYmUgbWV0aG9kIGFuZCBkbyBpbW1lZGlhdGVseSB1bnN1YnNjcmliZS4gSW4gYSBkaXN0aW5jdCxcbiAgICogdW5saWtlbHkgYnV0IHBvc3NpYmxlIGNhc2UsIHRoZSB1c2VyIGRlbGV0ZXMgdGhlIGNhY2hlIHdoaWxlIHRoZSBzdHJlYW0gaXMgcnVubmluZy4gSW4gdGhpc1xuICAgKiBjYXNlIHdlIGFscmVhZHkgcmV0dXJuZWQgYSBzdWJzY3JpcHRpb24gb2JqZWN0IHRvIHRoZSB1c2VyLCBzbyB3ZSBpbnN0ZWFkIGNhbmNlbCB0aGUgc3RyZWFtIGFuZFxuICAgKiBwcm9wYWdhdGUgYW4gZXJyb3IgdG8gdGhlIHVzZXIgdmlhIHRoZSBlcnJvciBoYW5kbGVyLlxuICAgKi9cbiAgcHJvdGVjdGVkIG92ZXJyaWRlIHNlbmRTdWJzY3JpYmUoXG4gICAgb3B0aW9uczogU2VuZFN1YnNjcmliZU9wdGlvbnNcbiAgKTogUHJvbWlzZTxUb3BpY1N1YnNjcmliZS5SZXNwb25zZT4ge1xuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgZ3JwY1B1YnN1Yi5fU3Vic2NyaXB0aW9uUmVxdWVzdCh7XG4gICAgICBjYWNoZV9uYW1lOiBvcHRpb25zLmNhY2hlTmFtZSxcbiAgICAgIHRvcGljOiBvcHRpb25zLnRvcGljTmFtZSxcbiAgICAgIHJlc3VtZV9hdF90b3BpY19zZXF1ZW5jZV9udW1iZXI6XG4gICAgICAgIG9wdGlvbnMuc3Vic2NyaXB0aW9uU3RhdGUucmVzdW1lQXRUb3BpY1NlcXVlbmNlTnVtYmVyLFxuICAgICAgc2VxdWVuY2VfcGFnZTogb3B0aW9ucy5zdWJzY3JpcHRpb25TdGF0ZS5sYXN0VG9waWNTZXF1ZW5jZVBhZ2UsXG4gICAgfSk7XG5cbiAgICB0aGlzLmdldExvZ2dlcigpLnRyYWNlKFxuICAgICAgJ1N1YnNjcmliaW5nIHRvIHRvcGljIHdpdGggcmVzdW1lX2F0X3RvcGljX3NlcXVlbmNlX251bWJlciAlcyBhbmQgc2VxdWVuY2VfcGFnZSAlcycsXG4gICAgICBvcHRpb25zLnN1YnNjcmlwdGlvblN0YXRlLnJlc3VtZUF0VG9waWNTZXF1ZW5jZU51bWJlcixcbiAgICAgIG9wdGlvbnMuc3Vic2NyaXB0aW9uU3RhdGUucmVzdW1lQXRUb3BpY1NlcXVlbmNlUGFnZVxuICAgICk7XG5cbiAgICBsZXQgY2FsbDogQ2xpZW50UmVhZGFibGVTdHJlYW08Z3JwY1B1YnN1Yi5fU3Vic2NyaXB0aW9uSXRlbT47XG4gICAgaWYgKG9wdGlvbnMuZmlyc3RNZXNzYWdlKSB7XG4gICAgICAvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCBtZXNzYWdlLCB3ZSB3YW50IHRvIHNldCBhIGRlYWRsaW5lIGZvciB0aGUgcmVxdWVzdC5cbiAgICAgIGNvbnN0IGRlYWRsaW5lID0gRGF0ZS5ub3coKSArIHRoaXMucmVxdWVzdFRpbWVvdXRNcztcbiAgICAgIGNhbGwgPSB0aGlzLmNsaWVudC5TdWJzY3JpYmUocmVxdWVzdCwge1xuICAgICAgICBpbnRlcmNlcHRvcnM6IHRoaXMuc3RyZWFtaW5nSW50ZXJjZXB0b3JzLFxuICAgICAgICBkZWFkbGluZTogZGVhZGxpbmUsXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgY2FsbCA9IHRoaXMuY2xpZW50LlN1YnNjcmliZShyZXF1ZXN0LCB7XG4gICAgICAgIGludGVyY2VwdG9yczogdGhpcy5zdHJlYW1pbmdJbnRlcmNlcHRvcnMsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBvcHRpb25zLnN1YnNjcmlwdGlvblN0YXRlLnNldFN1YnNjcmliZWQoKTtcblxuICAgIC8vIEFsbG93IHRoZSBjYWxsZXIgdG8gY2FuY2VsIHRoZSBzdHJlYW0uXG4gICAgLy8gTm90ZSB0aGF0IGJlY2F1c2Ugd2UgcmVzdGFydCB0aGUgc3RyZWFtIG9uIGVycm9yIG9yIHN0cmVhbSBlbmQsXG4gICAgLy8gd2UgbmVlZCB0byBlbnN1cmUgd2Uga2VlcCB0aGUgc2FtZSBzdWJzY3JpcHRpb24gb2JqZWN0LiBUaGF0IHdheVxuICAgIC8vIHN0cmVhbSByZXN0YXJ0cyBhcmUgdHJhbnNwYXJlbnQgdG8gdGhlIGNhbGxlci5cbiAgICBvcHRpb25zLnN1YnNjcmlwdGlvblN0YXRlLnVuc3Vic2NyaWJlRm4gPSAoKSA9PiB7XG4gICAgICBjYWxsLmNhbmNlbCgpO1xuICAgIH07XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIF9yZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IHByZXBhcmVDYWxsYmFja09wdGlvbnM6IFByZXBhcmVTdWJzY3JpYmVDYWxsYmFja09wdGlvbnMgPSB7XG4gICAgICAgIC4uLm9wdGlvbnMsXG4gICAgICAgIHJlc29sdmUsXG4gICAgICB9O1xuICAgICAgY2FsbC5vbignZGF0YScsIHRoaXMucHJlcGFyZURhdGFDYWxsYmFjayhwcmVwYXJlQ2FsbGJhY2tPcHRpb25zKSk7XG4gICAgICBjYWxsLm9uKCdlcnJvcicsIHRoaXMucHJlcGFyZUVycm9yQ2FsbGJhY2socHJlcGFyZUNhbGxiYWNrT3B0aW9ucykpO1xuICAgICAgY2FsbC5vbignZW5kJywgdGhpcy5wcmVwYXJlRW5kQ2FsbGJhY2socHJlcGFyZUNhbGxiYWNrT3B0aW9ucykpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBwcmVwYXJlRGF0YUNhbGxiYWNrKFxuICAgIG9wdGlvbnM6IFByZXBhcmVTdWJzY3JpYmVDYWxsYmFja09wdGlvbnNcbiAgKTogKHJlc3A6IGdycGNQdWJzdWIuX1N1YnNjcmlwdGlvbkl0ZW0pID0+IHZvaWQge1xuICAgIHJldHVybiAocmVzcDogZ3JwY1B1YnN1Yi5fU3Vic2NyaXB0aW9uSXRlbSkgPT4ge1xuICAgICAgaWYgKG9wdGlvbnMuZmlyc3RNZXNzYWdlKSB7XG4gICAgICAgIG9wdGlvbnMucmVzb2x2ZShvcHRpb25zLnN1YnNjcmlwdGlvbik7XG4gICAgICB9XG4gICAgICBvcHRpb25zLmZpcnN0TWVzc2FnZSA9IGZhbHNlO1xuXG4gICAgICBpZiAocmVzcC5oYXNfaXRlbSB8fCByZXNwLmhhc19oZWFydGJlYXQgfHwgcmVzcC5oYXNfZGlzY29udGludWl0eSkge1xuICAgICAgICBpZiAodGhpcy5pc0Nvbm5lY3Rpb25Mb3N0KSB7XG4gICAgICAgICAgdGhpcy5pc0Nvbm5lY3Rpb25Mb3N0ID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKHJlc3AuaXRlbSkge1xuICAgICAgICBjb25zdCBzZXF1ZW5jZU51bWJlciA9IHJlc3AuaXRlbS50b3BpY19zZXF1ZW5jZV9udW1iZXI7XG4gICAgICAgIGNvbnN0IHNlcXVlbmNlUGFnZSA9IHJlc3AuaXRlbS5zZXF1ZW5jZV9wYWdlO1xuICAgICAgICBvcHRpb25zLnN1YnNjcmlwdGlvblN0YXRlLmxhc3RUb3BpY1NlcXVlbmNlTnVtYmVyID0gc2VxdWVuY2VOdW1iZXI7XG4gICAgICAgIG9wdGlvbnMuc3Vic2NyaXB0aW9uU3RhdGUubGFzdFRvcGljU2VxdWVuY2VQYWdlID0gc2VxdWVuY2VQYWdlO1xuICAgICAgICB0aGlzLmdldExvZ2dlcigpLnRyYWNlKFxuICAgICAgICAgICdSZWNlaXZlZCBhbiBpdGVtIG9uIHN1YnNjcmlwdGlvbiBzdHJlYW07IHRvcGljOiAlczsgc2VxdWVuY2UgbnVtYmVyOiAlczsgc2VxdWVuY2UgcGFnZTogJXMnLFxuICAgICAgICAgIHRydW5jYXRlU3RyaW5nKG9wdGlvbnMudG9waWNOYW1lKSxcbiAgICAgICAgICBzZXF1ZW5jZU51bWJlcixcbiAgICAgICAgICBzZXF1ZW5jZVBhZ2VcbiAgICAgICAgKTtcbiAgICAgICAgaWYgKHJlc3AuaXRlbS52YWx1ZS50ZXh0KSB7XG4gICAgICAgICAgb3B0aW9ucy5vbkl0ZW0oXG4gICAgICAgICAgICBuZXcgVG9waWNJdGVtKHJlc3AuaXRlbS52YWx1ZS50ZXh0LCBzZXF1ZW5jZU51bWJlciwge1xuICAgICAgICAgICAgICB0b2tlbklkOiByZXNwLml0ZW0ucHVibGlzaGVyX2lkLFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICApO1xuICAgICAgICB9IGVsc2UgaWYgKHJlc3AuaXRlbS52YWx1ZS5iaW5hcnkpIHtcbiAgICAgICAgICBvcHRpb25zLm9uSXRlbShcbiAgICAgICAgICAgIG5ldyBUb3BpY0l0ZW0ocmVzcC5pdGVtLnZhbHVlLmJpbmFyeSwgc2VxdWVuY2VOdW1iZXIsIHtcbiAgICAgICAgICAgICAgdG9rZW5JZDogcmVzcC5pdGVtLnB1Ymxpc2hlcl9pZCxcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLmdldExvZ2dlcigpLmVycm9yKFxuICAgICAgICAgICAgJ1JlY2VpdmVkIHN1YnNjcmlwdGlvbiBpdGVtIHdpdGggdW5rbm93biB0eXBlOyB0b3BpYzogJXMnLFxuICAgICAgICAgICAgdHJ1bmNhdGVTdHJpbmcob3B0aW9ucy50b3BpY05hbWUpXG4gICAgICAgICAgKTtcbiAgICAgICAgICBvcHRpb25zLm9uRXJyb3IoXG4gICAgICAgICAgICBuZXcgVG9waWNTdWJzY3JpYmUuRXJyb3IoXG4gICAgICAgICAgICAgIG5ldyBVbmtub3duRXJyb3IoJ1Vua25vd24gaXRlbSB2YWx1ZSB0eXBlJylcbiAgICAgICAgICAgICksXG4gICAgICAgICAgICBvcHRpb25zLnN1YnNjcmlwdGlvblxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAocmVzcC5oZWFydGJlYXQpIHtcbiAgICAgICAgdGhpcy5nZXRMb2dnZXIoKS50cmFjZShcbiAgICAgICAgICAnUmVjZWl2ZWQgaGVhcnRiZWF0IGZyb20gc3Vic2NyaXB0aW9uIHN0cmVhbTsgdG9waWM6ICVzJyxcbiAgICAgICAgICB0cnVuY2F0ZVN0cmluZyhvcHRpb25zLnRvcGljTmFtZSlcbiAgICAgICAgKTtcbiAgICAgICAgb3B0aW9ucy5vbkhlYXJ0YmVhdChuZXcgVG9waWNIZWFydGJlYXQoKSk7XG4gICAgICB9IGVsc2UgaWYgKHJlc3AuZGlzY29udGludWl0eSkge1xuICAgICAgICBjb25zdCB0b3BpY0Rpc2NvbnRpbnVpdHkgPSBuZXcgVG9waWNEaXNjb250aW51aXR5KFxuICAgICAgICAgIHJlc3AuZGlzY29udGludWl0eS5sYXN0X3RvcGljX3NlcXVlbmNlLFxuICAgICAgICAgIHJlc3AuZGlzY29udGludWl0eS5uZXdfdG9waWNfc2VxdWVuY2UsXG4gICAgICAgICAgcmVzcC5kaXNjb250aW51aXR5Lm5ld19zZXF1ZW5jZV9wYWdlXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMuZ2V0TG9nZ2VyKCkudHJhY2UoXG4gICAgICAgICAgJ1JlY2VpdmVkIGRpc2NvbnRpbnVpdHkgZnJvbSBzdWJzY3JpcHRpb24gc3RyZWFtOyB0b3BpYzogJXM7ICVzJyxcbiAgICAgICAgICB0cnVuY2F0ZVN0cmluZyhvcHRpb25zLnRvcGljTmFtZSksXG4gICAgICAgICAgdG9waWNEaXNjb250aW51aXR5LnRvU3RyaW5nKClcbiAgICAgICAgKTtcbiAgICAgICAgb3B0aW9ucy5zdWJzY3JpcHRpb25TdGF0ZS5sYXN0VG9waWNTZXF1ZW5jZU51bWJlciA9XG4gICAgICAgICAgcmVzcC5kaXNjb250aW51aXR5Lm5ld190b3BpY19zZXF1ZW5jZTtcbiAgICAgICAgb3B0aW9ucy5zdWJzY3JpcHRpb25TdGF0ZS5sYXN0VG9waWNTZXF1ZW5jZVBhZ2UgPVxuICAgICAgICAgIHJlc3AuZGlzY29udGludWl0eS5uZXdfc2VxdWVuY2VfcGFnZTtcbiAgICAgICAgb3B0aW9ucy5vbkRpc2NvbnRpbnVpdHkodG9waWNEaXNjb250aW51aXR5KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuZ2V0TG9nZ2VyKCkuZXJyb3IoXG4gICAgICAgICAgJ1JlY2VpdmVkIHVua25vd24gc3Vic2NyaXB0aW9uIGl0ZW07IHRvcGljOiAlcycsXG4gICAgICAgICAgdHJ1bmNhdGVTdHJpbmcob3B0aW9ucy50b3BpY05hbWUpXG4gICAgICAgICk7XG4gICAgICAgIG9wdGlvbnMub25FcnJvcihcbiAgICAgICAgICBuZXcgVG9waWNTdWJzY3JpYmUuRXJyb3IobmV3IFVua25vd25FcnJvcignVW5rbm93biBpdGVtIHR5cGUnKSksXG4gICAgICAgICAgb3B0aW9ucy5zdWJzY3JpcHRpb25cbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBwcmVwYXJlRXJyb3JDYWxsYmFjayhcbiAgICBvcHRpb25zOiBQcmVwYXJlU3Vic2NyaWJlQ2FsbGJhY2tPcHRpb25zXG4gICk6IChlcnI6IEVycm9yKSA9PiB2b2lkIHtcbiAgICByZXR1cm4gKGVycjogRXJyb3IpID0+IHtcbiAgICAgIC8vIFdoZW4gdGhlIGNhbGxlciB1bnN1YnNjcmliZXMsIHdlIG1heSBnZXQgYSBmb2xsb3cgb24gZXJyb3IsIHdoaWNoIHdlIGlnbm9yZS5cbiAgICAgIGlmICghb3B0aW9ucy5zdWJzY3JpcHRpb25TdGF0ZS5pc1N1YnNjcmliZWQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBzZXJ2aWNlRXJyb3IgPSBlcnIgYXMgdW5rbm93biBhcyBTZXJ2aWNlRXJyb3I7XG4gICAgICB0aGlzLmdldExvZ2dlcigpLnRyYWNlKFxuICAgICAgICBgU3Vic2NyaXB0aW9uIGVuY291bnRlcmVkIGFuIGVycm9yOiAke3NlcnZpY2VFcnJvci5jb2RlfTogJHtzZXJ2aWNlRXJyb3IubWVzc2FnZX06ICR7c2VydmljZUVycm9yLmRldGFpbHN9YFxuICAgICAgKTtcbiAgICAgIGNvbnN0IHNob3VsZFJlY29ubmVjdFN1YnNjcmlwdGlvbiA9XG4gICAgICAgIC8vIHByZXZpb3VzbHksIHdlIHdlcmUgb25seSBhdHRlbXB0aW5nIGEgcmVjb25uZWN0IG9uIHRoaXMgb25lIHZlcnkgc3BlY2lmaWMgY2FzZSwgYnV0IG91ciBjdXJyZW50IGV4cGVjdGF0aW9uIGlzIHRoYXRcbiAgICAgICAgLy8gd2Ugc2hvdWxkIGVyciBvbiB0aGUgc2lkZSBvZiByZXRyeWluZy4gVGhpcyBtYXkgYmVjb21lIGEgc29ydCBvZiBcImRlbnkgbGlzdFwiIG9mIGVycm9yIHR5cGVzIHRvICpub3QqIHJldHJ5IG9uXG4gICAgICAgIC8vIGluIHRoZSBmdXR1cmUsIGJ1dCBmb3Igbm93IHdlIHdpbGwgYmUgYWdncmVzc2l2ZSBhYm91dCByZXRyeWluZy5cbiAgICAgICAgLy8gLy8gc2VydmljZUVycm9yLmNvZGUgPT09IFN0YXR1cy5JTlRFUk5BTCAmJlxuICAgICAgICAvLyAgLy8gc2VydmljZUVycm9yLmRldGFpbHMgPT09IFB1YnN1YkNsaWVudC5SU1RfU1RSRUFNX05PX0VSUk9SX01FU1NBR0U7XG4gICAgICAgIHRydWU7XG5cbiAgICAgIGlmICghdGhpcy5pc0Nvbm5lY3Rpb25Mb3N0KSB7XG4gICAgICAgIHRoaXMuaXNDb25uZWN0aW9uTG9zdCA9IHRydWU7XG4gICAgICAgIG9wdGlvbnMub25Db25uZWN0aW9uTG9zdCgpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBtb21lbnRvRXJyb3IgPSBuZXcgVG9waWNTdWJzY3JpYmUuRXJyb3IoXG4gICAgICAgIHRoaXMuZ2V0Q2FjaGVTZXJ2aWNlRXJyb3JNYXBwZXIoKS5jb252ZXJ0RXJyb3Ioc2VydmljZUVycm9yKVxuICAgICAgKTtcbiAgICAgIHRoaXMuaGFuZGxlU3Vic2NyaWJlRXJyb3IoXG4gICAgICAgIG9wdGlvbnMsXG4gICAgICAgIG1vbWVudG9FcnJvcixcbiAgICAgICAgc2hvdWxkUmVjb25uZWN0U3Vic2NyaXB0aW9uXG4gICAgICApO1xuICAgIH07XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBpbml0aWFsaXplVW5hcnlJbnRlcmNlcHRvcnMoXG4gICAgaGVhZGVyczogSGVhZGVyW10sXG4gICAgY29uZmlndXJhdGlvbjogVG9waWNDb25maWd1cmF0aW9uLFxuICAgIHJlcXVlc3RUaW1lb3V0TXM6IG51bWJlclxuICApOiBJbnRlcmNlcHRvcltdIHtcbiAgICBjb25zdCBtaWRkbGV3YXJlcyA9IGNvbmZpZ3VyYXRpb24uZ2V0TWlkZGxld2FyZXMoKTtcbiAgICBjb25zdCBncm91cE1pZGRsZXdhcmVzID0gKGlzTGF0ZUxvYWQ6IGJvb2xlYW4pID0+XG4gICAgICBtaWRkbGV3YXJlcy5maWx0ZXIoXG4gICAgICAgIG1pZGRsZXdhcmUgPT4gKG1pZGRsZXdhcmUuc2hvdWxkTG9hZExhdGUgPz8gZmFsc2UpID09PSBpc0xhdGVMb2FkXG4gICAgICApO1xuXG4gICAgY29uc3QgY3JlYXRlTWlkZGxld2FyZUludGVyY2VwdG9yID0gKG1pZGRsZXdhcmVHcm91cDogTWlkZGxld2FyZVtdKSA9PlxuICAgICAgbWlkZGxld2FyZXNJbnRlcmNlcHRvcihcbiAgICAgICAgY29uZmlndXJhdGlvbi5nZXRMb2dnZXJGYWN0b3J5KCksXG4gICAgICAgIG1pZGRsZXdhcmVHcm91cCxcbiAgICAgICAge31cbiAgICAgICk7XG5cbiAgICAvLyBTZXBhcmF0ZSBtaWRkbGV3YXJlcyBpbnRvIGltbWVkaWF0ZSBhbmQgbGF0ZS1sb2FkIGdyb3Vwc1xuICAgIGNvbnN0IGltbWVkaWF0ZU1pZGRsZXdhcmVzID0gZ3JvdXBNaWRkbGV3YXJlcyhmYWxzZSk7XG4gICAgY29uc3QgbGF0ZUxvYWRNaWRkbGV3YXJlcyA9IGdyb3VwTWlkZGxld2FyZXModHJ1ZSk7XG5cbiAgICBjb25zdCBpbnRlcmNlcHRvcnM6IEludGVyY2VwdG9yW10gPSBbXG4gICAgICBjcmVhdGVNaWRkbGV3YXJlSW50ZXJjZXB0b3IoaW1tZWRpYXRlTWlkZGxld2FyZXMpLFxuICAgICAgSGVhZGVySW50ZXJjZXB0b3IuY3JlYXRlSGVhZGVyc0ludGVyY2VwdG9yKGhlYWRlcnMpLFxuICAgICAgUmV0cnlJbnRlcmNlcHRvci5jcmVhdGVSZXRyeUludGVyY2VwdG9yKHtcbiAgICAgICAgY2xpZW50TmFtZTogJ1B1YlN1YkNsaWVudCcsXG4gICAgICAgIGxvZ2dlckZhY3Rvcnk6IGNvbmZpZ3VyYXRpb24uZ2V0TG9nZ2VyRmFjdG9yeSgpLFxuICAgICAgICBvdmVyYWxsUmVxdWVzdFRpbWVvdXRNczogcmVxdWVzdFRpbWVvdXRNcyxcbiAgICAgIH0pLFxuICAgIF07XG5cbiAgICBpZiAobGF0ZUxvYWRNaWRkbGV3YXJlcy5sZW5ndGggPiAwKSB7XG4gICAgICBpbnRlcmNlcHRvcnMucHVzaChjcmVhdGVNaWRkbGV3YXJlSW50ZXJjZXB0b3IobGF0ZUxvYWRNaWRkbGV3YXJlcykpO1xuICAgIH1cbiAgICByZXR1cm4gaW50ZXJjZXB0b3JzO1xuICB9XG5cbiAgLy8gVE9ETyBodHRwczovL2dpdGh1Yi5jb20vbW9tZW50b2hxL2NsaWVudC1zZGstbm9kZWpzL2lzc3Vlcy8zNDlcbiAgLy8gZGVjaWRlIG9uIHN0cmVhbWluZyBpbnRlcmNlcHRvcnMgYW5kIG1pZGRsZXdhcmVzXG4gIHByaXZhdGUgc3RhdGljIGluaXRpYWxpemVTdHJlYW1pbmdJbnRlcmNlcHRvcnMoXG4gICAgaGVhZGVyczogSGVhZGVyW10sXG4gICAgY29uZmlndXJhdGlvbjogVG9waWNDb25maWd1cmF0aW9uXG4gICk6IEludGVyY2VwdG9yW10ge1xuICAgIGNvbnN0IG1pZGRsZXdhcmVzID0gY29uZmlndXJhdGlvbi5nZXRNaWRkbGV3YXJlcygpO1xuXG4gICAgY29uc3QgY3JlYXRlTWlkZGxld2FyZUludGVyY2VwdG9yID0gKG1pZGRsZXdhcmVzOiBNaWRkbGV3YXJlW10pID0+XG4gICAgICBtaWRkbGV3YXJlc0ludGVyY2VwdG9yKGNvbmZpZ3VyYXRpb24uZ2V0TG9nZ2VyRmFjdG9yeSgpLCBtaWRkbGV3YXJlcywge30pO1xuXG4gICAgcmV0dXJuIFtcbiAgICAgIGNyZWF0ZU1pZGRsZXdhcmVJbnRlcmNlcHRvcihtaWRkbGV3YXJlcyksXG4gICAgICBIZWFkZXJJbnRlcmNlcHRvci5jcmVhdGVIZWFkZXJzSW50ZXJjZXB0b3IoaGVhZGVycyksXG4gICAgXTtcbiAgfVxufVxuIl19
import{t as Q,C as we,bu as ge,P as T,o as ke,p as Ie,R as be,r as o,c as $,au as Ue,av as q,q as je,H as J,j as r,n as v,E as R,D as ve,h as Ce,k as Se,B as x,l as y,m as Ae,aa as De,b9 as Ne,s as Ee,J as Oe,K as Te,bh as Re,S as We}from"./index-B1XR3Coy.js";import{C as Be}from"./ConfirmDialog-Bksga_et.js";import{r as ze,I as Le}from"./role-BJZr6s4d.js";import{a as $e,A as M}from"./Autocomplete-2B99MXTa.js";import{T as _}from"./TextField-BEeUeVUl.js";import{I as qe}from"./IconCircleCheck-CKqsC1lm.js";import{T as Me}from"./Tooltip-9ICsuaYn.js";const X=Q(we)(({theme:d,chiptype:n})=>{let m,p;switch(n){case"new":m=d.palette.success.light,p=d.palette.success.contrastText;break;case"existing":m=d.palette.primary.main,p=d.palette.primary.contrastText;break;case"already-in-workspace":m=d.palette.grey[300],p=d.palette.text.primary;break;default:m=d.palette.primary.main,p=d.palette.primary.contrastText}return{backgroundColor:m,color:p,"& .MuiChip-deleteIcon":{color:p}}}),F=Q(ge)({boxShadow:"0px 8px 10px -5px rgb(0 0 0 / 20%), 0px 16px 24px 2px rgb(0 0 0 / 14%), 0px 6px 30px 5px rgb(0 0 0 / 12%)",borderRadius:"10px",[`& .${$e.listbox}`]:{boxSizing:"border-box","& ul":{padding:10,margin:10}}}),_e=({show:d,dialogProps:n,onCancel:m,onConfirm:p})=>{const V=document.getElementById("portal"),w=ke();Ie();const C=(...e)=>w(Oe(...e)),S=(...e)=>w(Te(...e)),g=be(e=>e.auth.user),[Y,W]=o.useState(""),[P,H]=o.useState([]),[f,k]=o.useState(),[G,A]=o.useState([]),[ee,B]=o.useState([]),[I,z]=o.useState([]),[u,D]=o.useState([]),[se,te]=o.useState([]),[b,U]=o.useState(""),[L,K]=o.useState(!1),N=$(ze.getAllRolesByOrganizationId),E=$(Ue.getAllWorkspacesByOrganizationId),O=$(q.getWorkspacesByUserId);o.useEffect(()=>{if(E.data){const e=E.data.map(s=>({id:s.id,label:s.name,name:s.name,description:s.description}));if(H(e),n.type==="EDIT"&&n.data&&n.data.isWorkspaceUser){const s=e.find(a=>a.id===n.data.activeWorkspaceId||a.id===n.data.workspaceId);k(s)}}},[E.data]),o.useEffect(()=>{if(N.data){const e=N.data.map(s=>({id:s.id,name:s.name,label:s.name,description:s.description}));if(te(e),n.type==="EDIT"&&n.data&&Array.isArray(n.data.assignedRoles)&&n.data.assignedRoles.length>0){const s=e.find(a=>a.name===n.data.assignedRoles[0].role);s&&U(s)}if(n.type==="EDIT"&&n.data&&n.data.role&&n.data.role.name){const s=e.find(a=>a.name===n.data.role.name);s&&U(s)}}},[N.data]),o.useEffect(()=>{if(O.data){const e=O.data[0],s={id:e.role.id,label:e.role.name,name:e.role.name,description:e.role.description},a={id:e.workspace.id,label:e.workspace.name,name:e.workspace.name,description:e.workspace.description};U(s),k(a)}},[O.data]),o.useEffect(()=>{if(N.request(g.activeOrganizationId),E.request(g.activeOrganizationId),W(""),A([]),D([]),ae(),n.type==="ADD"&&n.data){const e=n.data;k({id:e.id,label:e.name,name:e.name,description:e.description})}else n.type==="ADD"&&!n.data?k(null):n.type==="EDIT"&&n.data&&!n.data.isWorkspaceUser&&O.request(n.data.userId);return()=>{W(""),z([]),B([]),A([]),D([]),H([]),U(null),k(null)}},[n]),o.useEffect(()=>{if(I.length>0&&n.type==="EDIT"&&n.data){const s={...I.find(a=>a.userId===n.data.userId),isNewUser:!1,alreadyInWorkspace:!0};Z(null,[s])}},[I]),o.useEffect(()=>(w(d?{type:je}:{type:J}),()=>w({type:J})),[d,w]);const ae=async()=>{try{const e=await q.getAllUsersByOrganizationId(g.activeOrganizationId);if(e.data){let s=[];if(n.data&&n.type==="ADD"){const t=await q.getAllUsersByWorkspaceId(n.data.id);s=t.data.map(l=>l.userId),B(t.data)}else!n.data&&n.type==="ADD"&&(s=e.data.filter(t=>t.status.toLowerCase()!=="invited").map(t=>t.userId),B(e.data));const a=e.data.filter(t=>t.userId!==g.id&&!t.isOrgOwner&&!s.includes(t.userId));A(()=>a),z(()=>a)}}catch(e){console.error("Error fetching initial user data:",e)}},re=async()=>{var e,s;if(u.length){const a=[];for(const t of ee)u.some(l=>l.email===t.user.email)&&a.push(t.user.email);if(a.length>0){C({message:`The following users are already in the workspace or organization: ${a.join(", ")}`,options:{key:new Date().getTime()+Math.random(),variant:"error",action:t=>r.jsx(v,{style:{color:"white"},onClick:()=>S(t),children:r.jsx(R,{})})}});return}}K(!0);try{if((await Promise.all(u.map(async t=>{const l=t.isNewUser?{user:{email:t.email,createdBy:g.id},workspace:{id:f.id},role:{id:b.id}}:{user:{email:t.user.email,createdBy:g.id},workspace:{id:f.id},role:{id:b.id}};return(await Re.inviteAccount(l)).data}))).length>0)C({message:"Users invited to workspace",options:{key:new Date().getTime()+Math.random(),variant:"success",action:t=>r.jsx(v,{style:{color:"white"},onClick:()=>S(t),children:r.jsx(R,{})})}}),p();else throw new Error("No data received from the server")}catch(a){console.error("Error in saveInvite:",a),C({message:`Failed to invite users to workspace: ${((s=(e=a.response)==null?void 0:e.data)==null?void 0:s.message)||a.message||"Unknown error"}`,options:{key:new Date().getTime()+Math.random(),variant:"error",persist:!0,action:t=>r.jsx(v,{style:{color:"white"},onClick:()=>S(t),children:r.jsx(R,{})})}})}finally{K(!1)}},ne=e=>e.match(/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/),Z=(e,s)=>{const a=s.filter(t=>t.isNewUser?ne(t.email):!0).map(t=>{if(t.isNewUser)return{email:t.email,isNewUser:!0,alreadyInWorkspace:!1};{const l=G.length>0?G.find(c=>c.user.email===t.user.email):u.find(c=>c.user.email===t.user.email);return{...l,isNewUser:!1,alreadyInWorkspace:f?l&&l.workspaceNames&&l.workspaceNames.some(c=>c.id===f.id):!1}}});D(a),a.length<s.length&&C({message:"One or more invalid emails were removed.",options:{key:new Date().getTime()+Math.random(),variant:"warning",action:t=>r.jsx(v,{style:{color:"white"},onClick:()=>S(t),children:r.jsx(R,{})})}})},ie=(e,s)=>{W(s);const a=s.toLowerCase(),t=I.filter(l=>l.user.name.toLowerCase().includes(a)||l.user.email.toLowerCase().includes(a));A(t),z(l=>{const c=[...l];return t.forEach(h=>{c.some(i=>i.user.id===h.user.id)||c.push(h)}),c})},le=(e,{inputValue:s})=>{const a=e.filter(i=>i!=null)??[],t=u.filter(i=>!i.isNewUser&&i.user).map(i=>i.user.email),c=a.filter(i=>!i.user||!t.includes(i.user.email)).filter(i=>i.user&&i.user.name&&i.user.name.toLowerCase().includes(s.toLowerCase())||i.user&&i.user.email&&i.user.email.toLowerCase().includes(s.toLowerCase())),h=/^[^\s@]+@?[^\s@]*$/;if(c.length===0&&h.test(s)){const i=s.includes("@")?s:`${s}@`;if(!u.some(j=>j.isNewUser&&j.email===i||!j.isNewUser&&j.user&&j.user.email===i))return[{name:`Invite ${i}`,email:i,isNewUser:!0}]}return c.length===0?[{name:"No results found",email:"",isNoResult:!0,disabled:!0}]:c},ce=e=>r.jsx(_,{...e,variant:"outlined",placeholder:u.length>0?"":"Invite users by name or email"}),oe=(e,s)=>{const a=s.isNewUser?u.some(t=>t.isNewUser&&t.email===s.email):u.some(t=>{var l;return!t.isNewUser&&t.user&&t.user.email===((l=s.user)==null?void 0:l.email)});return r.jsx("li",{...e,...s.disabled?{style:{pointerEvents:"none",opacity:.5}}:{},children:s.isNoResult?r.jsx(x,{sx:{width:"100%",px:1,py:.5},children:r.jsx(y,{color:"text.secondary",children:"No results found"})}):s.isNewUser?r.jsx(x,{sx:{width:"100%",px:1,py:.5},children:r.jsx(y,{variant:"h5",color:"primary",children:s.name})}):r.jsxs(x,{sx:{width:"100%",display:"flex",alignItems:"center",justifyContent:"space-between",px:1,py:.5},children:[r.jsxs(We,{flexDirection:"column",children:[r.jsx(y,{variant:"h5",children:s.user.name}),r.jsx(y,{children:s.user.email})]}),a?r.jsx(qe,{}):null]})})},de=(e,s)=>u.map((a,t)=>{const l=s({index:t});let c=a.isNewUser?"new":"existing";a.alreadyInWorkspace&&(c="already-in-workspace");const h=a.isNewUser?r.jsx(X,{label:a.name||a.email,...l,chiptype:c}):r.jsx(X,{label:a.user.name||a.user.email,...l,chiptype:c}),i=a.alreadyInWorkspace?`${a.user.name||a.user.email} is already a member of this workspace and won't be invited again.`:a.isNewUser?"An invitation will be sent to this email address":"";return i?r.jsx(Me,{title:i,arrow:!0,children:h},l.key):h}),ue=(e,s)=>{k(s),D(a=>a.map(t=>({...t,alreadyInWorkspace:s?t.workspaceNames&&s&&t.workspaceNames.some(l=>l.id===s.id):!1})))},me=(e,s)=>{U(s)},pe=()=>n.data?f||{}:f||null,fe=()=>n.data&&n.type==="ADD"?b||{}:b||null,he=()=>!!(L||u.length===0||!f||!b),xe=()=>n.data&&n.type==="ADD"?!!f:n.data&&n.type==="EDIT"?n.disableWorkspaceSelection:!1,ye=d?r.jsxs(ve,{fullWidth:!0,maxWidth:"md",open:d,onClose:m,"aria-labelledby":"alert-dialog-title","aria-describedby":"alert-dialog-description",children:[r.jsx(Ce,{sx:{fontSize:"1rem"},id:"alert-dialog-title",children:r.jsxs("div",{style:{display:"flex",flexDirection:"row",alignItems:"center"},children:[r.jsx(Le,{style:{marginRight:"10px"}}),"Invite Users"]})}),r.jsxs(Se,{sx:{display:"flex",flexDirection:"column",gap:2},children:[r.jsxs(x,{children:[r.jsxs(y,{children:["Select Users",r.jsx("span",{style:{color:"red"},children:" *"})]}),r.jsx(M,{multiple:!0,options:I,getOptionKey:e=>e.userId,getOptionLabel:e=>e.email||"",filterOptions:le,onChange:Z,inputValue:Y,onInputChange:ie,isOptionEqualToValue:(e,s)=>{var a,t;return e.isNewUser&&s.isNewUser?e.email===s.email:!e.isNewUser&&!s.isNewUser?((a=e.user)==null?void 0:a.email)===((t=s.user)==null?void 0:t.email):!1},renderInput:ce,renderOption:oe,renderTags:de,sx:{mt:1},value:u,PopperComponent:F})]}),r.jsxs(x,{sx:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:2},children:[r.jsxs(x,{sx:{gridColumn:"span 1"},children:[r.jsxs(y,{children:["Workspace",r.jsx("span",{style:{color:"red"},children:" *"})]}),r.jsx(M,{disabled:xe(),getOptionLabel:e=>e.label||"",onChange:ue,options:P,renderInput:e=>r.jsx(_,{...e,variant:"outlined",placeholder:"Select Workspace"}),sx:{mt:.5},value:pe(),PopperComponent:F})]}),r.jsxs(x,{sx:{gridColumn:"span 1"},children:[r.jsxs(y,{children:["Role to Assign",r.jsx("span",{style:{color:"red"},children:" *"})]}),r.jsx(M,{getOptionLabel:e=>e.label||"",onChange:me,options:se,renderInput:e=>r.jsx(_,{...e,variant:"outlined",placeholder:"Select Role"}),sx:{mt:.5},value:fe(),PopperComponent:F})]})]})]}),r.jsxs(Ae,{sx:{px:3,pb:2},children:[r.jsx(v,{onClick:()=>m(),disabled:L,children:n.cancelButtonName}),r.jsx(De,{disabled:he(),variant:"contained",onClick:re,startIcon:L?r.jsx(Ne,{size:20,color:"inherit"}):null,children:n.confirmButtonName})]}),r.jsx(Be,{})]}):null;return Ee.createPortal(ye,V)};_e.propTypes={show:T.bool,dialogProps:T.object,onCancel:T.func,onConfirm:T.func};export{_e as I};

import{t as V,bu as k,P as r,R as q,a as H,r as c,bI as K,j as n,B as F,b9 as Q,l as $,bJ as U,d as _,bK as G,bL as z,Q as X,a8 as Y}from"./index-B1XR3Coy.js";import{c as M,A as Z,C as ee}from"./CredentialListDialog-ooDI7A-3.js";import{a as te,A as se}from"./Autocomplete-2B99MXTa.js";import{T as ne}from"./TextField-BEeUeVUl.js";import{T as oe}from"./Tooltip-9ICsuaYn.js";import{I as ie}from"./IconSearch-BzBgax5m.js";const ae=V(k)({boxShadow:"0px 8px 10px -5px rgb(0 0 0 / 20%), 0px 16px 24px 2px rgb(0 0 0 / 14%), 0px 6px 30px 5px rgb(0 0 0 / 12%)",borderRadius:"10px",[`& .${te.listbox}`]:{boxSizing:"border-box","& ul":{padding:10,margin:10}}}),re=async({name:l,nodeData:t,previousNodes:y,currentNode:S})=>{var w,p,x;const m=t.inputParams.find(f=>f.name===l),h=m==null?void 0:m.loadMethod;let u=t.credential;!u&&((w=t.inputs)!=null&&w.credential||(p=t.inputs)!=null&&p.FLOWISE_CREDENTIAL_ID)&&(u=t.inputs.credential||((x=t.inputs)==null?void 0:x.FLOWISE_CREDENTIAL_ID));let j={headers:{"x-request-from":"internal","Content-type":"application/json"},withCredentials:!0};return await G.post(`${_}/api/v1/node-load-method/${t.name}`,{...t,loadMethod:h,previousNodes:y,currentNode:S,credential:u},j).then(async function(f){return f.data}).catch(function(f){console.error(f)})},W=({name:l,nodeData:t,value:y,onSelect:S,isCreateNewOption:m,onCreateNew:h,credentialNames:u=[],disabled:j=!1,freeSolo:N=!1,disableClearable:w=!1,multiple:p=!1,fullWidth:x=!1})=>{const f=q(i=>i.customization),v=H(),[I,P]=c.useState(!1),[A,E]=c.useState([]),[L,T]=c.useState(!1),O=(i=[],e)=>{if(p){let o=[];return e!=="choose an option"&&e&&typeof e=="string"?o=JSON.parse(e):o=e,i.filter(s=>o.includes(s.name))}return i.find(o=>o.name===e)},B=()=>p?[]:"",a=[{label:"- Create New -",name:"-create-"}];let[d,D]=c.useState(y??"choose an option");const{reactFlowInstance:R}=c.useContext(K),J=async()=>{try{let i="";u.length>1?i=u.join("&credentialName="):i=u[0];const e=await M.getCredentialsByName(i);if(e.data){const o=[];for(let s=0;s<e.data.length;s+=1){const C={label:e.data[s].name,name:e.data[s].id};o.push(C)}return o}}catch(i){console.error(i)}};return c.useEffect(()=>{T(!0),(async()=>(async()=>{var o;let e=[];if(u.length)e=await J();else{const s={name:l,nodeData:t};if(R){const C=U(R.getNodes(),R.getEdges(),t.id,`${t.id}-input-${l}-${((o=t.inputParams.find(g=>g.name===l))==null?void 0:o.type)||""}`,!0).map(g=>({id:g.id,name:g.data.name,label:g.data.label,inputs:g.data.inputs}));let b=R.getNodes().find(g=>g.id===t.id);b&&(b={id:b.id,name:b.data.name,label:b.data.label,inputs:b.data.inputs},s.currentNode=b),s.previousNodes=C}e=await re(s)}for(let s=0;s<e.length;s+=1)if(e[s].imageSrc){const C=`${_}/api/v1/node-icon/${e[s].name}`;e[s].imageSrc=C}E(m?[...e,...a]:[...e]),T(!1)})())()},[]),n.jsx(n.Fragment,{children:n.jsx(se,{id:l,freeSolo:N,disabled:j,disableClearable:w,multiple:p,filterSelectedOptions:p,size:"small",sx:{mt:1,width:x?"100%":p?"90%":"100%"},open:I,onOpen:()=>{P(!0)},onClose:()=>{P(!1)},options:A,value:O(A,d)||B(),onChange:(i,e)=>{if(p){let o="";if(e.length){const s=e.map(C=>C.name);o=JSON.stringify(s)}D(o),S(o)}else{const o=e?e.name:"";m&&o==="-create-"?h():(D(o),S(o))}},PopperComponent:ae,loading:L,renderInput:i=>{const e=p?O(A,d):[O(A,d)].filter(Boolean),o=n.jsx(ne,{...i,value:d,sx:{height:"100%","& .MuiInputBase-root":{height:"100%","& fieldset":{borderColor:v.palette.grey[900]+25}}},InputProps:{...i.InputProps,startAdornment:n.jsxs(n.Fragment,{children:[e.map(s=>s!=null&&s.imageSrc?n.jsx(F,{component:"img",src:s.imageSrc,alt:s.label||"Selected Option",sx:{width:32,height:32,borderRadius:"50%",marginRight:.5}},s.name):null),i.InputProps.startAdornment]}),endAdornment:n.jsxs(c.Fragment,{children:[L?n.jsx(Q,{color:"inherit",size:20}):null,i.InputProps.endAdornment]})}});return p?n.jsx(oe,{title:typeof d=="string"?d.replace(/[[\]"]/g,"").replace(/,/g,", "):d,placement:"top",arrow:!0,children:o}):o},renderOption:(i,e)=>n.jsxs(F,{component:"li",...i,sx:{display:"flex",alignItems:"center",gap:1},children:[e.imageSrc&&n.jsx("img",{src:e.imageSrc,alt:e.description,style:{width:30,height:30,padding:1,borderRadius:"50%"}}),n.jsxs("div",{style:{display:"flex",flexDirection:"column"},children:[n.jsx($,{variant:"h5",children:e.label}),e.description&&n.jsx($,{sx:{color:f.isDarkMode?"#9e9e9e":""},children:e.description})]})]})})})};W.propTypes={name:r.string,nodeData:r.object,value:r.string,onSelect:r.func,onCreateNew:r.func,disabled:r.bool,freeSolo:r.bool,credentialNames:r.array,disableClearable:r.bool,isCreateNewOption:r.bool,multiple:r.bool,fullWidth:r.bool};const le=({inputParam:l,data:t,onSelect:y,disabled:S=!1})=>{const m=c.useRef(null),[h,u]=c.useState((t==null?void 0:t.credential)||(t==null?void 0:t.inputs)&&t.inputs[z]||""),[j,N]=c.useState(!1),[w,p]=c.useState({}),[x,f]=c.useState(!1),[v,I]=c.useState({}),[P,A]=c.useState(Date.now().toString()),{hasPermission:E}=X(),L=a=>{I({type:"EDIT",cancelButtonName:"Cancel",confirmButtonName:"Save",credentialId:a}),f(!0)},T=async()=>{try{let a="";l.credentialNames.length>1?a=l.credentialNames.join("&"):a=l.credentialNames[0];const d=await M.getSpecificComponentCredential(a);if(d.data)if(Array.isArray(d.data)){const D={title:"Add New Credential",componentsCredentials:d.data};p(D),N(!0)}else{const D={type:"ADD",cancelButtonName:"Cancel",confirmButtonName:"Add",credentialComponent:d.data};I(D),f(!0)}}catch(a){console.error(a)}},O=(a="")=>{u(a),A(Date.now().toString()),I({}),f(!1),y(a)},B=a=>{N(!1),I({type:"ADD",cancelButtonName:"Cancel",confirmButtonName:"Add",credentialComponent:a}),f(!0)};return c.useEffect(()=>{u((t==null?void 0:t.credential)||(t==null?void 0:t.inputs)&&t.inputs[z]||"")},[t]),n.jsxs("div",{ref:m,children:[l&&n.jsx(n.Fragment,{children:l.type==="credential"&&n.jsxs("div",{style:{display:"flex",flexDirection:"row"},children:[n.jsx(W,{disabled:S,name:l.name,nodeData:t,value:h??"choose an option",isCreateNewOption:E("credentials:create"),credentialNames:l.credentialNames,onSelect:a=>{u(a),y(a)},onCreateNew:()=>T(l.name)}),h&&E("credentials:update")&&n.jsx(Y,{title:"Edit",color:"primary",size:"small",onClick:()=>L(h),children:n.jsx(ie,{})})]},P)}),x&&n.jsx(Z,{show:x,dialogProps:v,onCancel:()=>f(!1),onConfirm:O}),j&&n.jsx(ee,{show:j,dialogProps:w,onCancel:()=>N(!1),onCredentialSelected:B})]})};le.propTypes={inputParam:r.object,data:r.object,onSelect:r.func,disabled:r.bool};export{W as A,le as C};

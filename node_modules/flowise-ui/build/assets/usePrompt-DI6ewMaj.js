import{af as Re,r,j as e,aB as Ks,P as u,o as qe,R as Ie,a as Oe,c as Pe,p as jt,q as Xs,H as xt,D as Je,h as nt,k as Ye,n as Z,S as Ee,B as q,U as Rn,V as Yt,W as Nn,X as Pn,O as Wt,L as he,a3 as Qs,Y as Un,m as ot,s as wt,a8 as pe,ae as On,d as Ce,l as ne,E as fe,J as rt,K as it,u as Ln,al as zn,an as Ne,ao as We,a6 as Os,d1 as Zs,ap as Hn,F as Lt,G as $n,bI as Kt,bc as Bn,a1 as Ue,aq as re,ar as Wn,as as Ls,bb as Xt,d2 as Gn,bu as ea,cF as ta,c6 as sa,M as aa,cv as qn,z as at,bN as _n,aA as Vn,C as Fe,a4 as Jn,A as Qt,aa as na,ag as Ge,ah as zs,cB as oa,t as _e,w as Yn,cR as Kn,bL as Xn,d3 as Qn,b4 as Zt,d4 as et,d5 as gt,b9 as zt,ba as Zn,cC as Hs,cD as $s,ch as eo,bK as to,d6 as so,d7 as ao}from"./index-B1XR3Coy.js";import{S as no,A as oo,V as ro,a as io,C as lo,L as co,I as uo,e as Gt,u as po,f as mt,g as ho,m as fo,h as go,l as mo,i as xo}from"./index-BmqHKIDU.js";import{S as yo}from"./SaveChatflowDialog-C2LCggZV.js";import{e as Bs}from"./react-datepicker-CbT3l_H_.js";import{m as bo}from"./moment-9Y6NtRWJ.js";import{d as es}from"./ExpandMore-BP5oMSwT.js";import{T as jo}from"./Table-CcAGPqUI.js";import{T as pt}from"./TooltipWithParser-C72LCUcD.js";import{v as qt,H as wo}from"./vectorstore-BUOpP3fi.js";import{I as yt}from"./IconTrash-BvhWIQ6v.js";import{I as ko,a as vo}from"./IconChevronsUp-iPfKij1q.js";import{A as ts,d as ss,e as as,M as _t,f as Co,I as Io}from"./MemoizedReactMarkdown-CNH2mkE4.js";import{E as So}from"./ExportAsTemplateDialog-CN3tapJC.js";import{c as tt}from"./chatflows-ITLPd47E.js";import{I as Do}from"./IconChevronLeft-Dkfa8829.js";import{I as Ao}from"./NodeInfoDialog-BBny0-Sx.js";import{T as ra}from"./TextField-BEeUeVUl.js";import{I as To}from"./ToolDialog-hiXiaWJY.js";import{I as Mo}from"./IconDeviceFloppy-CcMo-Sl3.js";import{S as st}from"./StyledFab-BqTal21_.js";import{D as Eo}from"./Dropdown-BH_BuIwh.js";import{a as Fo}from"./assistants-C-o7l-z6.js";import{D as Ro,N as No,a as Vt}from"./DocStoreInputHandler-9-EYgHTZ.js";import{L as Po}from"./LoadingButton-BHZSG_sF.js";import{a as Uo,b as Oo}from"./IconSearch-BzBgax5m.js";import{L as Lo}from"./llamaindex-B_JSDULd.js";import{I as zo}from"./IconPlus-DpyX5kZB.js";import{I as Me}from"./InputAdornment-D6_duzKN.js";import{T as Ho}from"./Tabs-DwCJa_eq.js";import{L as $o}from"./ListItem-C9nlU6HX.js";import{L as Ws,r as Bo}from"./Input-C2v4FwXn.js";import{T as Wo,b as Go,u as qo,c as _o,f as Vo,g as Jo,h as Yo,i as Ko,j as Xo,k as Qo,N as Zo,d as er,a as tr,R as sr,e as ar,p as nr}from"./NodeExecutionDetails-DAbNicF8.js";import{I as or,d as rr}from"./StopCircle-i-Eq3mUR.js";import{I as ia}from"./IconArrowsMaximize-BrsSDZNx.js";import{I as ir}from"./IconCircleXFilled-eMwzVwFM.js";import{v as lr}from"./v4-D8aEg3BZ.js";import{C as Ht}from"./CardMedia-DxratGiC.js";import{u as cr}from"./ConfirmDialog-Bksga_et.js";/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var dr=Re("outline","circle-dot","IconCircleDot",[["path",{d:"M12 12m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0",key:"svg-0"}],["path",{d:"M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0",key:"svg-1"}]]);/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var ur=Re("outline","microphone","IconMicrophone",[["path",{d:"M9 2m0 3a3 3 0 0 1 3 -3h0a3 3 0 0 1 3 3v5a3 3 0 0 1 -3 3h0a3 3 0 0 1 -3 -3z",key:"svg-0"}],["path",{d:"M5 10a7 7 0 0 0 14 0",key:"svg-1"}],["path",{d:"M8 21l8 0",key:"svg-2"}],["path",{d:"M12 17l0 4",key:"svg-3"}]]);/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var pr=Re("outline","minus","IconMinus",[["path",{d:"M5 12l14 0",key:"svg-0"}]]);/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var Gs=Re("outline","photo-plus","IconPhotoPlus",[["path",{d:"M15 8h.01",key:"svg-0"}],["path",{d:"M12.5 21h-6.5a3 3 0 0 1 -3 -3v-12a3 3 0 0 1 3 -3h12a3 3 0 0 1 3 3v6.5",key:"svg-1"}],["path",{d:"M3 16l5 -5c.928 -.893 2.072 -.893 3 0l4 4",key:"svg-2"}],["path",{d:"M14 14l1 -1c.67 -.644 1.45 -.824 2.182 -.54",key:"svg-3"}],["path",{d:"M16 19h6",key:"svg-4"}],["path",{d:"M19 16v6",key:"svg-5"}]]);/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var Li=Re("outline","refresh-alert","IconRefreshAlert",[["path",{d:"M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4",key:"svg-0"}],["path",{d:"M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4",key:"svg-1"}],["path",{d:"M12 9l0 3",key:"svg-2"}],["path",{d:"M12 15l.01 0",key:"svg-3"}]]);/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var $t=Re("outline","send","IconSend",[["path",{d:"M10 14l11 -11",key:"svg-0"}],["path",{d:"M21 3l-6.5 18a.55 .55 0 0 1 -1 0l-3.5 -7l-7 -3.5a.55 .55 0 0 1 0 -1l18 -6.5",key:"svg-1"}]]);/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var hr=Re("outline","thumb-down","IconThumbDown",[["path",{d:"M7 13v-8a1 1 0 0 0 -1 -1h-2a1 1 0 0 0 -1 1v7a1 1 0 0 0 1 1h3a4 4 0 0 1 4 4v1a2 2 0 0 0 4 0v-5h3a2 2 0 0 0 2 -2l-1 -5a2 3 0 0 0 -2 -2h-7a3 3 0 0 0 -3 3",key:"svg-0"}]]);/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var fr=Re("outline","thumb-up","IconThumbUp",[["path",{d:"M7 11v8a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1v-7a1 1 0 0 1 1 -1h3a4 4 0 0 0 4 -4v-1a2 2 0 0 1 4 0v5h3a2 2 0 0 1 2 2l-1 5a2 3 0 0 1 -2 2h-7a3 3 0 0 1 -3 -3",key:"svg-0"}]]);/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var gr=Re("filled","square-filled","IconSquareFilled",[["path",{d:"M19 2h-14a3 3 0 0 0 -3 3v14a3 3 0 0 0 3 3h14a3 3 0 0 0 3 -3v-14a3 3 0 0 0 -3 -3z",key:"svg-0"}]]);const Jt=r.forwardRef(function({value:n,onClick:c},f){return e.jsx(Ks,{style:{borderRadius:15,border:"1px solid #e0e0e0"},onClick:c,ref:f,children:n})});Jt.propTypes={value:u.string,onClick:u.func};function la(s){var m,D,C,O;const[n,c]=r.useState(!1),[f,h]=r.useState({}),b=P=>(H,T)=>{const L={...f};L[P]=T,h(L)},d=s.selected.indexOf(s.upsertHistory.id)!==-1;return e.jsxs(e.Fragment,{children:[e.jsxs(Wt,{sx:{"&:last-child td, &:last-child th":{border:0}},children:[e.jsx(he,{padding:"checkbox",children:e.jsx(Qs,{color:"primary",checked:d,onChange:P=>s.handleSelect(P,s.upsertHistory.id),inputProps:{"aria-labelledby":s.upsertHistory.id}})}),e.jsx(he,{children:bo(s.upsertHistory.date).format("MMMM Do YYYY, h:mm:ss a")}),e.jsx(he,{children:((m=s.upsertHistory.result)==null?void 0:m.numAdded)??"0"}),e.jsx(he,{children:((D=s.upsertHistory.result)==null?void 0:D.numUpdated)??"0"}),e.jsx(he,{children:((C=s.upsertHistory.result)==null?void 0:C.numSkipped)??"0"}),e.jsx(he,{children:((O=s.upsertHistory.result)==null?void 0:O.numDeleted)??"0"}),e.jsx(he,{children:e.jsx(pe,{"aria-label":"expand row",size:"small",color:"inherit",onClick:()=>c(!n),children:n?e.jsx(ko,{}):e.jsx(vo,{})})})]}),n&&e.jsx(Wt,{sx:{"& td":{border:0}},children:e.jsx(he,{sx:{pb:0,pt:0},colSpan:6,children:e.jsx(On,{in:n,timeout:"auto",unmountOnExit:!0,children:e.jsx(q,{sx:{mt:1,mb:2},children:(s.upsertHistory.flowData??[]).map((P,H)=>e.jsxs(ts,{expanded:f[P.id]||!1,onChange:b(P.id),disableGutters:!0,children:[e.jsx(ss,{expandIcon:e.jsx(es,{}),"aria-controls":`nodes-accordian-${P.name}`,id:`nodes-accordian-header-${P.name}`,children:e.jsxs("div",{style:{display:"flex",flexDirection:"row",alignItems:"center"},children:[e.jsx("div",{style:{width:40,height:40,marginRight:10,borderRadius:"50%",backgroundColor:"white"},children:e.jsx("img",{style:{width:"100%",height:"100%",padding:7,borderRadius:"50%",objectFit:"contain"},alt:P.name,src:`${Ce}/api/v1/node-icon/${P.name}`})}),e.jsx(ne,{variant:"h5",children:P.label}),e.jsx("div",{style:{display:"flex",flexDirection:"row",width:"max-content",borderRadius:15,background:"rgb(254,252,191)",padding:5,paddingLeft:10,paddingRight:10,marginLeft:10},children:e.jsx("span",{style:{color:"rgb(116,66,16)",fontSize:"0.825rem"},children:P.id})})]})}),e.jsx(as,{children:P.paramValues[0]&&e.jsx(jo,{sx:{minWidth:150},rows:P.paramValues,columns:Object.keys(P.paramValues[0])})})]},H))})})})})]})}la.propTypes={upsertHistory:u.object,theme:u.any,isDarkMode:u.bool,selected:u.array,handleSelect:u.func};const ca=({show:s,dialogProps:n,onCancel:c})=>{const f=document.getElementById("portal"),h=qe(),b=Ie(p=>p.customization),d=Oe(),m=Pe(qt.getUpsertHistory);jt();const D=(...p)=>h(rt(...p)),C=(...p)=>h(it(...p)),[O,P]=r.useState([]),[H,T]=r.useState(new Date(new Date().setMonth(new Date().getMonth()-1))),[L,_]=r.useState(new Date),[y,j]=r.useState([]),S=p=>{if(p.target.checked){const k=O.map(M=>M.id);j(k);return}j([])},I=p=>{const k=new Date(p);k.setHours(0,0,0,0),T(k),m.request(n.chatflow.id,{startDate:k,endDate:L})},K=p=>{const k=new Date(p);k.setHours(23,59,59,999),_(k),m.request(n.chatflow.id,{endDate:k,startDate:H})},W=(p,k)=>{const M=y.indexOf(k);let R=[];M===-1?R=R.concat(y,k):M===0?R=R.concat(y.slice(1)):M===y.length-1?R=R.concat(y.slice(0,-1)):M>0&&(R=R.concat(y.slice(0,M),y.slice(M+1))),j(R)},ee=async()=>{try{await qt.deleteUpsertHistory(y),D({message:"Succesfully deleted upsert history",options:{key:new Date().getTime()+Math.random(),variant:"success",action:p=>e.jsx(Z,{style:{color:"white"},onClick:()=>C(p),children:e.jsx(fe,{})})}}),P(O.filter(p=>!y.includes(p.id))),j([])}catch(p){D({message:`Failed to delete Upsert History: ${typeof p.response.data=="object"?p.response.data.message:p.response.data}`,options:{key:new Date().getTime()+Math.random(),variant:"error",persist:!0,action:k=>e.jsx(Z,{style:{color:"white"},onClick:()=>C(k),children:e.jsx(fe,{})})}}),j([])}};r.useEffect(()=>{m.data&&P(m.data)},[m.data]),r.useEffect(()=>(n.chatflow&&m.request(n.chatflow.id),()=>{P([]),T(new Date(new Date().setMonth(new Date().getMonth()-1))),_(new Date)}),[n]),r.useEffect(()=>(h(s?{type:Xs}:{type:xt}),()=>h({type:xt})),[s,h]);const x=s?e.jsxs(Je,{onClose:c,open:s,fullWidth:!0,maxWidth:"lg","aria-labelledby":"upsert-history-dialog-title","aria-describedby":"upsert-history-dialog-description",children:[e.jsx(nt,{sx:{fontSize:"1rem"},id:"upsert-history-dialog-title",children:n.title}),e.jsx(Ye,{children:e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{display:"flex",flexDirection:"row",alignItems:"center",width:"100%",marginBottom:10},children:[e.jsxs("div",{style:{marginRight:10},children:[e.jsx("b",{style:{marginRight:10},children:"From Date"}),e.jsx(Bs,{selected:H,onChange:p=>I(p),selectsStart:!0,startDate:H,endDate:L,customInput:e.jsx(Jt,{})})]}),e.jsxs("div",{style:{marginRight:10},children:[e.jsx("b",{style:{marginRight:10},children:"To Date"}),e.jsx(Bs,{selected:L,onChange:p=>K(p),selectsEnd:!0,startDate:H,endDate:L,minDate:H,maxDate:new Date,customInput:e.jsx(Jt,{})})]})]}),y.length>0&&e.jsxs(Z,{sx:{mt:1,mb:2},variant:"outlined",onClick:ee,color:"error",startIcon:e.jsx(yt,{}),children:["Delete ",y.length," ",y.length===1?"row":"rows"]}),O.length<=0&&e.jsxs(Ee,{sx:{alignItems:"center",justifyContent:"center"},flexDirection:"column",children:[e.jsx(q,{sx:{p:7,height:"auto"},children:e.jsx("img",{style:{objectFit:"cover",height:"20vh",width:"auto"},src:wo,alt:"HistoryEmptySVG"})}),e.jsx("div",{children:"No Upsert History Yet"})]}),O.length>0&&e.jsx(Rn,{component:Yt,children:e.jsxs(Nn,{sx:{minWidth:650},"aria-label":"simple table",children:[e.jsx(Pn,{children:e.jsxs(Wt,{children:[e.jsx(he,{padding:"checkbox",children:e.jsx(Qs,{color:"primary",checked:y.length===O.length,onChange:S,inputProps:{"aria-label":"select all"}})}),e.jsx(he,{children:"Date"}),e.jsxs(he,{children:["Added"," ",e.jsx(pt,{style:{marginBottom:2,marginLeft:10},title:"Number of vector embeddings added to Vector Store"})]}),e.jsxs(he,{children:["Updated"," ",e.jsx(pt,{style:{marginBottom:2,marginLeft:10},title:"Updated existing vector embeddings. Only works when a Record Manager is connected to the Vector Store"})]}),e.jsxs(he,{children:["Skipped"," ",e.jsx(pt,{style:{marginBottom:2,marginLeft:10},title:"Number of same vector embeddings that exists, and were skipped re-upserting again. Only works when a Record Manager is connected to the Vector Store"})]}),e.jsxs(he,{children:["Deleted"," ",e.jsx(pt,{style:{marginBottom:2,marginLeft:10},title:"Deleted vector embeddings. Only works when a Record Manager with a Cleanup method is connected to the Vector Store"})]}),e.jsx(he,{children:"Details"})]})}),e.jsx(Un,{children:O.map((p,k)=>e.jsx(la,{upsertHistory:p,theme:d,isDarkMode:b.isDarkMode,selected:y,handleSelect:W},k))})]})})]})}),e.jsx(ot,{children:e.jsx(Z,{onClick:c,children:"Close"})})]}):null;return wt.createPortal(x,f)};ca.propTypes={show:u.bool,dialogProps:u.object,onCancel:u.func};const mr=({chatflow:s,isAgentCanvas:n,isAgentflowV2:c,handleSaveFlow:f,handleDeleteFlow:h,handleLoadFlow:b})=>{const d=Oe(),m=qe(),D=Ln(),C=r.useRef(),O=r.useRef(),[P,H]=r.useState(null),[T,L]=r.useState(""),[_,y]=r.useState(!1),[j,S]=r.useState(!1),[I,K]=r.useState(!1),[W,ee]=r.useState({}),[x,p]=r.useState(!1),[k,M]=r.useState({}),[R,z]=r.useState(!1),[w,U]=r.useState({}),[B,V]=r.useState(!1),[ce,Se]=r.useState({}),[De,we]=r.useState(!1),[oe,ye]=r.useState({}),[ge,ke]=r.useState(!1),[Ae,E]=r.useState({}),v=(...Y)=>m(rt(...Y)),N=(...Y)=>m(it(...Y)),[G,se]=r.useState(n?"agentflows:create":"chatflows:create"),$=n?"Agents":"Chatflow",X=Pe(tt.updateChatflow),J=Ie(Y=>Y.canvas),de=Y=>{if(y(!1),Y==="deleteChatflow")h();else if(Y==="viewMessages")M({title:"View Messages",chatflow:s,isChatflow:!c}),p(!0);else if(Y==="viewLeads")U({title:"View Leads",chatflow:s}),z(!0);else if(Y==="saveAsTemplate"){if(J.isDirty){v({message:"Please save the flow before exporting as template",options:{key:new Date().getTime()+Math.random(),variant:"error",persist:!0,action:te=>e.jsx(Z,{style:{color:"white"},onClick:()=>N(te),children:e.jsx(fe,{})})}});return}E({title:"Export As Template",chatflow:s}),ke(!0)}else if(Y==="viewUpsertHistory")Se({title:"View Upsert History",chatflow:s}),V(!0);else if(Y==="chatflowConfiguration")ye({title:`${$} Configuration`,chatflow:s}),we(!0);else if(Y==="duplicateChatflow")try{let te=s.flowData;const be=JSON.parse(te);te=JSON.stringify(be),localStorage.setItem("duplicatedFlowData",te),c?window.open(`${Lt}/v2/agentcanvas`,"_blank"):n?window.open(`${Lt}/agentcanvas`,"_blank"):window.open(`${Lt}/canvas`,"_blank")}catch(te){console.error(te)}else if(Y==="exportChatflow")try{const te=JSON.parse(s.flowData);let be=JSON.stringify($n(te),null,2);const Te=new Blob([be],{type:"application/json"}),Le=URL.createObjectURL(Te);let xe=`${s.name} ${$}.json`,ze=document.createElement("a");ze.setAttribute("href",Le),ze.setAttribute("download",xe),ze.click()}catch(te){console.error(te)}},Ke=Y=>{y(!1),b(Y)},lt=()=>{if(s.id){const Y={name:C.current.value};X.request(s.id,Y)}},kt=()=>{let Y=!1;try{const Te=JSON.parse(s.flowData).nodes;for(const Le of Te)if(Le.data.inputParams.find(xe=>xe.type==="file")){Y=!0;break}}catch(be){console.error(be)}let te=!1;try{const Te=JSON.parse(s.flowData).nodes;for(const Le of Te)if(Le.data.inputParams.find(xe=>xe.name==="sessionId")){te=!0;break}}catch(be){console.error(be)}ee({title:"Embed in website or use as API",chatflowid:s.id,chatflowApiKeyId:s.apikeyid,isFormDataRequired:Y,isSessionMemory:te,isAgentCanvas:n,isAgentflowV2:c}),K(!0)},Xe=()=>{s.id?f(T):S(!0)},vt=Y=>{S(!1),se(n?"agentflows:update":"chatflows:update"),f(Y)};return r.useEffect(()=>{X.data&&(L(X.data.name),se(n?"agentflows:update":"chatflows:update"),m({type:zn,chatflow:X.data})),H(!1)},[X.data]),r.useEffect(()=>{s&&(L(s.name),De&&ye({title:`${$} Configuration`,chatflow:s}))},[s,$,De]),e.jsxs(e.Fragment,{children:[e.jsxs(Ee,{flexDirection:"row",justifyContent:"space-between",sx:{width:"100%"},children:[e.jsxs(Ee,{flexDirection:"row",sx:{width:"100%",maxWidth:"50%"},children:[e.jsx(q,{children:e.jsx(Ne,{title:"Back",sx:{borderRadius:"50%"},children:e.jsx(We,{variant:"rounded",sx:{...d.typography.commonAvatar,...d.typography.mediumAvatar,transition:"all .2s ease-in-out",background:d.palette.secondary.light,color:d.palette.secondary.dark,"&:hover":{background:d.palette.secondary.dark,color:d.palette.secondary.light}},color:"inherit",onClick:()=>{window.history.state&&window.history.state.idx>0?D(-1):D("/",{replace:!0})},children:e.jsx(Do,{stroke:1.5,size:"1.3rem"})})})}),e.jsx(q,{sx:{width:"100%"},children:P?e.jsxs(Ee,{flexDirection:"row",sx:{width:"100%"},children:[e.jsx(ra,{autoFocus:!0,size:"small",inputRef:C,sx:{width:"100%",ml:2},defaultValue:T,onKeyDown:Y=>{Y.key==="Enter"?lt():Y.key==="Escape"&&H(!1)}}),e.jsx(Ne,{title:"Save Name",sx:{borderRadius:"50%"},children:e.jsx(We,{variant:"rounded",sx:{...d.typography.commonAvatar,...d.typography.mediumAvatar,transition:"all .2s ease-in-out",background:d.palette.success.light,color:d.palette.success.dark,ml:1,"&:hover":{background:d.palette.success.dark,color:d.palette.success.light}},color:"inherit",onClick:lt,children:e.jsx(Zs,{stroke:1.5,size:"1.3rem"})})}),e.jsx(Ne,{title:"Cancel",sx:{borderRadius:"50%"},children:e.jsx(We,{variant:"rounded",sx:{...d.typography.commonAvatar,...d.typography.mediumAvatar,transition:"all .2s ease-in-out",background:d.palette.error.light,color:d.palette.error.dark,ml:1,"&:hover":{background:d.palette.error.dark,color:d.palette.error.light}},color:"inherit",onClick:()=>H(!1),children:e.jsx(fe,{stroke:1.5,size:"1.3rem"})})})]}):e.jsxs(Ee,{flexDirection:"row",children:[e.jsxs(ne,{sx:{fontSize:"1.5rem",fontWeight:600,ml:2,textOverflow:"ellipsis",overflow:"hidden",whiteSpace:"nowrap"},children:[J.isDirty&&e.jsx("strong",{style:{color:d.palette.orange.main},children:"*"})," ",T]}),(s==null?void 0:s.id)&&e.jsx(Os,{permission:G,children:e.jsx(Ne,{title:"Edit Name",sx:{borderRadius:"50%"},children:e.jsx(We,{variant:"rounded",sx:{...d.typography.commonAvatar,...d.typography.mediumAvatar,transition:"all .2s ease-in-out",ml:1,background:d.palette.secondary.light,color:d.palette.secondary.dark,"&:hover":{background:d.palette.secondary.dark,color:d.palette.secondary.light}},color:"inherit",onClick:()=>H(!0),children:e.jsx(Ao,{stroke:1.5,size:"1.3rem"})})})})]})})]}),e.jsxs(q,{children:[(s==null?void 0:s.id)&&e.jsx(Ne,{title:"API Endpoint",sx:{borderRadius:"50%",mr:2},children:e.jsx(We,{variant:"rounded",sx:{...d.typography.commonAvatar,...d.typography.mediumAvatar,transition:"all .2s ease-in-out",background:d.palette.canvasHeader.deployLight,color:d.palette.canvasHeader.deployDark,"&:hover":{background:d.palette.canvasHeader.deployDark,color:d.palette.canvasHeader.deployLight}},color:"inherit",onClick:kt,children:e.jsx(To,{stroke:1.5,size:"1.3rem"})})}),e.jsx(Os,{permission:G,children:e.jsx(Ne,{title:`Save ${$}`,sx:{borderRadius:"50%",mr:2},children:e.jsx(We,{variant:"rounded",sx:{...d.typography.commonAvatar,...d.typography.mediumAvatar,transition:"all .2s ease-in-out",background:d.palette.canvasHeader.saveLight,color:d.palette.canvasHeader.saveDark,"&:hover":{background:d.palette.canvasHeader.saveDark,color:d.palette.canvasHeader.saveLight}},color:"inherit",onClick:Xe,children:e.jsx(Mo,{stroke:1.5,size:"1.3rem"})})})}),e.jsx(Ne,{ref:O,title:"Settings",sx:{borderRadius:"50%"},children:e.jsx(We,{variant:"rounded",sx:{...d.typography.commonAvatar,...d.typography.mediumAvatar,transition:"all .2s ease-in-out",background:d.palette.canvasHeader.settingsLight,color:d.palette.canvasHeader.settingsDark,"&:hover":{background:d.palette.canvasHeader.settingsDark,color:d.palette.canvasHeader.settingsLight}},onClick:()=>y(!_),children:e.jsx(Hn,{stroke:1.5,size:"1.3rem"})})})]})]}),e.jsx(no,{chatflow:s,isSettingsOpen:_,anchorEl:O.current,onClose:()=>y(!1),onSettingsItemClick:de,onUploadFile:Ke,isAgentCanvas:n}),e.jsx(yo,{show:j,dialogProps:{title:`Save New ${$}`,confirmButtonName:"Save",cancelButtonName:"Cancel"},onCancel:()=>S(!1),onConfirm:vt}),I&&e.jsx(oo,{show:I,dialogProps:W,onCancel:()=>K(!1)}),e.jsx(ro,{show:x,dialogProps:k,onCancel:()=>p(!1)}),e.jsx(io,{show:R,dialogProps:w,onCancel:()=>z(!1)}),ge&&e.jsx(So,{show:ge,dialogProps:Ae,onCancel:()=>ke(!1)}),e.jsx(ca,{show:B,dialogProps:ce,onCancel:()=>V(!1)}),e.jsx(lo,{show:De,dialogProps:oe,onCancel:()=>we(!1),isAgentCanvas:n},"chatflowConfiguration")]})};mr.propTypes={chatflow:u.object,handleSaveFlow:u.func,handleDeleteFlow:u.func,handleLoadFlow:u.func,isAgentCanvas:u.bool,isAgentflowV2:u.bool};const xr="/assets/agentflow-generator-DGaU2pb2.gif",yr=[{text:"An agent that can autonomously search the web and generate report"},{text:"Summarize a document"},{text:"Generate response to user queries and send it to Slack"},{text:"A team of agents that can handle all customer queries"}],da=({show:s,dialogProps:n,onCancel:c,onConfirm:f})=>{const h=document.getElementById("portal"),[b,d]=r.useState(""),[m,D]=r.useState(""),[C,O]=r.useState(!1),[P,H]=r.useState(0),[T,L]=r.useState([]),[_,y]=r.useState([]),[j,S]=r.useState({}),I=Ie(w=>w.customization),K=Pe(Fo.getChatModels),{reactFlowInstance:W}=r.useContext(Kt),ee=Oe(),x=qe();jt();const p=(...w)=>x(rt(...w)),k=(...w)=>x(it(...w)),M=({inputParam:w,newValue:U})=>{S(B=>{const V={...B};return V.inputs[w.name]=U,V.inputParams=Ls(V),V})};r.useEffect(()=>{if(K.data){L(K.data);const w=K.data.map(U=>({label:U.label,name:U.name,imageSrc:`${Ce}/api/v1/node-icon/${U.name}`}));y(w)}},[K.data]),r.useEffect(()=>{let w;return C?(H(0),w=setInterval(()=>{H(U=>{if(U>=95)return clearInterval(w),95;const B=U<30?3:U<60?5:U<80?2:.5;return Math.min(U+B,95)})},500)):H(100),()=>{w&&clearInterval(w)}},[C]);const R=async()=>{var w,U;if(b.trim())try{O(!0);const B=await tt.generateAgentflow({question:b.trim(),selectedChatModel:j});B.data&&B.data.nodes&&B.data.edges?(W.setNodes(B.data.nodes),W.setEdges(B.data.edges),f()):p({message:B.error||"Failed to generate agentflow",options:{key:new Date().getTime()+Math.random(),variant:"error",persist:!1,action:V=>e.jsx(Z,{style:{color:"white"},onClick:()=>k(V),children:e.jsx(fe,{})})}})}catch(B){p({message:((U=(w=B.response)==null?void 0:w.data)==null?void 0:U.message)||"Failed to generate agentflow",options:{key:new Date().getTime()+Math.random(),variant:"error",persist:!1,action:V=>e.jsx(Z,{style:{color:"white"},onClick:()=>k(V),children:e.jsx(fe,{})})}})}finally{O(!1)}};r.useEffect(()=>{s?K.request():(d(""),D(""),H(0))},[s]);const z=s?e.jsx(e.Fragment,{children:e.jsxs(Je,{fullWidth:!0,maxWidth:C?"sm":"md",open:s,onClose:C?null:c,"aria-labelledby":"alert-dialog-title","aria-describedby":"alert-dialog-description",children:[e.jsx(nt,{sx:{fontSize:"1rem"},id:"alert-dialog-title",children:n.title}),e.jsx(Ye,{children:C?e.jsxs("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",flexDirection:"column"},children:[e.jsx("img",{src:xr,alt:"Generating Agentflow",style:{maxWidth:"100%",height:"auto"}}),e.jsx(ne,{variant:"h5",sx:{mt:2},children:"Generating your Agentflow..."}),e.jsxs(q,{sx:{width:"100%",mt:2},children:[e.jsx(Bn,{variant:"determinate",value:P,sx:{height:10,borderRadius:5,"& .MuiLinearProgress-bar":{background:"linear-gradient(45deg, #FF6B6B 30%, #FF8E53 90%)",borderRadius:5}}}),e.jsx(ne,{variant:"body2",color:"text.secondary",align:"center",sx:{mt:1},children:`${Math.round(P)}%`})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{children:n.description}),e.jsx("div",{style:{display:"block",flexDirection:"row",width:"100%",marginTop:"25px"},children:yr.map((w,U)=>e.jsx(Z,{size:"small",sx:{textTransform:"none",mr:1,mb:1,borderRadius:"16px",border:"none",backgroundColor:I.isDarkMode?"rgba(255,255,255,0.05)":"rgba(0,0,0,0.03)",boxShadow:"0 2px 4px rgba(0,0,0,0.1)","&:hover":{backgroundColor:I.isDarkMode?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.06)",boxShadow:"0 4px 8px rgba(0,0,0,0.15)"}},variant:"contained",color:"inherit",onClick:()=>{d(w.text),D("")},children:w.text},U))}),!m&&e.jsx(Ue,{sx:{mt:2,width:"100%"},type:"text",multiline:!0,rows:12,disabled:C,value:b,placeholder:"Describe your agent here",onChange:w=>d(w.target.value)}),m&&e.jsx(Ue,{sx:{mt:2,width:"100%"},type:"text",multiline:!0,rows:12,value:m,onChange:w=>D(w.target.value)}),e.jsxs(q,{sx:{mt:2},children:[e.jsx("div",{style:{display:"flex",flexDirection:"row"},children:e.jsxs(ne,{children:["Select model to generate agentflow",e.jsx("span",{style:{color:"red"},children:" *"})]})}),e.jsx(Eo,{name:"chatModel",options:_??[],onSelect:w=>{if(!w)S({});else{const U=T.find(B=>B.name===w);if(U){const B=`${U.name}_0`,V=re.cloneDeep(U),ce=Wn(V,B);S(ce)}}},value:j?j==null?void 0:j.name:"choose an option"},JSON.stringify(j))]}),j&&Object.keys(j).length>0&&e.jsx(q,{sx:{p:0,mt:1,mb:1,border:1,borderColor:ee.palette.grey[900]+25,borderRadius:2},children:Ls(j).filter(w=>!w.hidden&&w.display!==!1).map((w,U)=>e.jsx(Ro,{inputParam:w,data:j,onNodeDataChange:M},U))})]})}),e.jsx(ot,{sx:{pb:3,pr:3},children:C?null:e.jsxs(e.Fragment,{children:[!m&&e.jsx(Po,{loading:C,variant:"contained",onClick:()=>{R()},sx:{background:"linear-gradient(45deg, #FF6B6B 30%, #FF8E53 90%)","&:hover":{background:"linear-gradient(45deg, #FF8E53 30%, #FF6B6B 90%)"}},startIcon:e.jsx(Xt,{size:20}),disabled:C||!b.trim()||!j||!Object.keys(j).length,children:"Generate"}),m&&e.jsx(Z,{variant:"outlined",startIcon:e.jsx(Uo,{size:20}),onClick:()=>{D("")},children:"Back"})]})})]})}):null;return wt.createPortal(z,h)};da.propTypes={show:u.bool,dialogProps:u.object,onConfirm:u.func,onCancel:u.func};const br="/assets/utilNodes-9P4ffRXr.png";function jr(s){return{id:`attachment-tab-${s}`,"aria-controls":`attachment-tabpanel-${s}`}}const qs=["Agents","Memory","Record Manager","Utilities"],ua=["agentMemory","sqliteAgentMemory","postgresAgentMemory","mySQLAgentMemory"],ht={Memory:ua,Utilities:["getVariable","setVariable","stickyNote"]},ft={Memory:ua},pa=({nodesData:s,node:n,isAgentCanvas:c,isAgentflowv2:f,onFlowGenerated:h})=>{const b=Oe(),d=Ie(E=>E.customization),m=qe(),[D,C]=r.useState(""),[O,P]=r.useState({}),[H,T]=r.useState(!1),[L,_]=r.useState({}),[y,j]=r.useState(0),[S,I]=r.useState(!1),[K,W]=r.useState({}),ee=window.location.pathname.includes("/v2/agentcanvas"),x=r.useRef(null),p=r.useRef(H),k=r.useRef(),M=()=>{const E=k.current;E&&(E.scrollTop=0)},R=(E,v)=>{j(v),U(D,v)},z=E=>{let v=[];if(E){const N=ht[E]||[];v=s.filter(G=>G.category===E&&N.includes(G.name))}else for(const N in ht){const G=ht[N];v.push(...s.filter(se=>se.category===N&&G.includes(se.name)))}return v},w=E=>{if(c){const G=s.filter($=>!qs.includes($.category));return G.push(...z()),G.filter($=>{const X=$.name.toLowerCase().includes(E.toLowerCase()),J=$.label.toLowerCase().includes(E.toLowerCase()),de=$.category.toLowerCase().includes(E.toLowerCase());return X||de||J})}let v=s.filter(G=>G.category!=="Multi Agents"&&G.category!=="Sequential Agents");for(const G in ft){const se=ft[G];v=v.filter($=>!se.includes($.name))}return v.filter(G=>{const se=G.name.toLowerCase().includes(E.toLowerCase()),$=G.label.toLowerCase().includes(E.toLowerCase()),X=G.category.toLowerCase().includes(E.toLowerCase());return se||X||$})},U=(E,v)=>{C(E),setTimeout(()=>{if(E){const N=w(E);V(N,v??y,!0),M()}else E===""&&(V(s,v??y),M())},500)},B=(E,v=0)=>{const N=E.filter($=>!$.tags),G=E.filter($=>$.tags&&$.tags.includes("LlamaIndex")),se=E.filter($=>$.tags&&$.tags.includes("Utilities"));return v===0?N:v===1?G:se},V=(E,v,N)=>{if(c){const G={},se=E.reduce(function(X,J){return X[J.category]=X[J.category]||[],X[J.category].push(J),G[J.category]=!!N,X},Object.create(null)),$={};for(const X in se){if(ee){if(X!=="Agent Flows")continue}else if(X==="Agent Flows")continue;if(!qs.includes(X)){const J=se[X].filter(de=>!de.tags||!de.tags.includes("LlamaIndex"));if(!J.length)continue;$[X]=J}Object.keys(ht).includes(X)&&($[X]=z(X))}P($),G["Multi Agents"]=!0,G["Sequential Agents"]=!0,G.Memory=!0,G["Agent Flows"]=!0,_(G)}else{const G=B(E,v),se={},$=G.reduce(function(J,de){return J[de.category]=J[de.category]||[],J[de.category].push(de),se[de.category]=!!N,J},Object.create(null)),X={};for(const J in $)if(!(J==="Agent Flows"||J==="Multi Agents"||J==="Sequential Agents")){if(Object.keys(ft).includes(J)){const de=ft[J];$[J]=$[J].filter(Ke=>!de.includes(Ke.name))}X[J]=$[J]}P(X),_(se)}},ce=E=>(v,N)=>{const G={...L};G[E]=N,_(G)},Se=E=>{x.current&&x.current.contains(E.target)||T(!1)},De=()=>{T(E=>!E)},we=(E,v)=>{E.dataTransfer.setData("application/reactflow",JSON.stringify(v)),E.dataTransfer.effectAllowed="move"},oe=E=>E===0?co:E===1?Lo:br,ye=E=>{const v=Qt.find(N=>N.name===E.name);return v?e.jsx(v.icon,{size:30,color:E.color}):null};r.useEffect(()=>{p.current===!0&&H===!1&&x.current.focus(),p.current=H},[H]),r.useEffect(()=>{n&&T(!1)},[n]),r.useEffect(()=>{s&&(V(s),m({type:Gn,componentNodes:s}))},[s,m]);const ge=()=>{I(!0),W({title:"What would you like to build?",description:"Enter your prompt to generate an agentflow. Performance may vary with different models. Only nodes and edges are generated, you will need to fill in the input fields for each node."})},ke=()=>{I(!1)},Ae=()=>{I(!1),h()};return e.jsxs(e.Fragment,{children:[e.jsx(st,{sx:{left:20,top:20},ref:x,size:"small",color:"primary","aria-label":"add",title:"Add Node",onClick:De,children:H?e.jsx(pr,{}):e.jsx(zo,{})}),f&&e.jsx(st,{sx:{left:40,top:20,background:"linear-gradient(45deg, #FF6B6B 30%, #FF8E53 90%)","&:hover":{background:"linear-gradient(45deg, #FF8E53 30%, #FF6B6B 90%)"}},onClick:ge,size:"small",color:"primary","aria-label":"generate",title:"Generate Agentflow",children:e.jsx(Xt,{})}),e.jsx(da,{show:S,dialogProps:K,onCancel:ke,onConfirm:Ae}),e.jsx(ea,{placement:"bottom-end",open:H,anchorEl:x.current,role:void 0,transition:!0,disablePortal:!0,popperOptions:{modifiers:[{name:"offset",options:{offset:[-40,14]}}]},sx:{zIndex:1e3},children:({TransitionProps:E})=>e.jsx(ta,{in:H,...E,children:e.jsx(Yt,{children:e.jsx(sa,{onClickAway:Se,children:e.jsxs(aa,{border:!1,elevation:16,content:!1,boxShadow:!0,shadow:b.shadows[16],children:[e.jsxs(q,{sx:{p:2},children:[e.jsx(Ee,{children:e.jsx(ne,{variant:"h4",children:"Add Nodes"})}),e.jsx(Ue,{autoFocus:!0,sx:{width:"100%",pr:2,pl:2,my:2},id:"input-search-node",value:D,onChange:v=>U(v.target.value),placeholder:"Search nodes",startAdornment:e.jsx(Me,{position:"start",children:e.jsx(Oo,{stroke:1.5,size:"1rem",color:b.palette.grey[500]})}),endAdornment:e.jsx(Me,{position:"end",sx:{cursor:"pointer",color:b.palette.grey[500],"&:hover":{color:b.palette.grey[900]}},title:"Clear Search",children:e.jsx(fe,{stroke:1.5,size:"1rem",onClick:()=>U(""),style:{cursor:"pointer"}})}),"aria-describedby":"search-helper-text",inputProps:{"aria-label":"weight"}}),!c&&e.jsx(Ho,{sx:{position:"relative",minHeight:"50px",height:"50px"},variant:"fullWidth",value:y,onChange:R,"aria-label":"tabs",children:["LangChain","LlamaIndex","Utilities"].map((v,N)=>e.jsx(qn,{icon:e.jsx("div",{style:{borderRadius:"50%"},children:e.jsx("img",{style:{width:"20px",height:"20px",borderRadius:"50%",objectFit:"contain"},src:oe(N),alt:v})}),iconPosition:"start",sx:{minHeight:"50px",height:"50px"},label:v,...jr(N)},N))}),e.jsx(at,{})]}),e.jsx(_n,{containerRef:v=>{k.current=v},style:{height:"100%",maxHeight:`calc(100vh - ${c?"300":"380"}px)`,overflowX:"hidden"},children:e.jsx(q,{sx:{p:2,pt:0},children:e.jsx(Vn,{sx:{width:"100%",maxWidth:370,py:0,borderRadius:"10px",[b.breakpoints.down("md")]:{maxWidth:370},"& .MuiListItemSecondaryAction-root":{top:22},"& .MuiDivider-root":{my:0},"& .list-container":{pl:7}},children:Object.keys(O).sort().map(v=>e.jsxs(ts,{expanded:L[v]||!1,onChange:ce(v),disableGutters:!0,children:[e.jsx(ss,{expandIcon:e.jsx(es,{}),"aria-controls":`nodes-accordian-${v}`,id:`nodes-accordian-header-${v}`,children:v.split(";").length>1?e.jsxs("div",{style:{display:"flex",flexDirection:"row",alignItems:"center"},children:[e.jsx(ne,{variant:"h5",children:v.split(";")[0]})," ",e.jsx(Fe,{sx:{width:"max-content",fontWeight:700,fontSize:"0.65rem",background:v.split(";")[1]==="DEPRECATING"?b.palette.warning.main:b.palette.teal.main,color:v.split(";")[1]!=="DEPRECATING"?"white":"inherit"},size:"small",label:v.split(";")[1]})]}):e.jsx(ne,{variant:"h5",children:v})}),e.jsx(as,{children:O[v].map((N,G)=>e.jsxs("div",{onDragStart:se=>we(se,N),draggable:!0,children:[e.jsx(Ks,{sx:{p:0,borderRadius:`${d.borderRadius}px`,cursor:"move"},children:e.jsxs($o,{alignItems:"center",children:[N.color&&!N.icon?e.jsx(Ws,{children:e.jsx("div",{style:{width:50,height:"auto",display:"flex",alignItems:"center",justifyContent:"center"},children:ye(N)})}):e.jsx(Ws,{children:e.jsx("div",{style:{width:50,height:50,borderRadius:"50%",backgroundColor:"white"},children:e.jsx("img",{style:{width:"100%",height:"100%",padding:10,objectFit:"contain"},alt:N.name,src:`${Ce}/api/v1/node-icon/${N.name}`})})}),e.jsx(Jn,{sx:{ml:1},primary:e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{display:"flex",flexDirection:"row",alignItems:"center"},children:[e.jsx("span",{children:N.label})," ",N.badge&&e.jsx(Fe,{sx:{width:"max-content",fontWeight:700,fontSize:"0.65rem",background:N.badge==="DEPRECATING"?b.palette.warning.main:b.palette.teal.main,color:N.badge!=="DEPRECATING"?"white":"inherit"},size:"small",label:N.badge})]}),N.author&&e.jsxs("span",{style:{fontSize:"0.65rem",fontWeight:700},children:["By ",N.author]})]}),secondary:N.description})]})}),G===O[v].length-1?null:e.jsx(at,{})]},N.name))})]},v))})})})]})})})})})]})};pa.propTypes={nodesData:u.array,node:u.object,onFlowGenerated:u.func,isAgentCanvas:u.bool,isAgentflowv2:u.bool};const zi=r.memo(pa);async function wr(s,n){const c=s.getReader();let f;for(;!(f=await c.read()).done;)n(f.value)}function kr(s){let n,c,f,h=!1;return function(d){n===void 0?(n=d,c=0,f=-1):n=Cr(n,d);const m=n.length;let D=0;for(;c<m;){h&&(n[c]===10&&(D=++c),h=!1);let C=-1;for(;c<m&&C===-1;++c)switch(n[c]){case 58:f===-1&&(f=c-D);break;case 13:h=!0;case 10:C=c;break}if(C===-1)break;s(n.subarray(D,C),f),D=c,f=-1}D===m?n=void 0:D!==0&&(n=n.subarray(D),c-=D)}}function vr(s,n,c){let f=_s();const h=new TextDecoder;return function(d,m){if(d.length===0)c==null||c(f),f=_s();else if(m>0){const D=h.decode(d.subarray(0,m)),C=m+(d[m+1]===32?2:1),O=h.decode(d.subarray(C));switch(D){case"data":f.data=f.data?f.data+`
`+O:O;break;case"event":f.event=O;break;case"id":s(f.id=O);break;case"retry":const P=parseInt(O,10);isNaN(P)||n(f.retry=P);break}}}}function Cr(s,n){const c=new Uint8Array(s.length+n.length);return c.set(s),c.set(n,s.length),c}function _s(){return{data:"",event:"",id:"",retry:void 0}}var Ir=function(s,n){var c={};for(var f in s)Object.prototype.hasOwnProperty.call(s,f)&&n.indexOf(f)<0&&(c[f]=s[f]);if(s!=null&&typeof Object.getOwnPropertySymbols=="function")for(var h=0,f=Object.getOwnPropertySymbols(s);h<f.length;h++)n.indexOf(f[h])<0&&Object.prototype.propertyIsEnumerable.call(s,f[h])&&(c[f[h]]=s[f[h]]);return c};const bt="text/event-stream",Sr=1e3,Vs="last-event-id";function Dr(s,n){var{signal:c,headers:f,onopen:h,onmessage:b,onclose:d,onerror:m,openWhenHidden:D,fetch:C}=n,O=Ir(n,["signal","headers","onopen","onmessage","onclose","onerror","openWhenHidden","fetch"]);return new Promise((P,H)=>{const T=Object.assign({},f);T.accept||(T.accept=bt);let L;function _(){L.abort(),document.hidden||W()}D||document.addEventListener("visibilitychange",_);let y=Sr,j=0;function S(){document.removeEventListener("visibilitychange",_),window.clearTimeout(j),L.abort()}c==null||c.addEventListener("abort",()=>{S(),P()});const I=C??window.fetch,K=h??Ar;async function W(){var ee;L=new AbortController;try{const x=await I(s,Object.assign(Object.assign({},O),{headers:T,signal:L.signal}));await K(x),await wr(x.body,kr(vr(p=>{p?T[Vs]=p:delete T[Vs]},p=>{y=p},b))),d==null||d(),S(),P()}catch(x){if(!L.signal.aborted)try{const p=(ee=m==null?void 0:m(x))!==null&&ee!==void 0?ee:y;window.clearTimeout(j),j=window.setTimeout(W,p)}catch(p){S(),H(p)}}}W()})}function Ar(s){const n=s.headers.get("content-type");if(!(n!=null&&n.startsWith(bt)))throw new Error(`Expected content-type to be ${bt}, Actual: ${n}`)}const Js="/assets/wave-sound-CdNNyn1h.jpg",Tr=({show:s,onCancel:n,onConfirm:c})=>{const f=document.getElementById("portal"),h=qe(),[b,d]=r.useState(""),m=r.useCallback(O=>d(O.target.value),[d]),D=()=>{c(b)};r.useEffect(()=>(h(s?{type:Xs}:{type:xt}),()=>{h({type:xt}),d("")}),[s,h]);const C=s?e.jsxs(Je,{onClose:n,open:s,fullWidth:!0,maxWidth:"sm","aria-labelledby":"alert-dialog-title","aria-describedby":"alert-dialog-description",children:[e.jsx(nt,{sx:{fontSize:"1rem"},id:"alert-dialog-title",children:"Provide additional feedback"}),e.jsx(Ye,{children:e.jsx(q,{sx:{width:"100%",display:"flex",alignItems:"center",justifyContent:"space-between"},children:e.jsx(Ue,{autoFocus:!0,id:"feedbackContentInput",multiline:!0,name:"feedbackContentInput",onChange:m,placeholder:"What do you think of the response?",rows:4,value:b,sx:{width:"100%"}})})}),e.jsxs(ot,{children:[e.jsx(Z,{onClick:n,children:"Cancel"}),e.jsx(na,{variant:"contained",onClick:D,children:"Submit Feedback"})]})]}):null;return wt.createPortal(C,f)},ha=({isGrid:s,starterPrompts:n,sx:c,onPromptClick:f})=>e.jsx(q,{className:"button-container",sx:{width:"100%",maxWidth:s?"inherit":"400px",p:1.5,display:"flex",gap:1,...c},children:n.map((h,b)=>e.jsx(Fe,{label:h.prompt,className:"button",onClick:d=>f(h.prompt,d)},b))});ha.propTypes={isGrid:u.bool,starterPrompts:u.array,sx:u.object,onPromptClick:u.func};const Mr="/assets/next-agent--RPptFkm.gif",ns=({agent:s,index:n,customization:c,chatflowid:f,isDialog:h,onSourceDialogClick:b,renderArtifacts:d,agentReasoningArtifacts:m,getAgentIcon:D,removeDuplicateURL:C,isValidURL:O,onURLClick:P,getLabel:H})=>s.nextAgent?e.jsx(Ge,{sx:{border:c.isDarkMode?"none":"1px solid #e0e0e0",borderRadius:`${c.borderRadius}px`,background:c.isDarkMode?"linear-gradient(to top, #303030, #212121)":"linear-gradient(to top, #f6f3fb, #f2f8fc)",mb:1},children:e.jsx(zs,{children:e.jsxs(Ee,{sx:{alignItems:"center",justifyContent:"flex-start",width:"100%"},flexDirection:"row",children:[e.jsx(q,{sx:{height:"auto",pr:1},children:e.jsx("img",{style:{objectFit:"cover",height:"35px",width:"auto"},src:Mr,alt:"agentPNG"})}),e.jsx("div",{children:s.nextAgent})]})})},n):e.jsx(Ge,{sx:{mb:1},children:e.jsxs(zs,{children:[e.jsxs(Ee,{sx:{alignItems:"center",justifyContent:"flex-start",width:"100%"},flexDirection:"row",children:[e.jsx(q,{sx:{height:"auto",pr:1},children:e.jsx("img",{style:{objectFit:"cover",height:"25px",width:"auto"},src:D(s.nodeName,s.instructions),alt:"agentPNG"})}),e.jsx("div",{children:s.agentName})]}),s.usedTools&&s.usedTools.length>0&&e.jsx("div",{style:{display:"block",flexDirection:"row",width:"100%"},children:s.usedTools.map((T,L)=>T!==null?e.jsx(Fe,{size:"small",label:T.tool,component:"a",sx:{mr:1,mt:1},variant:"outlined",clickable:!0,icon:e.jsx(oa,{size:15}),onClick:()=>b(T,"Used Tools")},L):null)}),s.state&&Object.keys(s.state).length>0&&e.jsx("div",{style:{display:"block",flexDirection:"row",width:"100%"},children:e.jsx(Fe,{size:"small",label:"State",component:"a",sx:{mr:1,mt:1},variant:"outlined",clickable:!0,icon:e.jsx(uo,{size:15}),onClick:()=>b(s.state,"State")})}),s.artifacts&&e.jsx("div",{style:{display:"flex",flexWrap:"wrap",flexDirection:"row",width:"100%",gap:"8px"},children:m(s.artifacts).map((T,L)=>T!==null?e.jsx(e.Fragment,{children:d(T,L,!0)}):null)}),s.messages.length>0&&e.jsx(_t,{chatflowid:f,isFullWidth:h,children:s.messages.length>1?s.messages.join("\\n"):s.messages[0]}),s.instructions&&e.jsx("p",{children:s.instructions}),s.messages.length===0&&!s.instructions&&e.jsx("p",{children:"Finished"}),s.sourceDocuments&&s.sourceDocuments.length>0&&e.jsx("div",{style:{display:"block",flexDirection:"row",width:"100%"},children:C(s).map((T,L)=>{const _=T&&T.metadata&&T.metadata.source?O(T.metadata.source):void 0;return e.jsx(Fe,{size:"small",label:H(_,T)||"",component:"a",sx:{mr:1,mb:1},variant:"outlined",clickable:!0,onClick:()=>_?P(T.metadata.source):b(T)},L)})})]})},n);ns.propTypes={agent:u.object.isRequired,index:u.number.isRequired,customization:u.object.isRequired,chatflowid:u.string,isDialog:u.bool,onSourceDialogClick:u.func.isRequired,renderArtifacts:u.func.isRequired,agentReasoningArtifacts:u.func.isRequired,getAgentIcon:u.func.isRequired,removeDuplicateURL:u.func.isRequired,isValidURL:u.func.isRequired,onURLClick:u.func.isRequired,getLabel:u.func.isRequired};ns.displayName="AgentReasoningCard";const fa=s=>{switch(s){case"FINISHED":return"success.dark";case"ERROR":case"TIMEOUT":return"error.main";case"TERMINATED":case"STOPPED":return"error.main";case"INPROGRESS":return"warning.dark"}},Er=_e(Wo)(({theme:s})=>({color:s.palette.grey[400]})),Fr=_e(Go)(({theme:s})=>({flexDirection:"row-reverse",borderRadius:s.spacing(.7),marginBottom:s.spacing(.5),marginTop:s.spacing(.5),padding:s.spacing(.5),paddingRight:s.spacing(1),fontWeight:500,"&.Mui-expanded ":{"&:not(.Mui-focused, .Mui-selected, .Mui-selected.Mui-focused) .labelIcon":{color:s.palette.primary.dark,...s.applyStyles("light",{color:s.palette.primary.main})},"&::before":{content:'""',display:"block",position:"absolute",left:"16px",top:"44px",height:"calc(100% - 48px)",width:"1.5px",backgroundColor:s.palette.grey[700],...s.applyStyles("light",{backgroundColor:s.palette.grey[300]})}},"&:hover":{backgroundColor:Yn(s.palette.primary.main,.1),color:"white",...s.applyStyles("light",{color:s.palette.primary.main})},"&.Mui-focused, &.Mui-selected, &.Mui-selected.Mui-focused":{backgroundColor:s.palette.primary.dark,color:s.palette.primary.contrastText,...s.applyStyles("light",{backgroundColor:s.palette.primary.main})}})),Rr=_e(ne)(({theme:s})=>({color:s.palette.text.primary}));function os({icon:s,itemStatus:n,children:c,name:f,label:h,data:b,metadata:d,...m}){const[D,C]=r.useState(!1),O=T=>{T.stopPropagation(),C(!0)},P=()=>C(!1),H=f==="iterationAgentflow";return e.jsxs(Qo,{...m,sx:{display:"flex",alignItems:"center",flexDirection:"column"},children:[e.jsxs(q,{sx:{display:"flex",alignItems:"center",width:"100%"},children:[(()=>{if(H)return e.jsx(q,{sx:{mr:1,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(Kn,{size:20,color:"#9C89B8"})});const T=Qt.find(L=>L.name===f);return T?e.jsx(q,{sx:{mr:1,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(T.icon,{size:20,color:T.color})}):null})(),e.jsx(Rr,{sx:{flex:1},children:c}),e.jsx(pe,{onClick:O,size:"small",title:"View Details",sx:{ml:2,zIndex:10},children:e.jsx(ia,{size:15,color:"teal"})}),s&&e.jsx(q,{component:s,className:"labelIcon",color:fa(n),sx:{ml:1,fontSize:"1.2rem"}})]}),e.jsxs(Je,{open:D,onClose:P,maxWidth:"md",fullWidth:!0,disableBackdropClick:!0,children:[e.jsx(Ye,{onClick:T=>T.stopPropagation(),children:b?e.jsx(Zo,{data:b,label:h,metadata:d}):e.jsx(ne,{color:"text.secondary",children:"No data available for this item"})}),e.jsx(ot,{children:e.jsx(Z,{onClick:P,children:"Close"})})]})]})}os.propTypes={icon:u.elementType,itemStatus:u.string,expandable:u.bool,children:u.node,name:u.string,label:u.string,status:u.object,data:u.object,metadata:u.object};os.displayName="CustomLabel";const ga=s=>Array.isArray(s)?s.length>0&&s.some(ga):!!s,ma=(s,n)=>{switch(s){case"FINISHED":return tr;case"ERROR":case"TIMEOUT":return er;case"TERMINATED":return c=>e.jsx(ir,{...c,color:n.palette.error.main});case"STOPPED":return rr;case"INPROGRESS":return c=>e.jsx(or,{...c,color:n.palette.warning.dark,className:`spin-animation ${c.className||""}`})}},rs=r.forwardRef(function(n,c){var p;const{id:f,itemId:h,label:b,disabled:d,children:m,agentflowId:D,sessionId:C,...O}=n,P=Oe(),{getRootProps:H,getContentProps:T,getIconContainerProps:L,getCheckboxProps:_,getLabelProps:y,getGroupTransitionProps:j,getDragAndDropOverlayProps:S,status:I,publicAPI:K}=qo({id:f,itemId:h,children:m,label:b,disabled:d,rootRef:c}),W=K.getItem(h),ee=ga(m);let x;return W.status&&(x=ma(W.status,P)),e.jsx(_o,{itemId:h,children:e.jsxs(Er,{...H(O),children:[e.jsxs(Fr,{...T(),children:[e.jsx(Vo,{...L(),children:e.jsx(Jo,{status:I})}),e.jsx(Yo,{..._()}),e.jsx(os,{...y({icon:x,itemStatus:W.status,expandable:ee&&I.expanded,name:W.name||((p=W.id)==null?void 0:p.split("_")[0]),label:W.label,status:I,data:W.data,metadata:{agentflowId:D,sessionId:C}})}),e.jsx(Ko,{...S()})]}),m&&e.jsx(Xo,{...j(),style:{borderLeft:`${I.selected?"3px solid":"1px dashed"} ${(()=>{var R;const k=W.name||((R=W.id)==null?void 0:R.split("_")[0]),M=Qt.find(z=>z.name===k);return M?M.color:P.palette.primary.main})()}`,marginLeft:"13px",paddingLeft:"8px"}})]})})});rs.propTypes={id:u.string,itemId:u.string,label:u.string,disabled:u.bool,children:u.node,agentflowId:u.string,sessionId:u.string,className:u.string};rs.displayName="CustomTreeItem";const xa=({status:s,execution:n,agentflowId:c,sessionId:f})=>{const[h,b]=r.useState([]),[d,m]=r.useState([]),[D,C]=r.useState(null),O=Oe(),P=y=>{let j=[];return y.forEach(S=>{j.push(S.id),S.children&&S.children.length>0&&(j=[...j,...P(S.children)])}),j},H=y=>{y.forEach(x=>{const p=k=>{for(const M in k)M===Xn&&delete k[M],typeof k[M]=="object"&&p(k[M])};p(x.data)});const j=new Map;y.forEach((x,p)=>{const k=`${x.nodeId}_${p}`;j.set(k,{...x,uniqueNodeId:k,children:[],executionIndex:p})});const S=new Map;y.forEach((x,p)=>{var k,M;if((k=x.data)!=null&&k.parentNodeId&&((M=x.data)==null?void 0:M.iterationIndex)!==void 0){const R=x.data.parentNodeId,z=x.data.iterationIndex;S.has(R)||S.set(R,new Map);const w=S.get(R);w.has(z)||w.set(z,[]),w.get(z).push(`${x.nodeId}_${p}`)}}),S.forEach((x,p)=>{x.forEach((k,M)=>{var we;let R=null;for(let oe=0;oe<y.length;oe++)if(y[oe].nodeId===p){R=y[oe];break}if(!R)return;const z=k[0],w=j.get(z),U=((we=w==null?void 0:w.data)==null?void 0:we.iterationContext)||{index:M},B=`${p}_${M}`,V=`Iteration #${M}`,ce=k.map(oe=>j.get(oe)),Se=ce.some(oe=>oe.status==="ERROR")?"ERROR":ce.some(oe=>oe.status==="INPROGRESS")?"INPROGRESS":ce.every(oe=>oe.status==="FINISHED")?"FINISHED":"UNKNOWN",De={nodeId:B,nodeLabel:V,data:{name:"iterationAgentflow",iterationIndex:M,iterationContext:U,isVirtualNode:!0,parentIterationId:p},previousNodeIds:[],status:Se,uniqueNodeId:B,children:[],executionIndex:-1};j.set(B,De),k.forEach(oe=>{const ye=j.get(oe);ye&&(ye.virtualParentId=B)})})});const I=[],K=new Set;y.forEach((x,p)=>{var R,z;const k=`${x.nodeId}_${p}`,M=j.get(k);if(!((R=x.data)!=null&&R.parentNodeId&&((z=x.data)==null?void 0:z.iterationIndex)!==void 0))if(x.previousNodeIds.length===0)I.push(M);else{let w=-1,U=null;if(x.previousNodeIds.forEach(B=>{for(let V=0;V<p;V++)y[V].nodeId===B&&V>w&&(w=V,U=B)}),w!==-1){const B=`${U}_${w}`,V=j.get(B);V&&(V.children.push(M),K.add(k))}}}),S.forEach((x,p)=>{const k=[];y.forEach((R,z)=>{R.nodeId===p&&k.push(`${R.nodeId}_${z}`)});let M=null;for(let R=k.length-1;R>=0;R--){const z=k[R],w=j.get(z);if(w){M=w;break}}M&&x.forEach((R,z)=>{const w=`${p}_${z}`,U=j.get(w);U&&M.children.push(U)})}),j.forEach(x=>{if(x.virtualParentId){const p=j.get(x.virtualParentId);if(p)if(x.previousNodeIds.length===0)p.children.push(x);else{let k=!1;for(const M of x.previousNodeIds)j.forEach(R=>{var z,w,U,B;R.nodeId===M&&((z=R.data)==null?void 0:z.iterationIndex)===((w=x.data)==null?void 0:w.iterationIndex)&&((U=R.data)==null?void 0:U.parentNodeId)===((B=x.data)==null?void 0:B.parentNodeId)&&!k&&(R.children.push(x),k=!0)});k||p.children.push(x)}}});const W=x=>{x.children&&x.children.length>0&&(x.children.sort((p,k)=>{var z,w,U,B;const M=((z=p.data)==null?void 0:z.name)==="iterationAgentflow"||((w=p.data)==null?void 0:w.isVirtualNode),R=((U=k.data)==null?void 0:U.name)==="iterationAgentflow"||((B=k.data)==null?void 0:B.isVirtualNode);return M===R?p.executionIndex-k.executionIndex:M?-1:1}),x.children.forEach(W))};I.forEach(W);const ee=x=>{var p;return{id:x.uniqueNodeId,label:x.nodeLabel,name:(p=x.data)==null?void 0:p.name,status:x.status,data:x.data,children:x.children.map(ee)}};return I.map(ee)},T=(y,j)=>{m(j)};r.useEffect(()=>{if(n){const y=H(n);b(y),m(P(y)),y.length>0&&C(y[0])}},[n]);const L=(y,j)=>{const S=(K,W)=>{for(const ee of K){if(ee.id===W)return ee;if(ee.children){const x=S(ee.children,W);if(x)return x}}return null},I=S(h,j);C(I)},_=r.useCallback(y=>{const j=I=>{let K=[];return I.forEach(W=>{W.status&&K.push(W.status),W.children&&W.children.length>0&&(K=[...K,...j(W.children)])}),K},S=j(y);return S.includes("ERROR")?"ERROR":S.includes("INPROGRESS")?"INPROGRESS":S.includes("STOPPED")?"STOPPED":S.every(I=>I==="FINISHED")?"FINISHED":null},[]);return e.jsx(q,{sx:{display:"flex",height:"100%",width:"100%",mt:2},children:e.jsxs(ts,{sx:{width:"100%"},children:[e.jsxs(ss,{expandIcon:e.jsx(es,{}),sx:{"& .MuiAccordionSummary-content":{alignItems:"center"}},children:[h.length>0&&(()=>{const y=s??_(h);return e.jsx(q,{sx:{mr:1,fontSize:"1.2rem"},children:e.jsx(q,{component:ma(y,O),sx:{mr:1,fontSize:"1.2rem",color:fa(y)}})})})(),e.jsx(ne,{children:"Process Flow"})]}),e.jsx(at,{}),e.jsx(as,{children:e.jsx(sr,{expandedItems:d,onExpandedItemsChange:T,selectedItems:D?[D.id]:[],onSelectedItemsChange:L,items:h,slots:{item:y=>e.jsx(rs,{...y,agentflowId:c,sessionId:f})},sx:{width:"100%"}})})]})})};xa.propTypes={status:u.string,execution:u.array,agentflowId:u.string,sessionId:u.string};const Nr=r.memo(xa),Pr=_e(Ne)(({theme:s})=>({position:"relative",height:200,borderRadius:"10px",[s.breakpoints.down("sm")]:{width:"100% !important",height:100},"&:hover, &.Mui-focusVisible":{zIndex:1,"& .MuiImageBackdrop-root":{opacity:.4},"& .MuiImageMarked-root":{opacity:1},"& .MuiTypography-root":{border:"4px solid currentColor"}}})),Ur=_e("span")({position:"absolute",borderRadius:"10px",left:0,right:0,top:0,bottom:0,backgroundSize:"cover",backgroundPosition:"center 40%"}),Or=_e("span")(({theme:s})=>({position:"absolute",borderRadius:"10px",left:0,right:0,top:0,bottom:0,backgroundColor:s.palette.common.black,opacity:.1,transition:s.transitions.create("opacity")})),Lr=_e("span")(()=>({height:25,width:25,backgroundColor:"transparent",position:"absolute",top:"auto",left:"auto",opacity:0})),ya=s=>{const n=Ie(c=>c.customization);return e.jsx(pe,{disabled:s.isDisabled||s.isLoading,onClick:s.onClick,size:"small",sx:{background:"transparent",border:"none"},title:"Copy to clipboard",children:e.jsx(Co,{style:{width:"20px",height:"20px"},color:s.isLoading?"#9e9e9e":n.isDarkMode?"white":"#1e88e5"})})};ya.propTypes={isDisabled:u.bool,isLoading:u.bool,onClick:u.func};const ba=s=>{const n=Ie(c=>c.customization);return e.jsx(pe,{disabled:s.isDisabled||s.isLoading,onClick:s.onClick,size:"small",sx:{background:"transparent",border:"none"},title:"Thumbs Up",children:e.jsx(fr,{style:{width:"20px",height:"20px"},color:s.rating==="THUMBS_UP"?"#9e9e9e":n.isDarkMode?"white":"#1e88e5"})})};ba.propTypes={isDisabled:u.bool,isLoading:u.bool,onClick:u.func,rating:u.string};const ja=s=>{const n=Ie(c=>c.customization);return e.jsx(pe,{disabled:s.isDisabled||s.isLoading,onClick:s.onClick,size:"small",sx:{background:"transparent",border:"none"},title:"Thumbs Down",children:e.jsx(hr,{style:{width:"20px",height:"20px"},color:s.rating==="THUMBS_DOWN"?"#9e9e9e":n.isDarkMode?"white":"#1e88e5"})})};ja.propTypes={isDisabled:u.bool,isLoading:u.bool,onClick:u.func,rating:u.string};let is,wa;function zr(){is=document.getElementsByClassName("start-recording-button")[0]}function Hr(){is.style.display="none",Gr()}function ka(){is.style.display="block",clearInterval(Ca)}let va,$r=1,Ca;function Br(s,n){zr(),ie.start().then(()=>{s&&s(!0),va=new Date,Hr()}).catch(c=>{switch(c.message.includes("mediaDevices API or getUserMedia method is not supported in this browser.")&&n&&n(!0),c.name){case"AbortError":console.log("An AbortError has occurred.");break;case"NotAllowedError":console.log("A NotAllowedError has occurred. User might have denied permission.");break;case"NotFoundError":console.log("A NotFoundError has occurred.");break;case"NotReadableError":console.log("A NotReadableError has occurred.");break;case"SecurityError":console.log("A SecurityError has occurred.");break;case"TypeError":console.log("A TypeError has occurred.");break;case"InvalidStateError":console.log("An InvalidStateError has occurred.");break;case"UnknownError":console.log("An UnknownError has occurred.");break;default:console.log("An error occurred with the error name "+c.name)}})}function Ia(s){ie.stop().then(n=>{ka(),s&&s(n)}).catch(n=>{switch(n.name){case"InvalidStateError":console.log("An InvalidStateError has occurred.");break;default:console.log("An error occurred with the error name "+n.name)}})}function Wr(){ie.cancel(),ka()}function Gr(){wa=document.getElementById("elapsed-time"),Ys("00:00"),Ca=setInterval(()=>{let s=_r(va);Ys(s)},1e3)}function Ys(s){wa.innerHTML=s,qr(s)&&Ia()}function qr(s){let n=s.split(":"),c="0"+$r;return n.length===3&&n[0]===c}function _r(s){let c=new Date-s;c=c/1e3;let f=Math.floor(c%60);f=f<10?"0"+f:f,c=Math.floor(c/60);let h=c%60;h=h<10?"0"+h:h,c=Math.floor(c/60);let b=c%24;c=Math.floor(c/24);let m=b+c*24;return m=m<10?"0"+m:m,m==="00"?h+":"+f:m+":"+h+":"+f}const ie={audioBlobs:[],mediaRecorder:null,streamBeingCaptured:null,start:function(){return navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia({audio:!0}).then(s=>{ie.streamBeingCaptured=s,ie.mediaRecorder=new MediaRecorder(s),ie.audioBlobs=[],ie.mediaRecorder.addEventListener("dataavailable",n=>{ie.audioBlobs.push(n.data)}),Qn?ie.mediaRecorder.start(1e3):ie.mediaRecorder.start()}):Promise.reject(new Error("mediaDevices API or getUserMedia method is not supported in this browser."))},stop:function(){return new Promise(s=>{let n=ie.mediaRecorder.mimeType;ie.mediaRecorder.addEventListener("stop",()=>{let c=new Blob(ie.audioBlobs,{type:n});s(c)}),ie.cancel()})},cancel:function(){ie.mediaRecorder.stop(),ie.stopStream(),ie.resetRecordingProperties()},stopStream:function(){ie.streamBeingCaptured.getTracks().forEach(s=>s.stop())},resetRecordingProperties:function(){ie.mediaRecorder=null,ie.streamBeingCaptured=null}},Vr=(s,n,c)=>Zt.post(`/attachments/${s}/${n}`,c,{headers:{"Content-Type":"multipart/form-data"}}),Jr={createAttachment:Vr},Yr=(s,n)=>Zt.post(`/feedback/${s}`,n),Kr=(s,n)=>Zt.put(`/feedback/${s}`,n),Bt={addFeedback:Yr,updateFeedback:Kr},Sa=({isGrid:s,followUpPrompts:n,sx:c,onPromptClick:f})=>{const h=Ie(b=>b.customization);return e.jsx(q,{className:"button-container",sx:{width:"100%",maxWidth:s?"inherit":"400px",p:1.5,display:"flex",gap:1,...c},children:Array.isArray(n)&&n.map((b,d)=>e.jsx(Fe,{label:b,className:"button",onClick:m=>f(b,m),sx:{backgroundColor:"transparent",border:"1px solid",boxShadow:"0px 2px 1px -1px rgba(0,0,0,0.2)",color:"#2196f3",transition:"all 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms","&:hover":{backgroundColor:h.isDarkMode?"rgba(0, 0, 0, 0.12)":"rgba(0, 0, 0, 0.05)",border:"1px solid"}}},d))})};Sa.propTypes={isGrid:u.bool,followUpPrompts:u.array,sx:u.object,onPromptClick:u.func};class Xr{constructor(n=10){this.history=[],this.currentIndex=-1,this.tempInput="",this.maxHistory=n,this.loadHistory()}addToHistory(n){n.trim()&&(this.history[0]!==n&&(this.history.unshift(n),this.history.length>this.maxHistory&&this.history.pop()),this.currentIndex=-1,this.saveHistory())}getPreviousInput(n){return this.currentIndex===-1&&(this.tempInput=n),this.currentIndex<this.history.length-1?(this.currentIndex++,this.history[this.currentIndex]):this.history[this.currentIndex]||this.tempInput}getNextInput(){return this.currentIndex>-1?(this.currentIndex--,this.currentIndex===-1?this.tempInput:this.history[this.currentIndex]):this.tempInput}saveHistory(){try{localStorage.setItem("chatInputHistory",JSON.stringify(this.history))}catch(n){console.warn("Failed to save chat history to localStorage:",n)}}loadHistory(){try{const n=localStorage.getItem("chatInputHistory");n&&(this.history=JSON.parse(n))}catch(n){console.warn("Failed to load chat history from localStorage:",n)}}}const Qr={width:"128px",height:"128px",objectFit:"cover"},Da=({item:s,disabled:n,customization:c,onDelete:f})=>{const[h,b]=r.useState(!1),d=c.isDarkMode?"rgba(0, 0, 0, 0.3)":"transparent";return e.jsxs("div",{onMouseEnter:()=>b(!0),onMouseLeave:()=>b(!1),style:{position:"relative",display:"inline-block"},children:[e.jsxs(Ge,{sx:{display:"inline-flex",alignItems:"center",height:"48px",width:"max-content",p:2,mr:1,flex:"0 0 auto",transition:"opacity 0.3s",opacity:1,backgroundColor:h?"rgba(0, 0, 0, 0.3)":d},variant:"outlined",children:[e.jsx(mt,{size:20,style:{transition:"filter 0.3s",filter:h?"blur(2px)":"none"}}),e.jsx("span",{style:{marginLeft:"5px",color:c.isDarkMode?"white":"inherit",transition:"filter 0.3s",filter:h?"blur(2px)":"none"},children:s.name})]}),h&&!n&&e.jsx(Z,{disabled:n,onClick:()=>f(s),startIcon:e.jsx(yt,{color:"white",size:22}),title:"Remove attachment",sx:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"transparent","&:hover":{backgroundColor:"transparent"}}})]})};Da.propTypes={item:u.object,customization:u.object,disabled:u.bool,onDelete:u.func};const Aa=({open:s,chatflowid:n,isAgentCanvas:c,isDialog:f,previews:h,setPreviews:b})=>{var Ns,Ps;const d=Oe(),m=Ie(t=>t.customization),D=r.useRef(),C=qe(),{onAgentflowNodeStatusUpdate:O,clearAgentflowNodeStatus:P}=r.useContext(Kt);jt();const H=(...t)=>C(rt(...t)),T=(...t)=>C(it(...t)),[L,_]=r.useState(""),[y,j]=r.useState(!1),[S,I]=r.useState([{message:"Hi there! How can I help?",type:"apiMessage"}]),[K,W]=r.useState(!1),[ee,x]=r.useState(!1),[p,k]=r.useState(!1),[M,R]=r.useState({}),[z,w]=r.useState(lr()),[U,B]=r.useState(!1),[V,ce]=r.useState([]),[Se,De]=r.useState(""),[we,oe]=r.useState(""),[ye]=r.useState(new Xr(10)),ge=r.useRef(null),ke=Pe(Gt.getInternalChatmessageFromChatflow),Ae=Pe(ar.getAllExecutions),E=Pe(tt.getIsChatflowStreaming),v=Pe(tt.getAllowChatflowUploads),N=Pe(tt.getSpecificChatflow),[G,se]=r.useState([]),[$,X]=r.useState(!1),[J,de]=r.useState("*"),[Ke,lt]=r.useState(!1),[kt,Xe]=r.useState(""),[vt,Y]=r.useState(!1),[te,be]=r.useState(null),[Te,Le]=r.useState(""),[xe,ze]=r.useState(""),[Ct,Fa]=r.useState(""),[Ra,ls]=r.useState(!1),[Na,cs]=r.useState(!1),[It,Pa]=r.useState(!1),[ds,Ve]=r.useState([]),us=r.useRef(null),ps=r.useRef(null),[He,Ua]=r.useState(!1),[$e,St]=r.useState(!1),[Dt,Oa]=r.useState(!1),[hs,At]=r.useState(!1),[La,Qe]=r.useState(!1),[fs,Tt]=r.useState(!1),[za,Ha]=r.useState(!1),[$a,Mt]=r.useState(!1),[gs,Et]=r.useState(""),[ms,Ft]=r.useState(null),[Ba,xs]=r.useState(""),[Wa,Ga]=r.useState(""),[qa,_a]=r.useState(""),[Va,Ja]=r.useState(""),[ys,bs]=r.useState({}),[js,Ya]=r.useState([]),[Ka,Rt]=r.useState(!0),ws=t=>{const o=v.data;let a=!1;if(!o)return console.warn("Upload constraints not loaded yet"),!1;if(o.isImageUploadAllowed){const i=t.type,l=t.size/1024/1024;o.imgUploadSizeAndTypes&&Array.isArray(o.imgUploadSizeAndTypes)&&o.imgUploadSizeAndTypes.forEach(g=>{g.fileTypes&&g.fileTypes.includes(i)&&l<=g.maxUploadSize&&(a=!0)})}if($)return!0;if(o.isRAGFileUploadAllowed){const i=t.name.split(".").pop();i&&o.fileUploadSizeAndTypes&&Array.isArray(o.fileUploadSizeAndTypes)&&o.fileUploadSizeAndTypes.forEach(l=>{(l.fileTypes&&l.fileTypes.length===1&&l.fileTypes[0]==="*"||l.fileTypes&&l.fileTypes.includes(`.${i}`))&&(a=!0)})}return a||alert("Cannot upload file. Kindly check the allowed file types and maximum allowed size."),a},Xa=async t=>{if(!He&&!$e)return;t.preventDefault(),At(!1);let o=[],a=[];if(t.dataTransfer.files.length>0){for(const l of t.dataTransfer.files){if(ws(l)===!1)return;const g=new FileReader,{name:A}=l;(!l.type||!Se.includes(l.type))&&a.push({file:l,type:$?"file:full":"file:rag"}),o.push(new Promise(Q=>{g.onload=F=>{var ae;if(!((ae=F==null?void 0:F.target)!=null&&ae.result))return;const{result:ue}=F.target;let me;l.type.startsWith("audio/")?me=Js:me=URL.createObjectURL(l),Q({data:ue,preview:me,type:"file",name:A,mime:l.type})},g.readAsDataURL(l)}))}const i=await Promise.all(o);ce(a),b(l=>[...l,...i])}if(t.dataTransfer.items)for(const i of t.dataTransfer.items)i.kind==="string"&&i.type.match("^text/uri-list")?i.getAsString(l=>{let g={data:l,preview:l,type:"url",name:l?l.substring(l.lastIndexOf("/")+1):""};b(A=>[...A,g])}):i.kind==="string"&&i.type.match("^text/html")&&i.getAsString(l=>{if(l.indexOf("href")===-1)return;let g=l?l.substring(l.indexOf("href")+6):"",A=g.substring(0,g.indexOf('"')),Q={data:A,preview:A,type:"url",name:A?A.substring(A.lastIndexOf("/")+1):""};b(F=>[...F,Q])})},ks=async t=>{if(!(t.target.files&&t.target.files[0]))return;let a=[],i=[];for(const g of t.target.files){if(ws(g)===!1)return;(!g.type||!Se.includes(g.type))&&i.push({file:g,type:$?"file:full":"file:rag"});const A=new FileReader,{name:Q}=g;a.push(new Promise(F=>{A.onload=ue=>{var ae;if(!((ae=ue==null?void 0:ue.target)!=null&&ae.result))return;const{result:me}=ue.target;F({data:me,preview:URL.createObjectURL(g),type:"file",name:Q,mime:g.type})},A.readAsDataURL(g)}))}const l=await Promise.all(a);ce(i),b(g=>[...g,...l]),t.target.value=null},Qa=t=>{let o="";const a=t.type.indexOf(";");a===-1?o=t.type:o=t.type?t.type.substring(0,a):"";const i=new FileReader;i.readAsDataURL(t),i.onloadend=()=>{const g={data:i.result,preview:Js,type:"audio",name:`audio_${Date.now()}.wav`,mime:o};b(A=>[...A,g])}},ct=t=>{(He||$e)&&(t.preventDefault(),t.stopPropagation(),t.type==="dragenter"||t.type==="dragover"?At(!0):t.type==="dragleave"&&At(!1))},Za=async()=>{B(!0);try{await Gt.abortMessage(n,z)}catch(t){B(!1),H({message:typeof t.response.data=="object"?t.response.data.message:t.response.data,options:{key:new Date().getTime()+Math.random(),variant:"error",persist:!0,action:o=>e.jsx(Z,{style:{color:"white"},onClick:()=>T(o),children:e.jsx(fe,{})})}})}},Nt=t=>{t.type==="file"&&URL.revokeObjectURL(t.preview),b(h.filter(o=>o!==t))},vs=()=>{ps.current.click()},Cs=()=>{us.current.click()},en=()=>{h.forEach(t=>URL.revokeObjectURL(t.preview)),b([])},tn=()=>{Qe(!0),Br(Qe,Tt)},Is=()=>{fs||Wr(),Qe(!1),Tt(!1)},sn=async()=>{Ha(!0),Ia(Qa)},Pt=(t,o)=>{R({data:t,title:o}),k(!0)},Ss=t=>{window.open(t,"_blank")},dt=()=>{D.current&&D.current.scrollTo({top:eo})},an=r.useCallback(t=>_(t.target.value),[_]),nn=t=>{I(o=>{let a=[...re.cloneDeep(o)];return a[a.length-1].type==="userMessage"||(a[a.length-1].message+=t,a[a.length-1].feedback=null),a})},on=t=>{I(o=>{let a=[...re.cloneDeep(o)];return a.push({message:t,type:"apiMessage"}),a})},rn=t=>{I(o=>{let a=[...re.cloneDeep(o)];return a[a.length-1].type==="userMessage"||(a[a.length-1].sourceDocuments=t),a})},ln=t=>{I(o=>{let a=[...re.cloneDeep(o)];return a[a.length-1].type==="userMessage"||(a[a.length-1].agentReasoning=t),a})},cn=t=>{I(t==="INPROGRESS"?o=>[...o,{message:"",type:"apiMessage",agentFlowEventStatus:t}]:o=>{let a=[...re.cloneDeep(o)];return a[a.length-1].type==="userMessage"||(a[a.length-1].agentFlowEventStatus=t),a})},dn=t=>{I(o=>{let a=[...re.cloneDeep(o)];return a[a.length-1].type==="userMessage"||(a[a.length-1].agentFlowExecutedData=t),a})},un=t=>{I(o=>{let a=[...re.cloneDeep(o)];return a[a.length-1].type==="userMessage"||(a[a.length-1].action=t),a})},pn=t=>{t.forEach(o=>{(o.type==="png"||o.type==="jpeg")&&(o.data=`${Ce}/api/v1/get-upload-file?chatflowId=${n}&chatId=${z}&fileName=${o.data.replace("FILE-STORAGE::","")}`)}),I(o=>{let a=[...re.cloneDeep(o)];return a[a.length-1].type==="userMessage"||(a[a.length-1].artifacts=t),a})},hn=t=>{I(o=>{let a=[...re.cloneDeep(o)];if(a[a.length-1].type==="userMessage")return a;const i=a[a.length-1].agentReasoning;return i&&i.length>0&&i.push({nextAgent:t}),a[a.length-1].agentReasoning=i,a})},fn=t=>{O(t)},gn=t=>{I(o=>{let a=[...re.cloneDeep(o)];return a[a.length-1].type==="userMessage"||(a[a.length-1].usedTools=t),a})},mn=t=>{I(o=>{let a=[...re.cloneDeep(o)];return a[a.length-1].type==="userMessage"||(a[a.length-1].fileAnnotations=t),a})},xn=()=>{B(!1),I(t=>{let o=[...re.cloneDeep(t)];if(o[o.length-1].type==="userMessage")return o;const a=o[o.length-1].agentReasoning;return a&&a.length>0&&(o[o.length-1].agentReasoning=a.filter(i=>!i.nextAgent)),o}),setTimeout(()=>{var t;(t=ge.current)==null||t.focus()},100),H({message:"Message stopped",options:{key:new Date().getTime()+Math.random(),variant:"success",action:t=>e.jsx(Z,{style:{color:"white"},onClick:()=>T(t),children:e.jsx(fe,{})})}})},Ds=(t="Oops! There seems to be an error. Please try again.")=>{t=t.replace(`Unable to parse JSON response from chat agent.

`,""),I(o=>[...o,{message:t,type:"apiMessage"}]),j(!1),_(""),ce([]),setTimeout(()=>{var o;(o=ge.current)==null||o.focus()},100)},As=async t=>{_(t),Be(void 0,t)},yn=async t=>{_(t),Ve([]),Be(void 0,t)},Ts=(t,o="",a="")=>{let i=Ba;a&&(i=a);const l=o||i.charAt(0).toUpperCase()+i.slice(1);Be(void 0,l,void 0,{type:i,startNodeId:t==null?void 0:t.nodeId,feedback:o})},Ms=()=>{ms&&(Ts(ms,gs),Mt(!1),Et(""),Ft(null),xs(""))},Ut=async(t,o)=>{if(_(t.label),I(a=>{let i=[...re.cloneDeep(a)];return i[i.length-1].type==="userMessage"||(i[i.length-1].action=null),i}),t.type.includes("agentflowv2")){const a=t.type.includes("approve")?"proceed":"reject";xs(a),o.data&&o.data.input&&o.data.input.humanInputEnableFeedback?(Ft(o.data),Mt(!0)):Ts(o.data,"",a)}else Be(void 0,t.label,o)},Es=(t,o)=>{if(t.chatMessageId&&I(a=>{let i=[...re.cloneDeep(a)];return i[i.length-1].type==="apiMessage"&&(i[i.length-1].id=t.chatMessageId),i}),t.chatId&&w(t.chatId),o===""&&t.question&&I(a=>{let i=[...re.cloneDeep(a)];return i[i.length-2].type==="apiMessage"||(i[i.length-2].message=t.question),i}),t.followUpPrompts){const a=JSON.parse(t.followUpPrompts);Ve(typeof a=="string"?JSON.parse(a):a)}},bn=async t=>{if(!V.length)return t;if($){const o=V.filter(a=>a.type==="file:full");if(o.length>0){const a=new FormData;for(const g of o)a.append("files",g.file);a.append("chatId",z);const l=(await Jr.createAttachment(n,z,a)).data;for(const g of l){const A=g.content,Q=g.name,F=t.findIndex(ue=>ue.name===Q);F!==-1&&(t[F]={...t[F],data:A,name:Q,type:"file:full"})}}}else if(Dt){const o=V.filter(a=>a.type==="file:rag");if(o.length>0){const a=new FormData;for(const l of o)a.append("files",l.file);a.append("chatId",z),await qt.upsertVectorStoreWithFormData(n,a),await(l=>new Promise(g=>setTimeout(g,l)))(2500),t=t.map(l=>({...l,type:"file:rag"}))}}return t},Be=async(t,o,a,i)=>{if(t&&t.preventDefault(),!o&&L.trim()===""){const A=h.filter(Q=>!Q.mime.startsWith("image")&&Q.type!=="audio").length>0;if(!h.length||h.length&&A)return}let l=L;typeof o=="string"?(o!==void 0&&o.trim()!==""&&(l=o),l.trim()&&ye.addToHistory(l)):typeof o=="object"&&(l=Object.entries(o).map(([A,Q])=>`${A}: ${Q}`).join(`
`)),j(!0),P();let g=h.map(A=>({data:A.data,type:A.type,name:A.name,mime:A.mime}));try{g=await bn(g)}catch{Ds("Unable to upload documents");return}en(),I(A=>[...A,{message:l,type:"userMessage",fileUploads:g}]);try{const A={question:l,chatId:z};if(typeof o=="object"&&(A.form=o,delete A.question),g&&g.length>0&&(A.uploads=g),xe&&(A.leadEmail=xe),a&&(A.action=a),i&&(A.humanInput=i),K)jn(n,A);else{const Q=await nr.sendMessageAndGetPrediction(n,A);if(Q.data){const F=Q.data;Es(F,l);let ue="";F.text?ue=F.text:F.json?ue="```json\n"+JSON.stringify(F.json,null,2):ue=JSON.stringify(F,null,2),I(me=>[...me,{message:ue,id:F==null?void 0:F.chatMessageId,sourceDocuments:F==null?void 0:F.sourceDocuments,usedTools:F==null?void 0:F.usedTools,calledTools:F==null?void 0:F.calledTools,fileAnnotations:F==null?void 0:F.fileAnnotations,agentReasoning:F==null?void 0:F.agentReasoning,agentFlowExecutedData:F==null?void 0:F.agentFlowExecutedData,action:F==null?void 0:F.action,artifacts:F==null?void 0:F.artifacts,type:"apiMessage",feedback:null}]),et(n,F.chatId),j(!1),_(""),ce([]),setTimeout(()=>{var me;(me=ge.current)==null||me.focus(),dt()},100)}}}catch(A){Ds(A.response.data.message);return}},jn=async(t,o)=>{const a=o.chatId,i=o.question;o.streaming=!0,await Dr(`${Ce}/api/v1/internal-prediction/${t}`,{openWhenHidden:!0,method:"POST",body:JSON.stringify(o),headers:{"Content-Type":"application/json","x-request-from":"internal"},async onopen(l){l.ok&&l.headers.get("content-type")},async onmessage(l){const g=JSON.parse(l.data);switch(g.event){case"start":I(A=>[...A,{message:"",type:"apiMessage"}]);break;case"token":nn(g.data);break;case"sourceDocuments":rn(g.data);break;case"usedTools":gn(g.data);break;case"fileAnnotations":mn(g.data);break;case"agentReasoning":ln(g.data);break;case"agentFlowEvent":cn(g.data);break;case"agentFlowExecutedData":dn(g.data);break;case"artifacts":pn(g.data);break;case"action":un(g.data);break;case"nextAgent":hn(g.data);break;case"nextAgentFlow":fn(g.data);break;case"metadata":Es(g.data,i);break;case"error":on(g.data);break;case"abort":xn(g.data),ut();break;case"end":et(t,a),ut();break}},async onclose(){ut()},async onerror(l){throw console.error("EventSource Error: ",l),ut(),l}})},ut=()=>{j(!1),_(""),ce([]),setTimeout(()=>{var t;(t=ge.current)==null||t.focus(),dt()},100)},wn=t=>{const o=t.isComposing||t.keyCode===229;if(t.key==="ArrowUp"&&!o){t.preventDefault();const a=ye.getPreviousInput(L);_(a)}else if(t.key==="ArrowDown"&&!o){t.preventDefault();const a=ye.getNextInput();_(a)}else t.key==="Enter"&&L&&!o?!t.shiftKey&&L&&Be(t):t.key==="Enter"&&t.preventDefault()},Fs=(t,o)=>{if(t&&typeof t=="object"){if(t.pathname&&typeof t.pathname=="string")return t.pathname.substring(0,15)==="/"?t.host||"":`${t.pathname.substring(0,15)}...`;if(t.host)return t.host}return o&&o.pageContent&&typeof o.pageContent=="string"?`${o.pageContent.substring(0,15)}...`:""},kn=()=>$?J===""?"*":J:we.includes("*")?"*":we||"*",vn=async t=>{try{const o=await to.post(`${Ce}/api/v1/openai-assistants-file/download`,{fileName:t.fileName,chatflowId:n,chatId:z},{responseType:"blob"}),a=new Blob([o.data],{type:o.headers["content-type"]}),i=window.URL.createObjectURL(a),l=document.createElement("a");l.href=i,l.download=t.fileName,document.body.appendChild(l),l.click(),l.remove()}catch(o){console.error("Download failed:",o)}},Cn=(t,o)=>t?`${Ce}/api/v1/node-icon/${t}`:o?fo:go;r.useEffect(()=>{var t,o;if((t=ke.data)!=null&&t.length){const a=(o=ke.data[0])==null?void 0:o.chatId;w(a);const i=ke.data.map(l=>{const g={id:l.id,message:l.content,feedback:l.feedback,type:l.role};return l.sourceDocuments&&(g.sourceDocuments=l.sourceDocuments),l.usedTools&&(g.usedTools=l.usedTools),l.fileAnnotations&&(g.fileAnnotations=l.fileAnnotations),l.agentReasoning&&(g.agentReasoning=l.agentReasoning),l.action&&(g.action=l.action),l.artifacts&&(g.artifacts=l.artifacts,g.artifacts.forEach(A=>{(A.type==="png"||A.type==="jpeg")&&(A.data=`${Ce}/api/v1/get-upload-file?chatflowId=${n}&chatId=${a}&fileName=${A.data.replace("FILE-STORAGE::","")}`)})),l.fileUploads&&(g.fileUploads=l.fileUploads,g.fileUploads.forEach(A=>{A.type==="stored-file"&&(A.data=`${Ce}/api/v1/get-upload-file?chatflowId=${n}&chatId=${a}&fileName=${A.name}`)})),l.followUpPrompts&&(g.followUpPrompts=JSON.parse(l.followUpPrompts)),l.role==="apiMessage"&&l.execution&&l.execution.executionData&&(g.agentFlowExecutedData=JSON.parse(l.execution.executionData)),g});I(l=>[...l,...i]),et(n,a)}},[ke.data]),r.useEffect(()=>{var t,o;if((t=Ae.data)!=null&&t.length){const a=(o=Ae.data[0])==null?void 0:o.sessionId;w(a);const i=Ae.data.map(l=>{const g=typeof l.executionData=="string"?JSON.parse(l.executionData):l.executionData;return{id:l.id,agentFlow:g}});I(l=>[...l,...i]),et(n,a)}},[Ae.data]),r.useEffect(()=>{var t;E.data&&W(((t=E.data)==null?void 0:t.isStreaming)??!1)},[E.data]),r.useEffect(()=>{var t,o,a,i,l;v.data&&(Ua(((t=v.data)==null?void 0:t.isImageUploadAllowed)??!1),Oa(((o=v.data)==null?void 0:o.isRAGFileUploadAllowed)??!1),x(((a=v.data)==null?void 0:a.isSpeechToTextEnabled)??!1),De((i=v.data)==null?void 0:i.imgUploadSizeAndTypes.map(g=>g.fileTypes).join(",")),oe((l=v.data)==null?void 0:l.fileUploadSizeAndTypes.map(g=>g.fileTypes).join(",")))},[v.data]),r.useEffect(()=>{var t,o,a,i,l,g,A,Q,F,ue,me;if(N.data){if(Rt(!1),(t=N.data)!=null&&t.flowData){const ve=(JSON.parse((o=N.data)==null?void 0:o.flowData).nodes??[]).find(je=>je.data.name==="startAgentflow");if(ve){const je=(a=ve.data.inputs)==null?void 0:a.startInputType;Ga(je);const Ze=(i=ve.data.inputs)==null?void 0:i.formInputTypes;if(je==="formInput"&&Ze&&Ze.length>0){for(const Ot of Ze)Ot.type==="options"&&(Ot.options=Ot.addOptions.map(Us=>({label:Us.option,name:Us.option})));Ya(Ze),bs({id:"formInput",inputs:{},inputParams:Ze}),_a((l=ve.data.inputs)==null?void 0:l.formTitle),Ja((g=ve.data.inputs)==null?void 0:g.formDescription)}Ae.request({agentflowId:n})}}if((A=N.data)!=null&&A.chatbotConfig&&JSON.parse((Q=N.data)==null?void 0:Q.chatbotConfig)){let ae=JSON.parse((F=N.data)==null?void 0:F.chatbotConfig);if(ae.starterPrompts){let ve=[];Object.getOwnPropertyNames(ae.starterPrompts).forEach(je=>{ae.starterPrompts[je]&&ve.push(ae.starterPrompts[je])}),se(ve.filter(je=>je.prompt!==""))}ae.chatFeedback&&lt(ae.chatFeedback.status),ae.leads&&(be(ae.leads),ae.leads.status&&!gt(n).lead&&I(ve=>{const je={message:"",type:"leadCaptureMessage"};return[...ve,je]})),ae.followUpPrompts&&Pa(ae.followUpPrompts.status),ae.fullFileUpload&&(X(ae.fullFileUpload.status),(ue=ae.fullFileUpload)!=null&&ue.allowedUploadFileTypes&&de((me=ae.fullFileUpload)==null?void 0:me.allowedUploadFileTypes))}}},[N.data]),r.useEffect(()=>{N.error&&Rt(!1)},[N.error]),r.useEffect(()=>{St($?!0:!!Dt)},[Dt,$]),r.useEffect(()=>{dt()},[S]),r.useEffect(()=>{f&&ge&&setTimeout(()=>{var t;(t=ge.current)==null||t.focus()},100)},[f,ge]),r.useEffect(()=>{var t;if(s&&n){ke.request(n),E.request(n),v.request(n),N.request(n),setTimeout(()=>{dt()},100),Qe(!1),Rt(!0);const o=(t=gt(n))==null?void 0:t.lead;o&&(cs(!!o),ze(o.email))}return()=>{_(""),ce([]),j(!1),I([{message:"Hi there! How can I help?",type:"apiMessage"}])}},[s,n]),r.useEffect(()=>{const t=h.filter(o=>o.type==="audio").length>0;h.length>=1&&t&&(Qe(!1),Tt(!1),As(""))},[h]),r.useEffect(()=>{if(It&&S.length>0){const t=S[S.length-1];if(t.type==="apiMessage"&&t.followUpPrompts){if(Array.isArray(t.followUpPrompts)&&Ve(t.followUpPrompts),typeof t.followUpPrompts=="string"){const o=JSON.parse(t.followUpPrompts);Ve(o)}}else t.type==="userMessage"&&Ve([])}},[It,S]);const In=async t=>{try{await navigator.clipboard.writeText(t||"")}catch(o){console.error("Error copying to clipboard:",o)}},Sn=async t=>{const o={chatflowid:n,chatId:z,messageId:t,rating:"THUMBS_UP",content:""},a=await Bt.addFeedback(n,o);if(a.data){const i=a.data;let l="";i&&i.id&&(l=i.id),I(g=>[...re.cloneDeep(g)].map(Q=>(Q.id===t&&(Q.feedback={rating:"THUMBS_UP"}),Q))),Xe(l),Y(!0)}},Dn=async t=>{const o={chatflowid:n,chatId:z,messageId:t,rating:"THUMBS_DOWN",content:""},a=await Bt.addFeedback(n,o);if(a.data){const i=a.data;let l="";i&&i.id&&(l=i.id),I(g=>[...re.cloneDeep(g)].map(Q=>(Q.id===t&&(Q.feedback={rating:"THUMBS_DOWN"}),Q))),Xe(l),Y(!0)}},An=async t=>{const o={content:t};(await Bt.updateFeedback(kt,o)).data&&(Xe(""),Y(!1))},Tn=async t=>{t&&t.preventDefault(),ls(!0);const o={chatflowid:n,chatId:z,name:Te,email:xe,phone:Ct},a=await mo.addLead(o);if(a.data){const i=a.data;w(i.chatId),et(n,i.chatId,{lead:{name:Te,email:xe,phone:Ct}}),cs(!0),ze(xe),I(l=>{let g=[...re.cloneDeep(l)];return g[g.length-1].type!=="leadCaptureMessage"||(g[g.length-1].message=te.successMessage||"Thank you for submitting your contact information."),g})}ls(!1)},le=()=>y||!n||(te==null?void 0:te.status)&&!Na||S[S.length-1].action&&Object.keys(S[S.length-1].action).length>0,Mn=t=>{var o,a;return t.mime.startsWith("image/")?e.jsxs(Pr,{focusRipple:!0,style:{width:"48px",height:"48px",marginRight:"10px",flex:"0 0 auto"},disabled:le(),onClick:()=>Nt(t),children:[e.jsx(Ur,{style:{backgroundImage:`url(${t.data})`}}),e.jsx(Or,{className:"MuiImageBackdrop-root"}),e.jsx(Lr,{className:"MuiImageMarked-root",children:e.jsx(yt,{size:20,color:"white"})})]}):t.mime.startsWith("audio/")?e.jsxs(Ge,{sx:{display:"inline-flex",alignItems:"center",height:"48px",width:f?((o=D==null?void 0:D.current)==null?void 0:o.offsetWidth)/4:((a=D==null?void 0:D.current)==null?void 0:a.offsetWidth)/2,p:.5,mr:1,backgroundColor:d.palette.grey[500],flex:"0 0 auto"},variant:"outlined",children:[e.jsx(Ht,{component:"audio",sx:{color:"transparent"},controls:!0,src:t.data}),e.jsx(pe,{disabled:le(),onClick:()=>Nt(t),size:"small",children:e.jsx(yt,{size:20,color:"white"})})]}):e.jsx(Da,{disabled:le(),item:t,customization:m,onDelete:()=>Nt(t)})},En=(t,o)=>{var a,i;return(a=t==null?void 0:t.mime)!=null&&a.startsWith("image/")?e.jsx(Ge,{sx:{p:0,m:0,maxWidth:128,marginRight:"10px",flex:"0 0 auto"},children:e.jsx(Ht,{component:"img",image:t.data,sx:{height:64},alt:"preview",style:Qr})},o):(i=t==null?void 0:t.mime)!=null&&i.startsWith("audio/")?e.jsxs("audio",{controls:"controls",children:["Your browser does not support the <audio> tag.",e.jsx("source",{src:t.data,type:t.mime})]}):e.jsxs(Ge,{sx:{display:"inline-flex",alignItems:"center",height:"48px",width:"max-content",p:2,mr:1,flex:"0 0 auto",backgroundColor:m.isDarkMode?"rgba(0, 0, 0, 0.3)":"transparent"},variant:"outlined",children:[e.jsx(mt,{size:20}),e.jsx("span",{style:{marginLeft:"5px",color:m.isDarkMode?"white":"inherit"},children:t.name})]})},Fn=t=>{const o=re.cloneDeep(t);for(let a=0;a<o.length;a++){const i=o[a];if(i&&(i.type==="png"||i.type==="jpeg")){const l=i.data;o[a].data=`${Ce}/api/v1/get-upload-file?chatflowId=${n}&chatId=${z}&fileName=${l.replace("FILE-STORAGE::","")}`}}return o},Rs=(t,o,a)=>t.type==="png"||t.type==="jpeg"?e.jsx(Ge,{sx:{p:0,m:0,mt:2,mb:2,flex:"0 0 auto"},children:e.jsx(Ht,{component:"img",image:t.data,sx:{height:"auto"},alt:"artifact",style:{width:a?"200px":"100%",height:a?"200px":"auto",objectFit:"cover"}})},o):t.type==="html"?e.jsx("div",{style:{marginTop:"20px"},children:e.jsx("div",{dangerouslySetInnerHTML:{__html:t.data}})}):e.jsx(_t,{chatflowid:n,isFullWidth:f,children:t.data});return Ka?e.jsx(q,{sx:{width:"100%",height:"100%",position:"relative",backgroundColor:d.palette.background.paper},children:e.jsx(q,{sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)"},children:e.jsx(zt,{})})}):Wa==="formInput"&&S.length===1?e.jsx(q,{sx:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",p:2,backgroundColor:d.palette.background.paper},children:e.jsx(q,{sx:{width:"100%",height:"100%",position:"relative"},children:e.jsxs(q,{sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"100%",maxWidth:"600px",maxHeight:"90%",p:3,backgroundColor:m.isDarkMode?Zn(d.palette.background.paper,.2):d.palette.background.paper,boxShadow:m.isDarkMode?"0px 0px 15px 0px rgba(255, 255, 255, 0.1)":d.shadows[3],borderRadius:2,overflowY:"auto"},children:[e.jsx(ne,{variant:"h4",sx:{mb:1,textAlign:"center"},children:qa||"Please Fill Out The Form"}),e.jsx(ne,{variant:"body1",sx:{mb:3,textAlign:"center",color:d.palette.text.secondary},children:Va||"Complete all fields below to continue"}),e.jsx(q,{sx:{mb:3},children:js&&js.map((t,o)=>e.jsx(q,{sx:{mb:2},children:e.jsx(No,{inputParam:t,data:ys,isAdditionalParams:!0,onCustomDataChange:({inputParam:a,newValue:i})=>{bs(l=>({...l,inputs:{...l.inputs,[a.name]:i}}))}})},o))}),e.jsx(Z,{variant:"contained",fullWidth:!0,disabled:y,onClick:()=>Be(null,ys.inputs),sx:{mb:2,borderRadius:20,background:"linear-gradient(45deg, #673ab7 30%, #1e88e5 90%)"},children:y?"Submitting...":"Submit"})]})})}):e.jsxs("div",{onDragEnter:ct,children:[hs&&e.jsx("div",{className:"image-dropzone",onDragEnter:ct,onDragLeave:ct,onDragEnd:ct,onDrop:Xa}),hs&&(((Ns=v.data)==null?void 0:Ns.isImageUploadAllowed)||((Ps=v.data)==null?void 0:Ps.isRAGFileUploadAllowed))&&e.jsxs(q,{className:"drop-overlay",children:[e.jsx(ne,{variant:"h2",children:"Drop here to upload"}),[...v.data.imgUploadSizeAndTypes,...v.data.fileUploadSizeAndTypes].map(t=>{var o;return e.jsxs(e.Fragment,{children:[e.jsx(ne,{variant:"subtitle1",children:(o=t.fileTypes)==null?void 0:o.join(", ")}),t.maxUploadSize&&e.jsxs(ne,{variant:"subtitle1",children:["Max Allowed Size: ",t.maxUploadSize," MB"]})]})})]}),e.jsx("div",{ref:D,className:`${f?"cloud-dialog":"cloud"}`,children:e.jsx("div",{id:"messagelist",className:"messagelist",children:S&&S.map((t,o)=>{var a;return e.jsxs(q,{sx:{background:t.type==="apiMessage"||t.type==="leadCaptureMessage"?d.palette.asyncSelect.main:""},style:{display:"flex"},className:t.type==="userMessage"&&y&&o===S.length-1?m.isDarkMode?"usermessagewaiting-dark":"usermessagewaiting-light":t.type==="usermessagewaiting"?"apimessage":"usermessage",children:[t.type==="apiMessage"||t.type==="leadCaptureMessage"?e.jsx("img",{src:Bo,alt:"AI",width:"30",height:"30",className:"boticon"}):e.jsx("img",{src:po,alt:"Me",width:"30",height:"30",className:"usericon"}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",width:"100%"},children:[t.fileUploads&&t.fileUploads.length>0&&e.jsx("div",{style:{display:"flex",flexWrap:"wrap",flexDirection:"column",width:"100%",gap:"8px"},children:t.fileUploads.map((i,l)=>e.jsx(e.Fragment,{children:En(i,l)}))}),t.agentReasoning&&t.agentReasoning.length>0&&e.jsx("div",{style:{display:"block",flexDirection:"row",width:"100%"},children:t.agentReasoning.map((i,l)=>e.jsx(ns,{agent:i,index:l,customization:m,chatflowid:n,isDialog:f,onSourceDialogClick:Pt,renderArtifacts:Rs,agentReasoningArtifacts:Fn,getAgentIcon:Cn,removeDuplicateURL:Hs,isValidURL:$s,onURLClick:Ss,getLabel:Fs},l))}),t.agentFlowExecutedData&&Array.isArray(t.agentFlowExecutedData)&&t.agentFlowExecutedData.length>0&&e.jsx(Nr,{status:t.agentFlowEventStatus,execution:t.agentFlowExecutedData,agentflowId:n,sessionId:z}),t.usedTools&&e.jsx("div",{style:{display:"block",flexDirection:"row",width:"100%"},children:t.usedTools.map((i,l)=>i?e.jsx(Fe,{size:"small",label:i.tool,component:"a",sx:{mr:1,mt:1,borderColor:i.error?"error.main":void 0,color:i.error?"error.main":void 0},variant:"outlined",clickable:!0,icon:e.jsx(oa,{size:15,color:i.error?d.palette.error.main:void 0}),onClick:()=>Pt(i,"Used Tools")},l):null)}),t.artifacts&&e.jsx("div",{style:{display:"flex",flexWrap:"wrap",flexDirection:"column",width:"100%"},children:t.artifacts.map((i,l)=>i!==null?e.jsx(e.Fragment,{children:Rs(i,l)}):null)}),e.jsx("div",{className:"markdownanswer",children:t.type==="leadCaptureMessage"&&!((a=gt(n))!=null&&a.lead)&&te.status?e.jsxs(q,{sx:{display:"flex",flexDirection:"column",gap:2,marginTop:2},children:[e.jsx(ne,{sx:{lineHeight:"1.5rem",whiteSpace:"pre-line"},children:te.title||"Let us know where we can reach you:"}),e.jsxs("form",{style:{display:"flex",flexDirection:"column",gap:"8px",width:f?"50%":"100%"},onSubmit:Tn,children:[te.name&&e.jsx(Ue,{id:"leadName",type:"text",fullWidth:!0,placeholder:"Name",name:"leadName",value:Te,autoFocus:!0,onChange:i=>Le(i.target.value)}),te.email&&e.jsx(Ue,{id:"leadEmail",type:"email",fullWidth:!0,placeholder:"Email Address",name:"leadEmail",value:xe,onChange:i=>ze(i.target.value)}),te.phone&&e.jsx(Ue,{id:"leadPhone",type:"number",fullWidth:!0,placeholder:"Phone Number",name:"leadPhone",value:Ct,onChange:i=>Fa(i.target.value)}),e.jsx(q,{sx:{display:"flex",alignItems:"center"},children:e.jsx(Z,{variant:"outlined",fullWidth:!0,type:"submit",sx:{borderRadius:"20px"},children:Ra?"Saving...":"Save"})})]})]}):e.jsx(e.Fragment,{children:e.jsx(_t,{chatflowid:n,isFullWidth:f,children:t.message})})}),t.fileAnnotations&&e.jsx("div",{style:{display:"block",flexDirection:"row",width:"100%",marginBottom:"8px"},children:t.fileAnnotations.map((i,l)=>e.jsx(Z,{sx:{fontSize:"0.85rem",textTransform:"none",mb:1},variant:"outlined",onClick:()=>vn(i),endIcon:e.jsx(Io,{color:d.palette.primary.main}),children:i.fileName},l))}),t.sourceDocuments&&e.jsx("div",{style:{display:"block",flexDirection:"row",width:"100%",marginBottom:"8px"},children:Hs(t).map((i,l)=>{const g=i.metadata&&i.metadata.source?$s(i.metadata.source):void 0;return e.jsx(Fe,{size:"small",label:Fs(g,i)||"",component:"a",sx:{mr:1,mb:1},variant:"outlined",clickable:!0,onClick:()=>g?Ss(i.metadata.source):Pt(i)},l)})}),t.action&&e.jsx("div",{style:{display:"flex",flexWrap:"wrap",flexDirection:"row",width:"100%",gap:"8px",marginBottom:"8px"},children:(t.action.elements||[]).map((i,l)=>e.jsx(e.Fragment,{children:i.type==="approve-button"&&i.label==="Yes"||i.type==="agentflowv2-approve-button"?e.jsx(Z,{sx:{width:"max-content",borderRadius:"20px",background:m.isDarkMode?"transparent":"white"},variant:"outlined",color:"success",startIcon:e.jsx(Zs,{}),onClick:()=>Ut(i,t.action),children:i.label},l):i.type==="reject-button"&&i.label==="No"||i.type==="agentflowv2-reject-button"?e.jsx(Z,{sx:{width:"max-content",borderRadius:"20px",background:m.isDarkMode?"transparent":"white"},variant:"outlined",color:"error",startIcon:e.jsx(fe,{}),onClick:()=>Ut(i,t.action),children:i.label},l):e.jsx(Z,{sx:{width:"max-content",borderRadius:"20px",background:"white"},variant:"outlined",onClick:()=>Ut(i,t.action),children:i.label},l)}))}),t.type==="apiMessage"&&t.id&&Ke?e.jsx(e.Fragment,{children:e.jsxs(q,{sx:{display:"flex",alignItems:"center",justifyContent:"start",gap:1},children:[e.jsx(ya,{onClick:()=>In(t.message)}),!t.feedback||t.feedback.rating===""||t.feedback.rating==="THUMBS_UP"?e.jsx(ba,{isDisabled:t.feedback&&t.feedback.rating==="THUMBS_UP",rating:t.feedback?t.feedback.rating:"",onClick:()=>Sn(t.id)}):null,!t.feedback||t.feedback.rating===""||t.feedback.rating==="THUMBS_DOWN"?e.jsx(ja,{isDisabled:t.feedback&&t.feedback.rating==="THUMBS_DOWN",rating:t.feedback?t.feedback.rating:"",onClick:()=>Dn(t.id)}):null]})}):null]})]},o)})})}),S&&S.length===1&&G.length>0&&e.jsx("div",{style:{position:"relative"},children:e.jsx(ha,{sx:{bottom:h&&h.length>0?70:0},starterPrompts:G||[],onPromptClick:As,isGrid:f})}),S&&S.length>2&&It&&ds.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(at,{sx:{width:"100%"}}),e.jsxs(q,{sx:{display:"flex",flexDirection:"column",position:"relative",pt:1.5},children:[e.jsxs(Ee,{sx:{flexDirection:"row",alignItems:"center",px:1.5,gap:.5},children:[e.jsx(Xt,{size:12}),e.jsx(ne,{sx:{fontSize:"0.75rem"},variant:"body2",children:"Try these prompts"})]}),e.jsx(Sa,{sx:{bottom:h&&h.length>0?70:0},followUpPrompts:ds||[],onPromptClick:yn,isGrid:f})]})]}),e.jsx(at,{sx:{width:"100%"}}),e.jsxs("div",{className:"center",children:[h&&h.length>0&&e.jsx(q,{sx:{width:"100%",mb:1.5,display:"flex",alignItems:"center"},children:h.map((t,o)=>e.jsx(r.Fragment,{children:Mn(t)},o))}),La?e.jsx(e.Fragment,{children:fs?e.jsx("div",{className:"overlay",children:e.jsxs("div",{className:"browser-not-supporting-audio-recording-box",children:[e.jsx(ne,{variant:"body1",children:"To record audio, use modern browsers like Chrome or Firefox that support audio recording."}),e.jsx(Z,{variant:"contained",color:"error",size:"small",type:"button",onClick:()=>Is(),children:"Okay"})]})}):e.jsxs(q,{sx:{width:"100%",height:"54px",px:2,border:"1px solid",borderRadius:3,backgroundColor:m.isDarkMode?"#32353b":"#fafafa",borderColor:"rgba(0, 0, 0, 0.23)",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs("div",{className:"recording-elapsed-time",children:[e.jsx("span",{className:"red-recording-dot",children:e.jsx(dr,{})}),e.jsx(ne,{id:"elapsed-time",children:"00:00"}),za&&e.jsx(ne,{ml:1.5,children:"Sending..."})]}),e.jsxs("div",{className:"recording-control-buttons-container",children:[e.jsx(pe,{onClick:Is,size:"small",children:e.jsx(fe,{color:y||!n?"#9e9e9e":m.isDarkMode?"white":"#1e88e5"})}),e.jsx(pe,{onClick:sn,size:"small",children:e.jsx($t,{color:y||!n?"#9e9e9e":m.isDarkMode?"white":"#1e88e5"})})]})]})}):e.jsxs("form",{style:{width:"100%"},onSubmit:Be,children:[e.jsx(Ue,{inputRef:ge,autoFocus:!0,sx:{width:"100%"},disabled:le(),onKeyDown:wn,id:"userInput",name:"userInput",placeholder:y?"Waiting for response...":"Type your question...",value:L,onChange:an,multiline:!0,maxRows:f?7:2,startAdornment:e.jsxs(e.Fragment,{children:[He&&!$e&&e.jsx(Me,{position:"start",sx:{ml:2},children:e.jsx(pe,{onClick:Cs,type:"button",disabled:le(),edge:"start",children:e.jsx(Gs,{color:le()?"#9e9e9e":m.isDarkMode?"white":"#1e88e5"})})}),!He&&$e&&e.jsx(Me,{position:"start",sx:{ml:2},children:e.jsx(pe,{onClick:vs,type:"button",disabled:le(),edge:"start",children:e.jsx(mt,{color:le()?"#9e9e9e":m.isDarkMode?"white":"#1e88e5"})})}),He&&$e&&e.jsxs(Me,{position:"start",sx:{ml:2},children:[e.jsx(pe,{onClick:Cs,type:"button",disabled:le(),edge:"start",children:e.jsx(Gs,{color:le()?"#9e9e9e":m.isDarkMode?"white":"#1e88e5"})}),e.jsx(pe,{sx:{ml:0},onClick:vs,type:"button",disabled:le(),edge:"start",children:e.jsx(mt,{color:le()?"#9e9e9e":m.isDarkMode?"white":"#1e88e5"})})]}),!He&&!$e&&e.jsx(q,{sx:{pl:1}})]}),endAdornment:e.jsxs(e.Fragment,{children:[ee&&e.jsx(Me,{position:"end",children:e.jsx(pe,{onClick:()=>tn(),type:"button",disabled:le(),edge:"end",children:e.jsx(ur,{className:"start-recording-button",color:le()?"#9e9e9e":m.isDarkMode?"white":"#1e88e5"})})}),!c&&e.jsx(Me,{position:"end",sx:{paddingRight:"15px"},children:e.jsx(pe,{type:"submit",disabled:le(),edge:"end",children:y?e.jsx("div",{children:e.jsx(zt,{color:"inherit",size:20})}):e.jsx($t,{color:le()?"#9e9e9e":m.isDarkMode?"white":"#1e88e5"})})}),c&&e.jsxs(e.Fragment,{children:[!y&&e.jsx(Me,{position:"end",sx:{paddingRight:"15px"},children:e.jsx(pe,{type:"submit",disabled:le(),edge:"end",children:e.jsx($t,{color:le()?"#9e9e9e":m.isDarkMode?"white":"#1e88e5"})})}),y&&e.jsx(Me,{position:"end",sx:{padding:"15px",mr:1},children:e.jsx(pe,{edge:"end",title:U?"Stopping...":"Stop",style:{border:U?"none":"2px solid red"},onClick:()=>Za(),disabled:U,children:U?e.jsx("div",{children:e.jsx(zt,{color:"error",size:20})}):e.jsx(gr,{size:15,color:"red"})})})]})]})}),He&&e.jsx("input",{style:{display:"none"},multiple:!0,ref:us,type:"file",onChange:ks,accept:Se||"*"}),$e&&e.jsx("input",{style:{display:"none"},multiple:!0,ref:ps,type:"file",onChange:ks,accept:kn()})]})]}),e.jsx(ho,{show:p,dialogProps:M,onCancel:()=>k(!1)}),e.jsx(Tr,{show:vt,onCancel:()=>Y(!1),onConfirm:An}),e.jsxs(Je,{maxWidth:"md",fullWidth:!0,open:$a,onClose:()=>{Mt(!1),Ft(null),Et("")},children:[e.jsx(nt,{variant:"h5",children:"Provide Feedback"}),e.jsx(Ye,{children:e.jsx(ra,{autoFocus:!0,margin:"dense",label:"Feedback",fullWidth:!0,multiline:!0,rows:4,value:gs,onChange:t=>Et(t.target.value)})}),e.jsxs(ot,{children:[e.jsx(Z,{onClick:Ms,children:"Cancel"}),e.jsx(Z,{onClick:Ms,variant:"contained",children:"Submit"})]})]})]})};Aa.propTypes={open:u.bool,chatflowid:u.string,isAgentCanvas:u.bool,isDialog:u.bool,previews:u.array,setPreviews:u.func};const Ta=r.memo(Aa),Ma=({show:s,dialogProps:n,isAgentCanvas:c,onClear:f,onCancel:h,previews:b,setPreviews:d})=>{const m=document.getElementById("portal"),D=Ie(O=>O.customization),C=s?e.jsxs(Je,{open:s,fullWidth:!0,maxWidth:"md",onClose:h,"aria-labelledby":"alert-dialog-title","aria-describedby":"alert-dialog-description",sx:{overflow:"visible"},children:[e.jsx(nt,{sx:{fontSize:"1rem",p:1.5},id:"alert-dialog-title",children:e.jsxs("div",{style:{display:"flex",flexDirection:"row"},children:[n.title,e.jsx("div",{style:{flex:1}}),D.isDarkMode&&e.jsx(na,{variant:"outlined",color:"error",title:"Clear Conversation",onClick:f,startIcon:e.jsx(Vt,{}),children:"Clear Chat"}),!D.isDarkMode&&e.jsx(Z,{variant:"outlined",color:"error",title:"Clear Conversation",onClick:f,startIcon:e.jsx(Vt,{}),children:"Clear Chat"})]})}),e.jsx(Ye,{className:"cloud-dialog-wrapper",sx:{display:"flex",justifyContent:"flex-end",flexDirection:"column",p:0},children:e.jsx(Ta,{isDialog:!0,open:n.open,isAgentCanvas:c,chatflowid:n.chatflowid,previews:b,setPreviews:d})})]}):null;return wt.createPortal(C,m)};Ma.propTypes={show:u.bool,dialogProps:u.object,isAgentCanvas:u.bool,onClear:u.func,onCancel:u.func,previews:u.array,setPreviews:u.func};const Ea=({chatflowid:s,isAgentCanvas:n,onOpenChange:c})=>{const f=Oe(),{confirm:h}=cr(),b=qe(),{clearAgentflowNodeStatus:d}=r.useContext(Kt);jt();const m=(...p)=>b(rt(...p)),D=(...p)=>b(it(...p)),[C,O]=r.useState(!1),[P,H]=r.useState(!1),[T,L]=r.useState({}),[_,y]=r.useState([]),j=r.useRef(null),S=r.useRef(C),I=p=>{j.current&&j.current.contains(p.target)||(O(!1),c&&c(!1))},K=()=>{const p=!C;O(p),c&&c(p)},W=()=>{L({open:!0,chatflowid:s}),H(!0)},ee=()=>{const p={...T,open:!1};L(p),d(),setTimeout(()=>{const k={...T,open:!0};L(k)},500)},x=async()=>{if(await h({title:"Clear Chat History",description:"Are you sure you want to clear all chat history?",confirmButtonName:"Clear",cancelButtonName:"Cancel"}))try{const M=gt(s);if(!M.chatId)return;await Gt.deleteChatmessage(s,{chatId:M.chatId,chatType:"INTERNAL"}),so(s),ee(),m({message:"Succesfully cleared all chat history",options:{key:new Date().getTime()+Math.random(),variant:"success",action:R=>e.jsx(Z,{style:{color:"white"},onClick:()=>D(R),children:e.jsx(fe,{})})}})}catch(M){m({message:typeof M.response.data=="object"?M.response.data.message:M.response.data,options:{key:new Date().getTime()+Math.random(),variant:"error",persist:!0,action:R=>e.jsx(Z,{style:{color:"white"},onClick:()=>D(R),children:e.jsx(fe,{})})}})}};return r.useEffect(()=>{S.current===!0&&C===!1&&(j.current.focus(),c&&c(!1)),S.current=C},[C,s]),e.jsxs(e.Fragment,{children:[e.jsx(st,{sx:{position:"absolute",right:20,top:20},ref:j,size:"small",color:"secondary","aria-label":"chat",title:"Chat",onClick:K,children:C?e.jsx(fe,{}):e.jsx(xo,{})}),C&&e.jsx(st,{sx:{position:"absolute",right:80,top:20},onClick:x,size:"small",color:"error","aria-label":"clear",title:"Clear Chat History",children:e.jsx(Vt,{})}),C&&e.jsx(st,{sx:{position:"absolute",right:140,top:20},onClick:W,size:"small",color:"primary","aria-label":"expand",title:"Expand Chat",children:e.jsx(ia,{})}),e.jsx(ea,{placement:"bottom-end",open:C,anchorEl:j.current,role:void 0,transition:!0,disablePortal:!0,popperOptions:{modifiers:[{name:"offset",options:{offset:[40,14]}}]},sx:{zIndex:1e3},children:({TransitionProps:p})=>e.jsx(ta,{in:C,...p,children:e.jsx(Yt,{children:e.jsx(sa,{onClickAway:I,children:e.jsx(aa,{border:!1,className:"cloud-wrapper",elevation:16,content:!1,boxShadow:!0,shadow:f.shadows[16],children:e.jsx(Ta,{isAgentCanvas:n,chatflowid:s,open:C,previews:_,setPreviews:y})})})})})}),e.jsx(Ma,{show:P,dialogProps:T,isAgentCanvas:n,onClear:x,onCancel:()=>H(!1),previews:_,setPreviews:y})]})};Ea.propTypes={chatflowid:u.string,isAgentCanvas:u.bool,onOpenChange:u.func};const Hi=r.memo(Ea);function Zr(s,n=!0){const{navigator:c}=r.useContext(ao);r.useEffect(()=>{if(!n)return;const f=c.block(h=>{const b={...h,retry(){f(),h.retry()}};s(b)});return f},[c,s,n])}function $i(s,n=!0){const c=r.useCallback(f=>{window.confirm(s)&&f.retry()},[s]);Zr(c,n)}export{zi as A,mr as C,Li as I,Hi as a,$i as u};
